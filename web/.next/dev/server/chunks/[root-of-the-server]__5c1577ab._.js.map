{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/adminService.ts"],"sourcesContent":["// Quitamos importaciones est√°ticas que rompen el navegador\r\n// import { getFirestore } from './firebaseAdmin';\r\n// import { fetchAPI } from './api';\r\n// import * as admin from 'firebase-admin';\r\n\r\n/**\r\n * Log an API call for monitoring\r\n */\r\nexport async function logApiCall(service: string, endpoint: string, status: number = 200) {\r\n    if (typeof window !== 'undefined') return; // Do not run on client\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const admin = await import('firebase-admin');\r\n        const db = getFirestore();\r\n        await db.collection('admin_api_logs').add({\r\n            service, // 'Groq', 'Gemini', 'Sofascore'\r\n            endpoint,\r\n            status,\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp()\r\n        });\r\n    } catch (error) {\r\n        console.error('Error logging API call:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Log when a user hits their limit\r\n */\r\nexport async function logLimitAlert(uid: string, email: string) {\r\n    if (typeof window !== 'undefined') return; // Do not run on client\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const admin = await import('firebase-admin');\r\n        const db = getFirestore();\r\n        await db.collection('admin_alerts').add({\r\n            type: 'LIMIT_EXCEEDED',\r\n            uid,\r\n            email,\r\n            message: `Usuario ${email} ha superado su l√≠mite diario de predicciones.`,\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n            read: false\r\n        });\r\n    } catch (error) {\r\n        console.error('Error logging limit alert:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch traffic stats for the last 24 hours (Admin SDK version)\r\n */\r\nexport async function getTrafficStats() {\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const admin = await import('firebase-admin');\r\n        const db = getFirestore();\r\n        const last24h = new Date(Date.now() - 24 * 60 * 60 * 1000);\r\n\r\n        const snap = await db.collection('admin_api_logs')\r\n            .where('timestamp', '>=', admin.firestore.Timestamp.fromDate(last24h))\r\n            .orderBy('timestamp', 'asc')\r\n            .limit(500)\r\n            .get();\r\n\r\n        return snap.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data(),\r\n            date: (doc.data() as any).timestamp?.toDate() || new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching traffic stats:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch latest global activity (Admin SDK version)\r\n */\r\nexport async function getGlobalActivity(limitCount: number = 20) {\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const db = getFirestore();\r\n        const snap = await db.collection('stats_predictions')\r\n            .orderBy('timestamp', 'desc')\r\n            .limit(limitCount)\r\n            .get();\r\n\r\n        return snap.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data(),\r\n            date: (doc.data() as any).timestamp?.toDate() || new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching global activity:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch latest admin alerts (Admin SDK version)\r\n */\r\nexport async function getAdminAlerts(limitCount: number = 10) {\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const db = getFirestore();\r\n        const snap = await db.collection('admin_alerts')\r\n            .orderBy('timestamp', 'desc')\r\n            .limit(limitCount)\r\n            .get();\r\n\r\n        return snap.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data(),\r\n            date: (doc.data() as any).timestamp?.toDate() || new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching admin alerts:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Trigger a full recalculation\r\n */\r\nexport async function recalculateScores() {\r\n    try {\r\n        const { fetchAPI } = await import('./api');\r\n        return await fetchAPI('/api/admin/actions', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'RECALCULATE' })\r\n        });\r\n    } catch (error) {\r\n        throw new Error('Error al recalcular puntuaciones');\r\n    }\r\n}\r\n\r\n/**\r\n * Reset global system cache\r\n */\r\nexport async function resetCache() {\r\n    try {\r\n        const { fetchAPI } = await import('./api');\r\n        return await fetchAPI('/api/admin/actions', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'CLEAR_CACHE' })\r\n        });\r\n    } catch (error) {\r\n        throw new Error('Error al reiniciar cache');\r\n    }\r\n}\r\n\r\n/**\r\n * Broadcast a notification\r\n */\r\nexport async function broadcastNotification(message: string) {\r\n    try {\r\n        const { fetchAPI } = await import('./api');\r\n        return await fetchAPI('/api/admin/actions', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'NOTIFY_ALL', payload: { message } })\r\n        });\r\n    } catch (error) {\r\n        throw new Error('Error al enviar notificaci√≥n masiva');\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 237, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/groqAPIRotator.ts"],"sourcesContent":["/**\r\n * Sistema inteligente de rotaci√≥n de API keys para Groq\r\n * Con balanceo de carga, tracking de rate limit y retry autom√°tico\r\n */\r\n\r\ninterface GroqKeyStats {\r\n    key: string;\r\n    index: number;\r\n    failures: number;\r\n    successes: number;\r\n    totalRequests: number;\r\n    lastUsed: number | null;\r\n    isBlocked: boolean;\r\n    blockUntil: number | null;\r\n    rateLimitReset: number | null;\r\n    remainingRequests: number | null;\r\n}\r\n\r\ninterface GroqRequestResult<T = any> {\r\n    success: boolean;\r\n    data?: T;\r\n    content?: string;\r\n    error?: string;\r\n    keyUsed?: number;\r\n    attempts: number;\r\n    usage?: any;\r\n}\r\n\r\ninterface GroqMessage {\r\n    role: 'system' | 'user' | 'assistant';\r\n    content: string;\r\n}\r\n\r\ninterface GroqCompletionOptions {\r\n    model?: string;\r\n    temperature?: number;\r\n    max_tokens?: number;\r\n    response_format?: { type: 'json_object' | 'text' };\r\n    [key: string]: any;\r\n}\r\n\r\nexport class GroqAPIRotator {\r\n    private apiKeys: GroqKeyStats[];\r\n    private maxRetries: number;\r\n    private maxFailuresBeforeBlock: number;\r\n    private blockDuration: number;\r\n    private rateLimitBlockDuration: number;\r\n\r\n    constructor(apiKeys: string[]) {\r\n        this.apiKeys = apiKeys.map((key, index) => ({\r\n            key,\r\n            index,\r\n            failures: 0,\r\n            successes: 0,\r\n            totalRequests: 0,\r\n            lastUsed: null,\r\n            isBlocked: false,\r\n            blockUntil: null,\r\n            rateLimitReset: null,\r\n            remainingRequests: null\r\n        }));\r\n\r\n        this.maxRetries = 10; // M√°s intentos dado que ahora tenemos 30 keys\r\n        this.maxFailuresBeforeBlock = 2; // M√°s estricto para rotar r√°pido si hay fallos\r\n        this.blockDuration = 1 * 60 * 1000; // Bloqueo m√°s corto (1 min) para reintentar r√°pido\r\n        this.rateLimitBlockDuration = 5 * 60 * 1000; // 5 minutos para rate limit (Groq suele resetear r√°pido)\r\n\r\n        console.log(`[GroqAPIRotator] Initialized with ${apiKeys.length} API key(s)`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene la siguiente key disponible (prioriza las menos usadas)\r\n     */\r\n    private getNextKey(): GroqKeyStats {\r\n        const now = Date.now();\r\n\r\n        // Desbloquear keys si ya pas√≥ el tiempo\r\n        this.apiKeys.forEach(keyObj => {\r\n            if (keyObj.isBlocked && keyObj.blockUntil && now > keyObj.blockUntil) {\r\n                keyObj.isBlocked = false;\r\n                keyObj.failures = 0;\r\n                console.log(`[OK] Groq Key #${keyObj.index + 1} desbloqueada`);\r\n            }\r\n        });\r\n\r\n        // Filtrar keys disponibles\r\n        const availableKeys = this.apiKeys.filter(k => !k.isBlocked);\r\n\r\n        if (availableKeys.length === 0) {\r\n            const nextUnblock = Math.min(...this.apiKeys.map(k => k.blockUntil || Infinity));\r\n            const waitTime = Math.ceil((nextUnblock - now) / 1000);\r\n            throw new Error(`[Error] Todas las Groq API keys est√°n bloqueadas. Pr√≥xima disponible en ${waitTime}s`);\r\n        }\r\n\r\n        // Ordenar por menor uso (balanceo de carga)\r\n        availableKeys.sort((a, b) => a.totalRequests - b.totalRequests);\r\n\r\n        // Seleccionar la menos usada\r\n        const selectedKey = availableKeys[0];\r\n        selectedKey.lastUsed = now;\r\n        selectedKey.totalRequests++;\r\n\r\n        return selectedKey;\r\n    }\r\n\r\n    /**\r\n     * Marca key como exitosa\r\n     */\r\n    private markSuccess(keyObj: GroqKeyStats, responseHeaders: Record<string, string> = {}): void {\r\n        keyObj.successes++;\r\n        keyObj.failures = 0;\r\n\r\n        // Extraer informaci√≥n de rate limit de los headers\r\n        if (responseHeaders['x-ratelimit-remaining']) {\r\n            keyObj.remainingRequests = parseInt(responseHeaders['x-ratelimit-remaining']);\r\n        }\r\n        if (responseHeaders['x-ratelimit-reset']) {\r\n            keyObj.rateLimitReset = parseInt(responseHeaders['x-ratelimit-reset']) * 1000;\r\n        }\r\n\r\n        console.log(`[OK] Groq Key #${keyObj.index + 1} - √âxito | Total: ${keyObj.successes} | Remaining: ${keyObj.remainingRequests || '?'}`);\r\n    }\r\n\r\n    /**\r\n     * Marca key como fallida\r\n     */\r\n    private markFailure(keyObj: GroqKeyStats, error: Error, statusCode: number | null = null): void {\r\n        keyObj.failures++;\r\n\r\n        // Rate limit (429)\r\n        if (statusCode === 429) {\r\n            keyObj.isBlocked = true;\r\n            keyObj.blockUntil = Date.now() + this.rateLimitBlockDuration;\r\n            console.log(`[Blocked] Groq Key #${keyObj.index + 1} - RATE LIMIT - Bloqueada por ${this.rateLimitBlockDuration / 60000} min`);\r\n            return;\r\n        }\r\n\r\n        console.log(`[Warning] Groq Key #${keyObj.index + 1} - Fallo ${keyObj.failures}/${this.maxFailuresBeforeBlock}`);\r\n        console.log(`   Error: ${error.message || error}`);\r\n\r\n        // Bloquear si supera el l√≠mite\r\n        if (keyObj.failures >= this.maxFailuresBeforeBlock) {\r\n            keyObj.isBlocked = true;\r\n            keyObj.blockUntil = Date.now() + this.blockDuration;\r\n            console.log(`[Blocked] Groq Key #${keyObj.index + 1} bloqueada por ${this.blockDuration / 60000} min`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Hace un chat completion con retry inteligente\r\n     */\r\n    async chatCompletion(\r\n        messages: GroqMessage[],\r\n        options: GroqCompletionOptions = {}\r\n    ): Promise<GroqRequestResult> {\r\n        const {\r\n            model = \"llama-3.3-70b-versatile\",\r\n            temperature = 0.7,\r\n            max_tokens = 1024,\r\n            ...otherOptions\r\n        } = options;\r\n\r\n        let lastError: Error | null = null;\r\n        let attempts = 0;\r\n\r\n        while (attempts < this.maxRetries) {\r\n            attempts++;\r\n            let keyObj: GroqKeyStats | null = null;\r\n\r\n            try {\r\n                keyObj = this.getNextKey();\r\n                console.log(`\\n[Retry] Intento ${attempts}/${this.maxRetries} - Usando Groq Key #${keyObj.index + 1}`);\r\n\r\n                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Authorization': `Bearer ${keyObj.key}`,\r\n                        'Content-Type': 'application/json'\r\n                    },\r\n                    body: JSON.stringify({\r\n                        model,\r\n                        messages,\r\n                        temperature,\r\n                        max_tokens,\r\n                        ...otherOptions\r\n                    })\r\n                });\r\n\r\n                // Guardar headers para rate limit info\r\n                const headers: Record<string, string> = {};\r\n                response.headers.forEach((value, key) => {\r\n                    headers[key.toLowerCase()] = value;\r\n                });\r\n\r\n                // Manejar errores HTTP\r\n                if (!response.ok) {\r\n                    const errorData = await response.json().catch(() => ({}));\r\n\r\n                    if (response.status === 429) {\r\n                        this.markFailure(keyObj, new Error('Rate limit exceeded'), 429);\r\n\r\n                        // Si quedan keys, continuar; si no, esperar\r\n                        const availableKeys = this.apiKeys.filter(k => !k.isBlocked).length;\r\n                        if (availableKeys === 0) {\r\n                            throw new Error('Todas las keys en rate limit');\r\n                        }\r\n                        continue;\r\n                    }\r\n\r\n                    throw new Error(`HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);\r\n                }\r\n\r\n                const data = await response.json();\r\n\r\n                // Verificar que la respuesta sea v√°lida\r\n                if (!data.choices || !data.choices[0] || !data.choices[0].message) {\r\n                    throw new Error('Respuesta inv√°lida de Groq API');\r\n                }\r\n\r\n                // Success\r\n                this.markSuccess(keyObj, headers);\r\n                return {\r\n                    success: true,\r\n                    data,\r\n                    content: data.choices[0].message.content,\r\n                    keyUsed: keyObj.index + 1,\r\n                    attempts,\r\n                    usage: data.usage\r\n                };\r\n\r\n            } catch (error) {\r\n                lastError = error as Error;\r\n\r\n                // Marcar fallo solo si tenemos referencia a la key\r\n                if (keyObj) {\r\n                    this.markFailure(keyObj, lastError);\r\n                }\r\n\r\n                // Si no quedan m√°s intentos, terminar\r\n                if (attempts >= this.maxRetries) {\r\n                    console.log(`\\n[Error] Todos los intentos fallaron`);\r\n                    break;\r\n                }\r\n\r\n                // Esperar antes de reintentar (backoff exponencial)\r\n                const waitTime = Math.min(500 * Math.pow(2, attempts - 1), 3000);\r\n                console.log(`[Wait] Esperando ${waitTime}ms antes de reintentar...`);\r\n                await this.sleep(waitTime);\r\n            }\r\n        }\r\n\r\n        // Todos los intentos fallaron\r\n        return {\r\n            success: false,\r\n            error: lastError?.message || 'Error desconocido',\r\n            attempts\r\n        };\r\n    }\r\n\r\n    /**\r\n     * M√©todo conveniente para prompts simples\r\n     */\r\n    async complete(prompt: string, options: GroqCompletionOptions = {}): Promise<GroqRequestResult> {\r\n        return this.chatCompletion([\r\n            { role: \"user\", content: prompt }\r\n        ], options);\r\n    }\r\n\r\n    /**\r\n     * Utilidad para esperar\r\n     */\r\n    private sleep(ms: number): Promise<void> {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    /**\r\n     * Obtiene estad√≠sticas detalladas por key\r\n     */\r\n    getStats() {\r\n        return this.apiKeys.map(k => ({\r\n            key: `Key #${k.index + 1}`,\r\n            successes: k.successes,\r\n            failures: k.failures,\r\n            totalRequests: k.totalRequests,\r\n            remaining: k.remainingRequests || '?',\r\n            status: k.isBlocked ? '[Blocked] Bloqueada' : '[Active] Activa'\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Obtiene resumen general\r\n     */\r\n    getSummary() {\r\n        const active = this.apiKeys.filter(k => !k.isBlocked).length;\r\n        const blocked = this.apiKeys.length - active;\r\n        const totalRequests = this.apiKeys.reduce((sum, k) => sum + k.totalRequests, 0);\r\n        const totalSuccesses = this.apiKeys.reduce((sum, k) => sum + k.successes, 0);\r\n        const totalFailures = this.apiKeys.reduce((sum, k) => sum + k.failures, 0);\r\n\r\n        return {\r\n            totalKeys: this.apiKeys.length,\r\n            activeKeys: active,\r\n            blockedKeys: blocked,\r\n            totalRequests,\r\n            totalSuccesses,\r\n            totalFailures,\r\n            successRate: totalRequests > 0 ? `${((totalSuccesses / totalRequests) * 100).toFixed(1)}%` : '0%'\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Resetea estad√≠sticas\r\n     */\r\n    reset(): void {\r\n        this.apiKeys.forEach(k => {\r\n            k.failures = 0;\r\n            k.successes = 0;\r\n            k.totalRequests = 0;\r\n            k.isBlocked = false;\r\n            k.blockUntil = null;\r\n            k.rateLimitReset = null;\r\n            k.remainingRequests = null;\r\n        });\r\n        console.log('[Reset] Groq: Estad√≠sticas reseteadas');\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 484, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/utils/api-manager.ts"],"sourcesContent":["/**\r\n * API Management Kit\r\n * Sistema hol√≠stico para control, optimizaci√≥n, seguridad y observabilidad de APIs.\r\n */\r\n\r\n// ==========================================\r\n// 1. CONFIGURACI√ìN Y CONSTANTES\r\n// ==========================================\r\n\r\nexport const CACHE_STRATEGIES = {\r\n    // Datos de producto/jugador (cambian muy poco)\r\n    STATIC_DATA: { ttl: 24 * 3600000 }, // 24 horas\r\n\r\n    // An√°lisis de IA (costoso, reutilizable)\r\n    AI_ANALYSIS: { ttl: 12 * 3600000 }, // 12 horas\r\n\r\n    // Datos de Partidos (Sofascore)\r\n    MATCH_DATA: { ttl: 30 * 60000 }, // 30 minutos\r\n\r\n    // Live Score / Trending (muy din√°mico)\r\n    LIVE_DATA: { ttl: 1 * 60000 }, // 1 minuto\r\n\r\n    // Predeterminado\r\n    DEFAULT: { ttl: 60 * 60000 } // 1 hora\r\n};\r\n\r\nexport const API_COSTS = {\r\n    GROQ_REQUEST: 0.0005, // Estimado por request/tokens\r\n    SCRAPER_REQUEST: 0.001 // Costo promedio por llamada exitosa\r\n};\r\n\r\n// ==========================================\r\n// 2. OBSERVABILIDAD & ANALITICA\r\n// ==========================================\r\n\r\nexport interface MetricEntry {\r\n    service: string;\r\n    endpoint?: string;\r\n    success: boolean;\r\n    latency: number;\r\n    timestamp: Date;\r\n    metadata?: any;\r\n}\r\n\r\nexport class Analytics {\r\n    private metrics: MetricEntry[] = [];\r\n\r\n    track(entry: Omit<MetricEntry, 'timestamp'>) {\r\n        this.metrics.push({\r\n            ...entry,\r\n            timestamp: new Date()\r\n        });\r\n\r\n        // Mantener tama√±o manejable en memoria\r\n        if (this.metrics.length > 5000) this.metrics.shift();\r\n    }\r\n\r\n    getDashboard() {\r\n        const total = this.metrics.length;\r\n        const errors = this.metrics.filter(m => !m.success).length;\r\n        const latencies = this.metrics.map(m => m.latency);\r\n        const avgLatency = latencies.length ? latencies.reduce((a, b) => a + b, 0) / latencies.length : 0;\r\n\r\n        return {\r\n            totalRequests: total,\r\n            errorRate: total ? ((errors / total) * 100).toFixed(2) + '%' : '0%',\r\n            avgLatency: Math.round(avgLatency) + 'ms',\r\n            lastUpdate: new Date().toISOString()\r\n        };\r\n    }\r\n}\r\n\r\nexport const globalAnalytics = new Analytics();\r\n\r\n// ==========================================\r\n// 3. CONTROL DE NEGOCIO (PRESUPUESTO)\r\n// ==========================================\r\n\r\nexport class BudgetMonitor {\r\n    private budget: number;\r\n    private spent: number;\r\n\r\n    constructor(monthlyBudget: number = 50.0) { // $50 USD por defecto\r\n        this.budget = monthlyBudget;\r\n        this.spent = 0; // En un sistema real, esto se cargar√≠a de DB/Persistencia\r\n    }\r\n\r\n    trackCost(cost: number) {\r\n        this.spent += cost;\r\n        this.checkThresholds();\r\n    }\r\n\r\n    private checkThresholds() {\r\n        const percentage = (this.spent / this.budget) * 100;\r\n\r\n        if (percentage >= 100) {\r\n            console.error(`üí∞ [CRITICAL] Presupuesto excedido: $${this.spent.toFixed(2)} / $${this.budget}`);\r\n        } else if (percentage > 80) {\r\n            console.warn(`‚ö†Ô∏è [WARNING] 80% del presupuesto consumido: $${this.spent.toFixed(2)}`);\r\n        }\r\n    }\r\n\r\n    getReport() {\r\n        return {\r\n            budget: this.budget,\r\n            spent: this.spent.toFixed(4),\r\n            remaining: (this.budget - this.spent).toFixed(4),\r\n            percentage: ((this.spent / this.budget) * 100).toFixed(1) + '%'\r\n        };\r\n    }\r\n}\r\n\r\nexport const globalBudget = new BudgetMonitor(50); // Presupuesto global\r\n\r\n// ==========================================\r\n// 4. SEGURIDAD (USER RATE LIMITER)\r\n// ==========================================\r\n\r\nexport interface RateLimitResult {\r\n    allowed: boolean;\r\n    remaining?: number;\r\n    resetIn?: number; // Segundos\r\n}\r\n\r\nexport class UserRateLimiter {\r\n    private users: Map<string, number[]> = new Map();\r\n\r\n    canMakeRequest(userId: string, limit: number = 100, windowMs: number = 3600000): RateLimitResult {\r\n        const now = Date.now();\r\n        const userRequests = this.users.get(userId) || [];\r\n\r\n        // Limpiar requests antiguos fuera de ventana\r\n        const recentRequests = userRequests.filter(time => now - time < windowMs);\r\n\r\n        if (recentRequests.length >= limit) {\r\n            const oldestRequest = recentRequests[0] || now;\r\n            const resetIn = Math.ceil((oldestRequest + windowMs - now) / 1000);\r\n\r\n            return {\r\n                allowed: false,\r\n                resetIn\r\n            };\r\n        }\r\n\r\n        recentRequests.push(now);\r\n        this.users.set(userId, recentRequests);\r\n\r\n        return {\r\n            allowed: true,\r\n            remaining: limit - recentRequests.length\r\n        };\r\n    }\r\n}\r\n\r\nexport const globalRateLimiter = new UserRateLimiter();\r\n\r\n// ==========================================\r\n// 5. OPTIMIZACI√ìN (CACHE & QUEUE)\r\n// ==========================================\r\n\r\nimport { Redis } from '@upstash/redis';\r\n\r\nexport class CacheManager {\r\n    private memoryCache: Map<string, { value: any; expiry: number }> = new Map();\r\n    private redis: Redis | null = null;\r\n    private useRedis: boolean = false;\r\n\r\n    constructor() {\r\n        // Intentar inicializar Redis si existen las variables\r\n        if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {\r\n            try {\r\n                this.redis = new Redis({\r\n                    url: process.env.UPSTASH_REDIS_REST_URL,\r\n                    token: process.env.UPSTASH_REDIS_REST_TOKEN,\r\n                });\r\n                this.useRedis = true;\r\n                console.log('üì¶ [CacheManager] Redis enabled via Upstash');\r\n            } catch (error) {\r\n                console.warn('‚ö†Ô∏è [CacheManager] Failed to initialize Redis, falling back to memory');\r\n            }\r\n        } else {\r\n            console.log('‚ÑπÔ∏è [CacheManager] Running in Memory mode (No Redis credentials)');\r\n        }\r\n    }\r\n\r\n    async set(key: string, value: any, ttl: number = CACHE_STRATEGIES.DEFAULT.ttl): Promise<void> {\r\n        if (this.useRedis && this.redis) {\r\n            // Redis TTL es en segundos\r\n            const seconds = Math.ceil(ttl / 1000);\r\n            try {\r\n                await this.redis.set(key, value, { ex: seconds });\r\n                return;\r\n            } catch (err) {\r\n                console.error('‚ùå [CacheManager] Redis set error:', err);\r\n            }\r\n        }\r\n\r\n        // Fallback o modo memoria\r\n        this.memoryCache.set(key, {\r\n            value,\r\n            expiry: Date.now() + ttl\r\n        });\r\n    }\r\n\r\n    async get<T>(key: string): Promise<T | null> {\r\n        if (this.useRedis && this.redis) {\r\n            try {\r\n                const data = await this.redis.get<T>(key);\r\n                if (data) return data;\r\n            } catch (err) {\r\n                console.error('‚ùå [CacheManager] Redis get error:', err);\r\n            }\r\n        }\r\n\r\n        // Fallback o modo memoria\r\n        const item = this.memoryCache.get(key);\r\n        if (!item) return null;\r\n\r\n        if (Date.now() > item.expiry) {\r\n            this.memoryCache.delete(key);\r\n            return null;\r\n        }\r\n\r\n        return item.value as T;\r\n    }\r\n\r\n    /**\r\n     * Obtiene del cach√© o ejecuta la funci√≥n de fetch y guarda el resultado\r\n     */\r\n    async getOrFetch<T>(key: string, fetchFn: () => Promise<T>, ttl?: number): Promise<T> {\r\n        const cached = await this.get<T>(key);\r\n        if (cached) {\r\n            return cached;\r\n        }\r\n\r\n        const data = await fetchFn();\r\n\r\n        // Guardar en fondo para no bloquear respuesta principal\r\n        this.set(key, data, ttl).catch(err => console.error('Cache set background error:', err));\r\n\r\n        return data;\r\n    }\r\n}\r\n\r\nexport class RequestQueue {\r\n    private queue: Array<{ fn: () => Promise<any>; resolve: (v: any) => void; reject: (e: any) => void }> = [];\r\n    private running: number = 0;\r\n    private concurrency: number;\r\n\r\n    constructor(concurrency: number = 3) {\r\n        this.concurrency = concurrency;\r\n    }\r\n\r\n    async add<T>(fn: () => Promise<T>): Promise<T> {\r\n        return new Promise((resolve, reject) => {\r\n            this.queue.push({ fn, resolve, reject });\r\n            this.process();\r\n        });\r\n    }\r\n\r\n    private async process(): Promise<void> {\r\n        if (this.running >= this.concurrency || this.queue.length === 0) return;\r\n\r\n        this.running++;\r\n        const job = this.queue.shift();\r\n        if (!job) { this.running--; return; }\r\n\r\n        const { fn, resolve, reject } = job;\r\n        try {\r\n            const result = await fn();\r\n            resolve(result);\r\n        } catch (error) {\r\n            reject(error);\r\n        } finally {\r\n            this.running--;\r\n            this.process();\r\n        }\r\n    }\r\n}\r\n\r\nexport const globalCache = new CacheManager();\r\n\r\n// ==========================================\r\n// 6. RESILIENCIA (CIRCUIT BREAKER)\r\n// ==========================================\r\n\r\nexport type CircuitState = 'CLOSED' | 'OPEN' | 'HALF_OPEN';\r\n\r\nexport class CircuitBreaker {\r\n    private state: CircuitState = 'CLOSED';\r\n    private failures: number = 0;\r\n    private nextAttempt: number = 0;\r\n\r\n    constructor(\r\n        private threshold: number = 5,\r\n        private timeout: number = 60000\r\n    ) { }\r\n\r\n    async execute<T>(fn: () => Promise<T>): Promise<T> {\r\n        if (this.state === 'OPEN') {\r\n            if (Date.now() < this.nextAttempt) {\r\n                throw new Error('Circuit Breaker OPEN');\r\n            }\r\n            this.state = 'HALF_OPEN';\r\n        }\r\n\r\n        try {\r\n            const result = await fn();\r\n            this.onSuccess();\r\n            return result;\r\n        } catch (error) {\r\n            this.onFailure();\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    private onSuccess() {\r\n        this.failures = 0;\r\n        this.state = 'CLOSED';\r\n    }\r\n\r\n    private onFailure() {\r\n        this.failures++;\r\n        if (this.failures >= this.threshold) {\r\n            this.state = 'OPEN';\r\n            this.nextAttempt = Date.now() + this.timeout;\r\n        }\r\n    }\r\n\r\n    reset() {\r\n        this.failures = 0;\r\n        this.state = 'CLOSED';\r\n        this.nextAttempt = 0;\r\n    }\r\n\r\n    getState() { return this.state; }\r\n}\r\n\r\n// ==========================================\r\n// 7. LOGGER UNIFICADO\r\n// ==========================================\r\n\r\nexport class Logger {\r\n    info(msg: string, data?: any) { console.log(`‚ÑπÔ∏è [INFO] ${msg}`, data || ''); }\r\n    error(msg: string, data?: any) { console.error(`‚ùå [ERROR] ${msg}`, data || ''); }\r\n    warn(msg: string, data?: any) { console.warn(`‚ö†Ô∏è [WARN] ${msg}`, data || ''); }\r\n}\r\n\r\nexport const globalLogger = new Logger();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 802, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/schemas/prediction-schemas.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\n// ==========================================\r\n// COMPONENTES REUTILIZABLES\r\n// ==========================================\r\n\r\nconst PercentageSchema = z.number().min(0).max(100);\r\nconst ScoreSchema = z.string().regex(/^\\d+-\\d+$/, \"Score format must be 'Home-Away' (e.g. 2-1)\");\r\n\r\n// ==========================================\r\n// ESQUEMAS DE DEPORTES\r\n// ==========================================\r\n\r\n// Baloncesto\r\nconst BasketballPredictionsSchema = z.object({\r\n    finalScore: z.string().optional(),\r\n    totalPoints: z.string().or(z.number()).optional(),\r\n    spread: z.object({\r\n        favorite: z.string(),\r\n        line: z.number(),\r\n        recommendation: z.string()\r\n    }).optional(),\r\n    overUnder: z.object({\r\n        line: z.number(),\r\n        pick: z.enum(['M√°s de', 'Menos de', 'Over', 'Under']),\r\n        confidence: z.string().optional()\r\n    }).optional(),\r\n    topPlayers: z.object({\r\n        homeTopScorer: z.object({\r\n            name: z.string(),\r\n            predictedPoints: z.number(),\r\n            predictedRebounds: z.number().optional(),\r\n            predictedAssists: z.number().optional()\r\n        }).optional(),\r\n        awayTopScorer: z.object({\r\n            name: z.string(),\r\n            predictedPoints: z.number(),\r\n            predictedRebounds: z.number().optional(),\r\n            predictedAssists: z.number().optional()\r\n        }).optional()\r\n    }).optional()\r\n});\r\n\r\n// F√∫tbol\r\nconst FootballPredictionsSchema = z.object({\r\n    finalScore: z.string().optional(),\r\n    totalGoals: z.string().or(z.number()).optional(),\r\n    corners: z.object({\r\n        home: z.number(),\r\n        away: z.number(),\r\n        total: z.number()\r\n    }).optional(),\r\n    shots: z.object({\r\n        home: z.number(),\r\n        away: z.number(),\r\n        onTarget: z.string().or(z.number()).optional()\r\n    }).optional(),\r\n    cards: z.object({\r\n        yellowCards: z.number(),\r\n        redCards: z.number(),\r\n        details: z.string().optional()\r\n    }).optional(),\r\n    offsides: z.object({\r\n        total: z.number(),\r\n        details: z.string().optional()\r\n    }).optional()\r\n});\r\n\r\n// ==========================================\r\n// ESQUEMA PRINCIPAL DE RESPUESTA\r\n// ==========================================\r\n\r\nexport const PredictionResponseSchema = z.object({\r\n    winner: z.string(),\r\n    confidence: PercentageSchema,\r\n    reasoning: z.string(),\r\n    bettingTip: z.string(),\r\n    keyFactors: z.array(z.string()),\r\n\r\n    // Objeto de predicciones detalladas (puede ser de basket o f√∫tbol)\r\n    // Usamos .passthrough() para permitir campos extra sin fallar,\r\n    // pero validamos los conocidos.\r\n    predictions: z.union([\r\n        BasketballPredictionsSchema,\r\n        FootballPredictionsSchema\r\n    ]).optional()\r\n});\r\n\r\nexport const NewsAnalysisSchema = z.object({\r\n    bettingSignal: z.string(),\r\n    sentiment: z.enum(['positive', 'negative', 'neutral']),\r\n    impactScore: z.number().min(0).max(100),\r\n    brutalTitle: z.string().optional()\r\n});\r\n\r\nexport const ParleyResponseSchema = z.object({\r\n    title: z.string(),\r\n    confidence: z.number().min(0).max(100),\r\n    totalOdds: z.number().or(z.string()).transform(v => typeof v === 'string' ? parseFloat(v) : v),\r\n    isValueParley: z.boolean().optional(),\r\n    valueAnalysis: z.string().optional(),\r\n    legs: z.array(z.object({\r\n        matchName: z.string(),\r\n        pick: z.string(),\r\n        odds: z.string().or(z.number()).optional(),\r\n        confidence: z.number().min(0).max(100),\r\n        startTime: z.string().optional(),\r\n        reasoning: z.string().optional()\r\n    })),\r\n    analysis: z.string(),\r\n    riskLevel: z.string()\r\n});\r\n\r\nexport type PredictionResponse = z.infer<typeof PredictionResponseSchema>;\r\nexport type NewsAnalysisResponse = z.infer<typeof NewsAnalysisSchema>;\r\nexport type ParleyResponse = z.infer<typeof ParleyResponseSchema>;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 923, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/groqService.ts"],"sourcesContent":["import Groq from \"groq-sdk\";\r\nimport { logApiCall } from '@/lib/adminService';\r\nimport { GroqAPIRotator } from './groqAPIRotator';\r\nimport {\r\n    CacheManager,\r\n    CircuitBreaker,\r\n    Logger,\r\n    BudgetMonitor,\r\n    Analytics,\r\n    globalCache,\r\n    globalLogger,\r\n    globalBudget,\r\n    globalAnalytics,\r\n    CACHE_STRATEGIES,\r\n    API_COSTS\r\n} from '../utils/api-manager';\r\nimport { PredictionResponseSchema } from '../schemas/prediction-schemas';\r\n\r\n/**\r\n * Servicio robusto para Groq API\r\n * Integrado con GroqAPIRotator y API Management Kit para control de costos y resiliencia\r\n */\r\n\r\nclass GroqService {\r\n    private rotator: GroqAPIRotator;\r\n    private keys: string[];\r\n\r\n    // Componentes de gesti√≥n\r\n    private cache: CacheManager;\r\n    private breaker: CircuitBreaker;\r\n    private logger: Logger;\r\n    private budget: BudgetMonitor;\r\n    private analytics: Analytics;\r\n\r\n    constructor() {\r\n        this.keys = this.loadApiKeys();\r\n        this.rotator = new GroqAPIRotator(this.keys);\r\n\r\n        // Inyectar dependencias globales\r\n        this.cache = globalCache;\r\n        this.logger = globalLogger;\r\n        this.budget = globalBudget;\r\n        this.analytics = globalAnalytics;\r\n\r\n        // Circuit Breaker espec√≠fico para IA (m√°s tolerante)\r\n        this.breaker = new CircuitBreaker(5, 30000); // 5 fallos, 30s de descanso\r\n\r\n        this.logger.info(`\\u{1F9D9} [GeniusEngine] Ready with ${this.keys.length} spells`);\r\n    }\r\n\r\n    private loadApiKeys(): string[] {\r\n        const keys: string[] = [];\r\n        if (process.env.GROQ_API_KEYS) {\r\n            keys.push(...process.env.GROQ_API_KEYS.split(',').map(k => k.trim()).filter(k => k));\r\n        }\r\n        if (process.env.GROQ_API_KEY && !keys.includes(process.env.GROQ_API_KEY)) {\r\n            keys.push(process.env.GROQ_API_KEY);\r\n        }\r\n        if (keys.length === 0) {\r\n            console.warn('‚ö†Ô∏è No Groq API keys configured. Service will not work at runtime.');\r\n            return ['dummy-key-for-build'];\r\n        }\r\n        return keys;\r\n    }\r\n\r\n    /**\r\n     * Crea una predicci√≥n gestionada con cach√© y control de costos\r\n     */\r\n    async createPrediction(params: {\r\n        messages: Array<{ role: string; content: string }>;\r\n        model?: string;\r\n        temperature?: number;\r\n        max_tokens?: number;\r\n        response_format?: { type: 'json_object' | 'text' };\r\n        useCache?: boolean; // Opci√≥n para bypass cach√©\r\n        schema?: any; // Zod Schema opcional\r\n    }): Promise<any> {\r\n        const { useCache = true, schema = PredictionResponseSchema, ...aiParams } = params;\r\n\r\n        // Clave de cach√© basada en el contenido de los mensajes (para no repetir an√°lisis id√©nticos)\r\n        const cacheKey = `groq: prediction:${JSON.stringify(aiParams.messages)} `;\r\n        const start = Date.now();\r\n\r\n        const fetchFn = async () => {\r\n            return this.breaker.execute(async () => {\r\n                try {\r\n                    const result = await this.rotator.chatCompletion(\r\n                        aiParams.messages as any,\r\n                        {\r\n                            model: aiParams.model || 'llama-3.1-8b-instant',\r\n                            temperature: aiParams.temperature ?? 0.6,\r\n                            max_tokens: aiParams.max_tokens || 800,\r\n                            response_format: aiParams.response_format || { type: 'json_object' as const }\r\n                        }\r\n                    );\r\n\r\n                    if (result.success && result.content) {\r\n                        try {\r\n                            const rawJson = JSON.parse(result.content);\r\n\r\n                            // VALIDACI√ìN ZOD (Nivel Profesional)\r\n                            // Si los datos no cumplen la estructura, lanzar√° error detallado\r\n                            const validatedData = schema.parse(rawJson);\r\n\r\n                            // Log exitoso y m√©tricas solo si es v√°lido\r\n                            this.budget.trackCost(API_COSTS.GROQ_REQUEST);\r\n                            this.analytics.track({\r\n                                service: 'GroqAPI',\r\n                                endpoint: 'chat/completions',\r\n                                success: true,\r\n                                latency: Date.now() - start,\r\n                                metadata: { model: aiParams.model, tokens: result.usage?.total_tokens }\r\n                            });\r\n\r\n                            return validatedData;\r\n\r\n                        } catch (e: any) {\r\n                            console.error('[GeniusEngine] Insight/Parse Error:', e.errors || e.message);\r\n                            throw new Error('AI response validation failed: ' + (e.message || 'Invalid format'));\r\n                        }\r\n                    } else {\r\n                        throw new Error(result.error || 'All Groq API keys failed');\r\n                    }\r\n                } catch (err: any) {\r\n                    this.analytics.track({\r\n                        service: 'GroqAPI',\r\n                        endpoint: 'chat/completions',\r\n                        success: false,\r\n                        latency: Date.now() - start,\r\n                        metadata: { error: err.message }\r\n                    });\r\n                    throw err;\r\n                }\r\n            });\r\n        };\r\n\r\n        try {\r\n            if (useCache) {\r\n                // Cachear an√°lisis por 12 horas por defecto (Estrategia AI_ANALYSIS)\r\n                return await this.cache.getOrFetch(cacheKey, fetchFn, CACHE_STRATEGIES.AI_ANALYSIS.ttl);\r\n            } else {\r\n                return await fetchFn();\r\n            }\r\n        } catch (error: any) {\r\n            this.logger.error(`[GeniusEngine] Prediction failed`, { error: error.message });\r\n            console.error(\"[GeniusEngine] Error:\", error.message);\r\n            logApiCall('Groq', '/chat/completions', 500).catch(() => { });\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Crea un prompt simple gestionado\r\n     */\r\n    async complete(prompt: string, options: {\r\n        model?: string;\r\n        temperature?: number;\r\n        max_tokens?: number;\r\n        useCache?: boolean;\r\n    } = {}): Promise<string> {\r\n        const { useCache = true, ...aiOptions } = options;\r\n        const cacheKey = `groq: complete:${prompt} `;\r\n\r\n        const fetchFn = async () => {\r\n            const result = await this.rotator.complete(prompt, aiOptions);\r\n            if (result.success && result.content) {\r\n                this.budget.trackCost(API_COSTS.GROQ_REQUEST);\r\n                logApiCall('Groq', '/chat/completions', 200).catch(() => { });\r\n                return result.content;\r\n            }\r\n            throw new Error(result.error || 'Groq completion failed');\r\n        };\r\n\r\n        try {\r\n            if (useCache) {\r\n                return await this.cache.getOrFetch(cacheKey, fetchFn, CACHE_STRATEGIES.AI_ANALYSIS.ttl);\r\n            }\r\n            return await fetchFn();\r\n        } catch (error: any) {\r\n            this.logger.error(`[GeniusEngine] Completion failed`, { error: error.message });\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    getStats() {\r\n        return {\r\n            rotator: this.rotator.getSummary(),\r\n            keys: this.rotator.getStats(),\r\n            budget: this.budget.getReport(),\r\n            circuit: this.breaker.getState()\r\n        };\r\n    }\r\n\r\n    reset(): void {\r\n        this.rotator.reset();\r\n        this.breaker.reset();\r\n    }\r\n}\r\n\r\nexport const groqService = new GroqService();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1093, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/app/api/news/live/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport Parser from 'rss-parser';\r\nimport { groqService } from '@/lib/services/groqService';\r\nimport { NewsAnalysisSchema } from '@/lib/schemas/prediction-schemas';\r\n\r\nconst parser = new Parser();\r\n\r\n// Simple in-memory cache\r\nlet newsCache: any = null;\r\nlet lastFetchTime = 0;\r\nconst CACHE_DURATION = 10 * 60 * 1000; // 10 minutes\r\n\r\nexport async function GET() {\r\n    try {\r\n        const now = Date.now();\r\n\r\n        // Return cache if valid\r\n        if (newsCache && (now - lastFetchTime < CACHE_DURATION)) {\r\n            console.log('üì∞ Serving news from cache');\r\n            return NextResponse.json({ success: true, data: newsCache });\r\n        }\r\n\r\n        console.log('üîÑ Fetching fresh news from RSS...');\r\n\r\n        // 1. Fetch RSS Feed (ESPN or similar)\r\n        const feed = await parser.parseURL('https://www.espn.com/espn/rss/news');\r\n\r\n        // Take top 3 news items\r\n        const topItems = feed.items.slice(0, 3);\r\n\r\n        // 2. Process with Groq AI\r\n        const processedNews = await Promise.all(topItems.map(async (item: any, index: number) => {\r\n            try {\r\n                // Determine mock image based on content (since RSS usually lacks good images)\r\n                // In a real app, we would scrape the OG:Image, but for stability we use keyword matching\r\n                let imageUrl = \"https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?q=80&w=1000&auto=format&fit=crop\"; // Generic Sport\r\n                const LowerTitle = item.title?.toLowerCase() || \"\";\r\n\r\n                if (LowerTitle.includes('nba') || LowerTitle.includes('lakers') || LowerTitle.includes('lebron') || LowerTitle.includes('basketball')) {\r\n                    imageUrl = \"https://images.unsplash.com/photo-1546519638-68e109498ee2?q=80&w=1000&auto=format&fit=crop\";\r\n                } else if (LowerTitle.includes('soccer') || LowerTitle.includes('football') || LowerTitle.includes('madrid') || LowerTitle.includes('messi') || LowerTitle.includes('laliga') || LowerTitle.includes('premier')) {\r\n                    imageUrl = \"https://images.unsplash.com/photo-1510660603728-40a256df2e7b?q=80&w=1000&auto=format&fit=crop\";\r\n                } else if (LowerTitle.includes('nfl') || LowerTitle.includes('super bowl') || LowerTitle.includes('quarterback')) {\r\n                    imageUrl = \"https://images.unsplash.com/photo-1566577739112-5180d4bf9390?q=80&w=1000&auto=format&fit=crop\";\r\n                } else if (LowerTitle.includes('mlb') || LowerTitle.includes('baseball') || LowerTitle.includes('yankees')) {\r\n                    imageUrl = \"https://images.unsplash.com/photo-1508344928928-71657adc0c80?q=80&w=1000&auto=format&fit=crop\";\r\n                } else if (LowerTitle.includes('nhl') || LowerTitle.includes('hockey') || LowerTitle.includes('puck')) {\r\n                    imageUrl = \"https://images.unsplash.com/photo-1515285769212-700938229f21?q=80&w=1000&auto=format&fit=crop\";\r\n                } else if (LowerTitle.includes('tennis') || LowerTitle.includes('grand slam') || LowerTitle.includes('atp')) {\r\n                    imageUrl = \"https://images.unsplash.com/photo-1595435064222-45103bbc86b5?q=80&w=1000&auto=format&fit=crop\";\r\n                }\r\n\r\n                // AI Analysis usando groqService\r\n                const aiResult = await groqService.createPrediction({\r\n                    messages: [\r\n                        {\r\n                            role: \"system\",\r\n                            content: `You are a sports betting analyst AI. \r\n                            Analyze the news headline and summary. \r\n                            Output a JSON object with: \r\n                            - bettingSignal: A short, punchy sentence explaining how this affects betting (e.g. \"Lakers odds improve\", \"Avoid Moneyline\").\r\n                            - sentiment: \"positive\", \"negative\", or \"neutral\".\r\n                            - impactScore: number 0-100.\r\n                            - brutalTitle: Rewrite the title in a short, \"brutal/cyberpunk\" style (max 6 words).`\r\n                        },\r\n                        {\r\n                            role: \"user\",\r\n                            content: `Title: ${item.title}\\nSummary: ${item.contentSnippet || item.content}`\r\n                        }\r\n                    ],\r\n                    model: \"llama-3.3-70b-versatile\",\r\n                    response_format: { type: \"json_object\" },\r\n                    schema: NewsAnalysisSchema\r\n                });\r\n\r\n                return {\r\n                    id: `rss-${index}-${Date.now()}`,\r\n                    title: aiResult.brutalTitle || item.title,\r\n                    summary: item.contentSnippet?.substring(0, 100) + \"...\",\r\n                    source: \"ESPN / AI Stats\",\r\n                    url: item.link,\r\n                    imageUrl: imageUrl,\r\n                    publishedAt: item.pubDate || new Date().toISOString(),\r\n                    aiAnalysis: {\r\n                        sentiment: aiResult.sentiment || 'neutral',\r\n                        bettingSignal: aiResult.bettingSignal || \"Analizando impacto en cuotas...\",\r\n                        impactScore: aiResult.impactScore || 50\r\n                    }\r\n                };\r\n\r\n            } catch (err) {\r\n                console.error(\"Error processing item with AI:\", err);\r\n\r\n                // FALLBACK: Return item without AI improvement if API Key fails (401) or other error\r\n                return {\r\n                    id: `err-${index}`,\r\n                    title: item.title,\r\n                    summary: item.contentSnippet || item.content || \"Noticias de √∫ltima hora\",\r\n                    source: \"ESPN\",\r\n                    url: item.link,\r\n                    imageUrl: \"https://images.unsplash.com/photo-1461896836934-ffe607ba8211?q=80&w=1000&auto=format&fit=crop\",\r\n                    publishedAt: item.pubDate || new Date().toISOString(),\r\n                    aiAnalysis: {\r\n                        sentiment: 'neutral',\r\n                        bettingSignal: \"An√°lisis en proceso...\",\r\n                        impactScore: 50\r\n                    }\r\n                };\r\n            }\r\n        }));\r\n\r\n        // Update Cache\r\n        newsCache = processedNews;\r\n        lastFetchTime = now;\r\n\r\n        return NextResponse.json({ success: true, data: processedNews });\r\n\r\n    } catch (error: any) {\r\n        console.error('‚ùå News API Error:', error);\r\n        return NextResponse.json({ success: false, error: error.message }, { status: 500 });\r\n    }\r\n}"],"names":[],"mappings":"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"}}]
}