{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/proxy.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport type { NextRequest } from 'next/server';\r\n\r\n// Rate Limit Configurations\r\nconst RATELIMIT_CONFIGS: Record<string, { windowMs: number; max: number; name: string }> = {\r\n    general: { windowMs: 15 * 60 * 1000, max: 500, name: 'General API' }, // Increased limit for dev\r\n    prediction: { windowMs: 60 * 60 * 1000, max: 50, name: 'AI Predictions' },\r\n    search: { windowMs: 15 * 60 * 1000, max: 300, name: 'Search' },\r\n    auth: { windowMs: 15 * 60 * 1000, max: 20, name: 'Authentication' },\r\n};\r\n\r\n// In-memory store for rate limiting\r\nconst ipCache = new Map<string, { count: number; resetTime: number }>();\r\n\r\nexport function proxy(request: NextRequest) {\r\n    const path = request.nextUrl.pathname;\r\n    const ip = request.headers.get('x-forwarded-for') || 'unknown';\r\n\r\n    // Only apply to API routes\r\n    if (path.startsWith('/api/')) {\r\n        // WHITELIST LOCALHOST: Bypass limits for local development\r\n        // 'unknown' is often localhost in direct dev mode without proxy headers\r\n        if (ip.includes('127.0.0.1') || ip.includes('::1') || ip === 'unknown') {\r\n            return NextResponse.next();\r\n        }\r\n\r\n        // Determine which limiter to use based on path\r\n        let limitKey = 'general';\r\n        if (path.includes('/predict')) limitKey = 'prediction';\r\n        else if (path.includes('/search')) limitKey = 'search';\r\n        else if (path.includes('/auth') || path.includes('/login') || path.includes('/register')) limitKey = 'auth';\r\n\r\n        const config = RATELIMIT_CONFIGS[limitKey];\r\n        const storageKey = `${limitKey}:${ip}`; // Unique key per limiter + IP\r\n        const now = Date.now();\r\n\r\n        let record = ipCache.get(storageKey);\r\n\r\n        // Initialize or Reset if window passed\r\n        if (!record || now > record.resetTime) {\r\n            record = { count: 0, resetTime: now + config.windowMs };\r\n        }\r\n\r\n        record.count++;\r\n        ipCache.set(storageKey, record);\r\n\r\n        // Create Response\r\n        const response = NextResponse.next();\r\n\r\n        // Rate Limit Headers\r\n        response.headers.set('X-RateLimit-Limit', config.max.toString());\r\n        response.headers.set('X-RateLimit-Remaining', Math.max(0, config.max - record.count).toString());\r\n        response.headers.set('X-RateLimit-Reset', Math.ceil(record.resetTime / 1000).toString());\r\n\r\n        // Security Headers (Best practice)\r\n        response.headers.set('X-Content-Type-Options', 'nosniff');\r\n        response.headers.set('X-Frame-Options', 'DENY');\r\n        response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin');\r\n\r\n        // Check Limit\r\n        if (record.count > config.max) {\r\n            console.warn(`ðŸš¨ Rate Limit Exceeded [${config.name}] for IP: ${ip}`);\r\n\r\n            return new NextResponse(\r\n                JSON.stringify({\r\n                    success: false,\r\n                    error: `Se ha excedido el lÃ­mite de solicitudes para ${config.name}.`,\r\n                    retryAfter: Math.ceil((record.resetTime - now) / 1000),\r\n                    message: limitKey === 'prediction' ? 'Actualiza a Premium para predicciones ilimitadas.' : 'Intenta mÃ¡s tarde.'\r\n                }),\r\n                { status: 429, headers: { 'Content-Type': 'application/json' } }\r\n            );\r\n        }\r\n\r\n        return response;\r\n    }\r\n\r\n    return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n    matcher: '/api/:path*',\r\n};\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAGA,4BAA4B;AAC5B,MAAM,oBAAqF;IACvF,SAAS;QAAE,UAAU,KAAK,KAAK;QAAM,KAAK;QAAK,MAAM;IAAc;IACnE,YAAY;QAAE,UAAU,KAAK,KAAK;QAAM,KAAK;QAAI,MAAM;IAAiB;IACxE,QAAQ;QAAE,UAAU,KAAK,KAAK;QAAM,KAAK;QAAK,MAAM;IAAS;IAC7D,MAAM;QAAE,UAAU,KAAK,KAAK;QAAM,KAAK;QAAI,MAAM;IAAiB;AACtE;AAEA,oCAAoC;AACpC,MAAM,UAAU,IAAI;AAEb,SAAS,MAAM,OAAoB;IACtC,MAAM,OAAO,QAAQ,OAAO,CAAC,QAAQ;IACrC,MAAM,KAAK,QAAQ,OAAO,CAAC,GAAG,CAAC,sBAAsB;IAErD,2BAA2B;IAC3B,IAAI,KAAK,UAAU,CAAC,UAAU;QAC1B,2DAA2D;QAC3D,wEAAwE;QACxE,IAAI,GAAG,QAAQ,CAAC,gBAAgB,GAAG,QAAQ,CAAC,UAAU,OAAO,WAAW;YACpE,OAAO,qJAAY,CAAC,IAAI;QAC5B;QAEA,+CAA+C;QAC/C,IAAI,WAAW;QACf,IAAI,KAAK,QAAQ,CAAC,aAAa,WAAW;aACrC,IAAI,KAAK,QAAQ,CAAC,YAAY,WAAW;aACzC,IAAI,KAAK,QAAQ,CAAC,YAAY,KAAK,QAAQ,CAAC,aAAa,KAAK,QAAQ,CAAC,cAAc,WAAW;QAErG,MAAM,SAAS,iBAAiB,CAAC,SAAS;QAC1C,MAAM,aAAa,GAAG,SAAS,CAAC,EAAE,IAAI,EAAE,8BAA8B;QACtE,MAAM,MAAM,KAAK,GAAG;QAEpB,IAAI,SAAS,QAAQ,GAAG,CAAC;QAEzB,uCAAuC;QACvC,IAAI,CAAC,UAAU,MAAM,OAAO,SAAS,EAAE;YACnC,SAAS;gBAAE,OAAO;gBAAG,WAAW,MAAM,OAAO,QAAQ;YAAC;QAC1D;QAEA,OAAO,KAAK;QACZ,QAAQ,GAAG,CAAC,YAAY;QAExB,kBAAkB;QAClB,MAAM,WAAW,qJAAY,CAAC,IAAI;QAElC,qBAAqB;QACrB,SAAS,OAAO,CAAC,GAAG,CAAC,qBAAqB,OAAO,GAAG,CAAC,QAAQ;QAC7D,SAAS,OAAO,CAAC,GAAG,CAAC,yBAAyB,KAAK,GAAG,CAAC,GAAG,OAAO,GAAG,GAAG,OAAO,KAAK,EAAE,QAAQ;QAC7F,SAAS,OAAO,CAAC,GAAG,CAAC,qBAAqB,KAAK,IAAI,CAAC,OAAO,SAAS,GAAG,MAAM,QAAQ;QAErF,mCAAmC;QACnC,SAAS,OAAO,CAAC,GAAG,CAAC,0BAA0B;QAC/C,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;QACxC,SAAS,OAAO,CAAC,GAAG,CAAC,mBAAmB;QAExC,cAAc;QACd,IAAI,OAAO,KAAK,GAAG,OAAO,GAAG,EAAE;YAC3B,QAAQ,IAAI,CAAC,CAAC,wBAAwB,EAAE,OAAO,IAAI,CAAC,UAAU,EAAE,IAAI;YAEpE,OAAO,IAAI,qJAAY,CACnB,KAAK,SAAS,CAAC;gBACX,SAAS;gBACT,OAAO,CAAC,6CAA6C,EAAE,OAAO,IAAI,CAAC,CAAC,CAAC;gBACrE,YAAY,KAAK,IAAI,CAAC,CAAC,OAAO,SAAS,GAAG,GAAG,IAAI;gBACjD,SAAS,aAAa,eAAe,sDAAsD;YAC/F,IACA;gBAAE,QAAQ;gBAAK,SAAS;oBAAE,gBAAgB;gBAAmB;YAAE;QAEvE;QAEA,OAAO;IACX;IAEA,OAAO,qJAAY,CAAC,IAAI;AAC5B;AAEO,MAAM,SAAS;IAClB,SAAS;AACb"}}]
}