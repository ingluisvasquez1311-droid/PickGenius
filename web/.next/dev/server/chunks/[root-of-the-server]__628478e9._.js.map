{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/api.ts"],"sourcesContent":["// Configuraci√≥n centralizada de la API\r\nconst isServer = typeof window === 'undefined';\r\nconst DEFAULT_BASE_URL = isServer ? (process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : 'http://localhost:3000') : '';\r\nexport const API_URL = process.env.NEXT_PUBLIC_API_BASE_URL || DEFAULT_BASE_URL;\r\n\r\nexport async function fetchAPI(endpoint: string, options?: RequestInit, retries = 3, backoff = 1000) {\r\n    // Ensure endpoint starts with / if it's not an absolute URL\r\n    const isAbsolute = endpoint.startsWith('http');\r\n    let url = endpoint;\r\n\r\n    if (!isAbsolute) {\r\n        // En el servidor, necesitamos URLs absolutas. En el cliente, las relativas funcionan (pero las absolutas tambi√©n).\r\n        const baseUrl = API_URL.replace(/\\/$/, '');\r\n        const cleanEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;\r\n        url = `${baseUrl}${cleanEndpoint}`;\r\n    }\r\n\r\n    console.log(`üîç [API] Fetching: ${url} (Retries left: ${retries})`);\r\n\r\n    try {\r\n        const response = await fetch(url, {\r\n            ...options,\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'ngrok-skip-browser-warning': 'true',\r\n                'bypass-tunnel-reminder': 'true',\r\n                ...options?.headers,\r\n            },\r\n        });\r\n\r\n        // Handle Rate Limiting (429) or Service Unavailable (503)\r\n        if ((response.status === 429 || response.status === 503) && retries > 0) {\r\n            const waitTime = backoff * (4 - retries); // Exponential backoff: 1s, 2s, 3s\r\n            console.warn(`‚ö†Ô∏è [API] HTTP ${response.status} detected. Retrying in ${waitTime}ms...`);\r\n            await new Promise(resolve => setTimeout(resolve, waitTime));\r\n            return fetchAPI(endpoint, options, retries - 1, backoff);\r\n        }\r\n\r\n        if (!response.ok) {\r\n            throw new Error(`HTTP ${response.status}: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return data;\r\n    } catch (error) {\r\n        if (retries > 0) {\r\n            console.warn(`‚ö†Ô∏è [API] Fetch error, retrying (${retries} left):`, error);\r\n            await new Promise(resolve => setTimeout(resolve, backoff));\r\n            return fetchAPI(endpoint, options, retries - 1, backoff);\r\n        }\r\n        console.error('‚ùå [API] Final error fetching:', url, error);\r\n        throw error;\r\n    }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA,uCAAuC;AACvC,MAAM,WAAW,kDAAkB;AACnC,MAAM,mBAAmB,uCAAY,QAAQ,GAAG,CAAC,UAAU,GAAG,CAAC,QAAQ,EAAE,QAAQ,GAAG,CAAC,UAAU,EAAE,GAAG,0BAA2B;AACxH,MAAM,UAAU,QAAQ,GAAG,CAAC,wBAAwB,IAAI;AAExD,eAAe,SAAS,QAAgB,EAAE,OAAqB,EAAE,UAAU,CAAC,EAAE,UAAU,IAAI;IAC/F,4DAA4D;IAC5D,MAAM,aAAa,SAAS,UAAU,CAAC;IACvC,IAAI,MAAM;IAEV,IAAI,CAAC,YAAY;QACb,mHAAmH;QACnH,MAAM,UAAU,QAAQ,OAAO,CAAC,OAAO;QACvC,MAAM,gBAAgB,SAAS,UAAU,CAAC,OAAO,WAAW,CAAC,CAAC,EAAE,UAAU;QAC1E,MAAM,GAAG,UAAU,eAAe;IACtC;IAEA,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,IAAI,gBAAgB,EAAE,QAAQ,CAAC,CAAC;IAElE,IAAI;QACA,MAAM,WAAW,MAAM,MAAM,KAAK;YAC9B,GAAG,OAAO;YACV,SAAS;gBACL,gBAAgB;gBAChB,8BAA8B;gBAC9B,0BAA0B;gBAC1B,GAAG,SAAS,OAAO;YACvB;QACJ;QAEA,0DAA0D;QAC1D,IAAI,CAAC,SAAS,MAAM,KAAK,OAAO,SAAS,MAAM,KAAK,GAAG,KAAK,UAAU,GAAG;YACrE,MAAM,WAAW,UAAU,CAAC,IAAI,OAAO,GAAG,kCAAkC;YAC5E,QAAQ,IAAI,CAAC,CAAC,cAAc,EAAE,SAAS,MAAM,CAAC,uBAAuB,EAAE,SAAS,KAAK,CAAC;YACtF,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;YACjD,OAAO,SAAS,UAAU,SAAS,UAAU,GAAG;QACpD;QAEA,IAAI,CAAC,SAAS,EAAE,EAAE;YACd,MAAM,IAAI,MAAM,CAAC,KAAK,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,SAAS,UAAU,EAAE;QACrE;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAChC,OAAO;IACX,EAAE,OAAO,OAAO;QACZ,IAAI,UAAU,GAAG;YACb,QAAQ,IAAI,CAAC,CAAC,gCAAgC,EAAE,QAAQ,OAAO,CAAC,EAAE;YAClE,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;YACjD,OAAO,SAAS,UAAU,SAAS,UAAU,GAAG;QACpD;QACA,QAAQ,KAAK,CAAC,iCAAiC,KAAK;QACpD,MAAM;IACV;AACJ"}},
    {"offset": {"line": 97, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/sportsDataService.ts"],"sourcesContent":["// Determinar la URL base dependiendo del entorno (Servidor vs Cliente)\r\n// Si estamos en el servidor, usamos la API directa.\r\n// Si estamos en el cliente, usamos nuestro Proxy para evitar CORS.\r\n// La URL del Bridge (Tu IP casera) es obligatoria para NO ser bloqueados\r\nconst BRIDGE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';\r\n\r\nconst BASE_URL = typeof window === 'undefined'\r\n    ? `${BRIDGE_URL}/api/proxy/sportsdata` // En el servidor, USAMOS EL PUENTE (Tu IP) siempre\r\n    : '/api/proxy/sportsdata'; // En el cliente, usamos el proxy local del navegador\r\n\r\nimport { logApiCall } from '@/lib/adminService';\r\nimport axios from 'axios';\r\nimport { fetchAPI } from '../api';\r\n\r\nexport interface SportsDataTeam {\r\n    id: number;\r\n    name: string;\r\n    shortName: string;\r\n    slug: string;\r\n    nameCode: string;\r\n    teamColors: {\r\n        primary: string;\r\n        secondary: string;\r\n        text: string;\r\n    };\r\n}\r\n\r\nexport interface SportsDataEvent {\r\n    id: number;\r\n    slug: string;\r\n    tournament: {\r\n        id: number;\r\n        name: string;\r\n        slug: string;\r\n        uniqueTournament?: {\r\n            id: number;\r\n            name: string;\r\n            primaryColorHex?: string;\r\n            secondaryColorHex?: string;\r\n        };\r\n        category: {\r\n            id: number;\r\n            name: string;\r\n            slug: string;\r\n            sport: {\r\n                id: number;\r\n                name: string;\r\n                slug: string;\r\n            };\r\n        };\r\n    };\r\n    season?: {\r\n        id: number;\r\n        name: string;\r\n        year: string;\r\n    };\r\n    homeTeam: SportsDataTeam;\r\n    awayTeam: SportsDataTeam;\r\n    homeScore: {\r\n        current: number;\r\n        display: number;\r\n        period1?: number;\r\n        period2?: number;\r\n        period3?: number;\r\n        period4?: number;\r\n        normaltime?: number;\r\n    };\r\n    awayScore: {\r\n        current: number;\r\n        display: number;\r\n        period1?: number;\r\n        period2?: number;\r\n        period3?: number;\r\n        period4?: number;\r\n        normaltime?: number;\r\n    };\r\n    status: {\r\n        code: number;\r\n        description: string;\r\n        type: 'notstarted' | 'inprogress' | 'finished' | 'scheduled' | 'canceled' | 'postponed';\r\n    };\r\n    lastPeriod?: string;\r\n    time?: {\r\n        currentPeriodStartTimestamp?: number;\r\n        initial?: number;\r\n        max?: number;\r\n        played?: number;\r\n        periodLength?: number;\r\n        overtimeLength?: number;\r\n    };\r\n    startTimestamp: number;\r\n    customId?: string;\r\n    roundInfo?: {\r\n        round: number;\r\n        name?: string;\r\n    };\r\n}\r\n\r\nexport interface SportsDataResponse {\r\n    events: SportsDataEvent[];\r\n}\r\n\r\n/**\r\n * Servicio para obtener datos deportivos\r\n */\r\nclass SportsDataService {\r\n    private headers = {\r\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',\r\n    };\r\n\r\n    /**\r\n     * Generic method to make requests\r\n     * Using fetchAPI for centralized URL and error handling\r\n     */\r\n    async makeRequest<T = any>(endpoint: string): Promise<T | null> {\r\n        try {\r\n            const cleanEndpoint = endpoint.startsWith(\"/\") ? endpoint : `/${endpoint}`;\r\n            const proxyEndpoint = `/api/proxy/sportsdata${cleanEndpoint}`;\r\n\r\n            return await fetchAPI(proxyEndpoint, {\r\n                headers: this.headers\r\n            });\r\n        } catch (error: any) {\r\n            // Silence 404s as they are often expected (e.g., no momentum or no lineups for small leagues)\r\n            const errorMsg = error.message || '';\r\n            const is404 = errorMsg.includes('404') || error.status === 404 || error.response?.status === 404;\r\n\r\n            if (!is404) {\r\n                console.error(`‚ùå [SportsDataService] Request failed for ${endpoint}:`, errorMsg);\r\n            } else {\r\n                // console.warn(`[SportsDataService] Data not found (404) for ${endpoint} - This is often expected.`);\r\n            }\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene partidos de f√∫tbol en vivo\r\n     */\r\n    /**\r\n     * Obtiene partidos de f√∫tbol en vivo\r\n     */\r\n    async getLiveFootballMatches(): Promise<SportsDataEvent[]> {\r\n        try {\r\n            // 1. Prioridad: Sofascore DIRECTO (v√≠a Bridge) para inmediatez absoluta\r\n            const data = await this.makeRequest<SportsDataResponse>('/sport/football/events/live');\r\n            if (data?.events && data.events.length > 0) return data.events;\r\n        } catch (e) {\r\n            console.warn(\"‚ö†Ô∏è Fallback to Firebase for Live Football\");\r\n        }\r\n\r\n        // 2. Fallback: Firebase (V√≠a nuestra API interna)\r\n        const res = await fetchAPI('/api/football/live', { headers: this.headers });\r\n        return res?.events || [];\r\n    }\r\n\r\n    /**\r\n     * Obtiene partidos de f√∫tbol programados para una fecha\r\n     */\r\n    async getScheduledFootballMatches(date: string): Promise<SportsDataEvent[]> {\r\n        return this.getScheduledEventsBySport('football', date);\r\n    }\r\n\r\n    /**\r\n     * Obtiene eventos programados de forma filtrada (Backend Local)\r\n     */\r\n    async getScheduledEventsBySport(sport: string, date?: string): Promise<SportsDataEvent[]> {\r\n        const today = date || new Date().toISOString().split('T')[0];\r\n\r\n        try {\r\n            // 1. Prioridad: Sofascore DIRECTO (v√≠a Bridge) - Lo que Daniel ve en su PC\r\n            const ssData = await this.makeRequest<SportsDataResponse>(`/sport/${sport}/scheduled-events/${today}`);\r\n            if (ssData?.events && ssData.events.length > 0) {\r\n                return ssData.events;\r\n            }\r\n        } catch (e) {\r\n            console.warn(`‚ö†Ô∏è SofaScore Direct failed for ${sport}, checking Firebase...`);\r\n        }\r\n\r\n        try {\r\n            // 2. Fallback: Nuestra API de Firebase\r\n            const queryParams = date ? `?date=${date}` : '';\r\n            const endpoint = `/api/${sport}/scheduled${queryParams}`;\r\n\r\n            const result = await fetchAPI(endpoint, {\r\n                headers: this.headers\r\n            });\r\n\r\n            return result.events || result.data || [];\r\n        } catch (error) {\r\n            console.error(`‚ùå [SportsDataService] Error total fetching scheduled ${sport}:`, error);\r\n            return [];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene todos los partidos de f√∫tbol (en vivo + programados)\r\n     */\r\n    async getAllFootballMatches(date?: string): Promise<SportsDataEvent[]> {\r\n        const today = date || new Date().toISOString().split('T')[0];\r\n        const [liveMatches, scheduledMatches] = await Promise.all([\r\n            this.getLiveFootballMatches(),\r\n            this.getScheduledFootballMatches(today)\r\n        ]);\r\n\r\n        const allMatches = [...(liveMatches || []), ...(scheduledMatches || [])];\r\n        return allMatches.filter((match, index, self) =>\r\n            index === self.findIndex(m => m.id === match.id)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Obtiene partidos de baloncesto en vivo\r\n     */\r\n    async getLiveBasketballGames(): Promise<SportsDataEvent[]> {\r\n        try {\r\n            // 1. Prioridad: Sofascore DIRECTO\r\n            const data = await this.makeRequest<SportsDataResponse>('/sport/basketball/events/live');\r\n            if (data?.events && data.events.length > 0) return data.events;\r\n        } catch (e) {\r\n            console.warn(\"‚ö†Ô∏è Fallback to Firebase for Live Basketball\");\r\n        }\r\n\r\n        // 2. Fallback: Firebase\r\n        const res = await fetchAPI('/api/basketball/live', { headers: this.headers });\r\n        return res?.events || [];\r\n    }\r\n\r\n    /**\r\n     * Obtiene partidos de baloncesto programados para una fecha\r\n     */\r\n    async getScheduledBasketballGames(date: string): Promise<SportsDataEvent[]> {\r\n        return this.getScheduledEventsBySport('basketball', date);\r\n    }\r\n\r\n    /**\r\n     * Obtiene todos los partidos de baloncesto (en vivo + programados)\r\n     */\r\n    async getAllBasketballGames(date?: string): Promise<SportsDataEvent[]> {\r\n        const today = date || new Date().toISOString().split('T')[0];\r\n        const [liveGames, scheduledGames] = await Promise.all([\r\n            this.getLiveBasketballGames(),\r\n            this.getScheduledBasketballGames(today)\r\n        ]);\r\n\r\n        const allGames = [...(liveGames || []), ...(scheduledGames || [])];\r\n        return allGames.filter((game, index, self) =>\r\n            index === self.findIndex(g => g.id === game.id)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Filtra partidos de baloncesto por liga\r\n     */\r\n    filterBasketballByLeague(games: SportsDataEvent[], league: 'NBA' | 'Euroleague'): SportsDataEvent[] {\r\n        return games.filter(game => {\r\n            const tournamentName = game.tournament.name.toLowerCase();\r\n            const uniqueTournamentName = game.tournament.uniqueTournament?.name.toLowerCase() || '';\r\n            if (league === 'NBA') {\r\n                return tournamentName.includes('nba') || uniqueTournamentName.includes('nba');\r\n            } else {\r\n                return tournamentName.includes('euroleague') || uniqueTournamentName.includes('euroleague');\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Obtiene un evento espec√≠fico por ID\r\n     */\r\n    async getEventById(eventId: string | number): Promise<SportsDataEvent | null> {\r\n        try {\r\n            // 1. PRIORIDAD ABSOLUTA: Sofascore DIRECTO (v√≠a Bridge)\r\n            // Esto garantiza que Momentum, Estad√≠sticas y Alineaciones est√©n disponibles AL INSTANTE\r\n            const ssData = await this.makeRequest<{ event: SportsDataEvent }>(`/event/${eventId}`);\r\n\r\n            if (ssData && ssData.event) {\r\n                const event = ssData.event;\r\n\r\n                // 2. ENRIQUECIMIENTO AS√çNCRONO: Intentar obtener cuotas/predicciones de Firebase\r\n                try {\r\n                    const firebaseRes = await fetchAPI(`/api/events/${eventId}`);\r\n                    if (firebaseRes && firebaseRes.event) {\r\n                        // Combinamos: Datos base de Sofascore + Lo que tengamos en nuestra DB (cuotas, verificaciones)\r\n                        return {\r\n                            ...event,\r\n                            ...firebaseRes.event,\r\n                            // Mantenemos los scores de Sofascore como fuente de verdad en vivo\r\n                            homeScore: event.homeScore,\r\n                            awayScore: event.awayScore,\r\n                            status: event.status,\r\n                            // Indicador de que fue enriquecido\r\n                            isEnriched: true\r\n                        };\r\n                    }\r\n                } catch (e) {\r\n                    // Si falla Firebase, devolvemos el evento puro de Sofascore sin problemas\r\n                }\r\n\r\n                return event;\r\n            }\r\n        } catch (error) {\r\n            console.error(`‚ùå [SportsDataService] Error getting event ${eventId} from Bridge:`, error);\r\n        }\r\n\r\n        // 3. FALLBACK: Si el bridge falla o el evento no existe en Sofascore, intentar solo Firebase\r\n        try {\r\n            const firebaseRes = await fetchAPI(`/api/events/${eventId}`);\r\n            return firebaseRes?.event || null;\r\n        } catch (e) {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene estad√≠sticas detalladas de un evento\r\n     */\r\n    async getMatchBestPlayers(eventId: number): Promise<any> {\r\n        try {\r\n            const data = await this.makeRequest(`/event/${eventId}/best-players`);\r\n\r\n            // If data is valid and has expected structure, return it\r\n            if (data && (data.bestPlayers || data.allPlayers)) {\r\n                return data;\r\n            }\r\n\r\n            // Fallback: Try to derive best players from lineups/statistics\r\n            // console.log(`üîç [SportsData] No direct 'best-players' for ${eventId}, using lineups fallback...`);\r\n            const lineups = await this.getMatchLineups(eventId);\r\n\r\n            if (lineups && lineups.home && lineups.away) {\r\n                const mapPlayers = (players: any[] = []) => players\r\n                    .filter(p => p.statistics && (p.statistics.rating > 0 || p.statistics.points > 0))\r\n                    .sort((a, b) => (b.statistics.rating || 0) - (a.statistics.rating || 0));\r\n\r\n                const homePlayers = [...(lineups.home.players || []), ...(lineups.home.bench || [])];\r\n                const awayPlayers = [...(lineups.away.players || []), ...(lineups.away.bench || [])];\r\n\r\n                const processed = {\r\n                    allPlayers: {\r\n                        home: mapPlayers(homePlayers),\r\n                        away: mapPlayers(awayPlayers)\r\n                    },\r\n                    bestPlayers: {\r\n                        home: mapPlayers(homePlayers).slice(0, 3),\r\n                        away: mapPlayers(awayPlayers).slice(0, 3)\r\n                    },\r\n                    source: 'lineups_derived'\r\n                };\r\n                return processed;\r\n            }\r\n\r\n            return { allPlayers: { home: [], away: [] }, bestPlayers: { home: [], away: [] } };\r\n        } catch (error) {\r\n            console.error(`‚ùå [SportsData] Error getting best players for ${eventId}:`, error);\r\n            return { allPlayers: { home: [], away: [] }, bestPlayers: { home: [], away: [] } };\r\n        }\r\n    }\r\n\r\n    async getMatchMomentum(eventId: number): Promise<any> {\r\n        return await this.makeRequest(`/event/${eventId}/attack-momentum`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene estad√≠sticas generales del partido (posesi√≥n, tiros, etc.)\r\n     */\r\n    async getMatchStatistics(eventId: number): Promise<any> {\r\n        return await this.makeRequest(`/event/${eventId}/statistics`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene cuotas reales de mercado (Bet365, etc.) para el partido\r\n     */\r\n    async getMatchOdds(eventId: number, marketId: number = 1): Promise<any> {\r\n        try {\r\n            const data = await this.makeRequest(`/event/${eventId}/odds/${marketId}/all`);\r\n            // The makeRequest already handles errors and returns null for failed requests.\r\n            // We just need to check if the data is null or empty, which might indicate a 404 or no data.\r\n            if (!data || Object.keys(data).length === 0) {\r\n                console.warn(`[SportsData] Odds not available (or empty response) for event ${eventId}, market ${marketId}`);\r\n                return null;\r\n            }\r\n            return data;\r\n        } catch (error) {\r\n            console.error(`[SportsData] Error fetching odds for ${eventId}:`, error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Intenta extraer la l√≠nea principal de Over/Under (Totales) de un evento\r\n     */\r\n    async getMatchTotalLine(eventId: number, sport: string): Promise<{ line: number; provider: string } | null> {\r\n        try {\r\n            const odds = await this.getMatchOdds(eventId);\r\n            if (!odds || !odds.markets) return null;\r\n\r\n            // Diferentes nombres de mercado seg√∫n el deporte\r\n            const marketKeywords = sport === 'football' ? ['total goals', 'over/under'] : ['total points', 'over/under', 'total'];\r\n\r\n            const market = odds.markets.find((m: any) =>\r\n                marketKeywords.some(key => m.marketName.toLowerCase().includes(key))\r\n            );\r\n\r\n            if (market && market.choices && market.choices.length > 0) {\r\n                const choice = market.choices[0];\r\n                const lineMatch = choice.name.match(/(\\d+\\.?\\d*)/);\r\n                if (lineMatch) {\r\n                    return {\r\n                        line: parseFloat(lineMatch[1]),\r\n                        provider: 'Betplay'\r\n                    };\r\n                }\r\n            }\r\n            return null;\r\n        } catch (error) {\r\n            console.error(`Error al extraer l√≠nea total para ${eventId}:`, error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene alineaciones y estad√≠sticas de jugadores del partido\r\n     */\r\n    async getMatchLineups(eventId: number): Promise<any> {\r\n        return await this.makeRequest(`/event/${eventId}/lineups`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene los jugadores de un equipo (plantilla)\r\n     */\r\n    async getTeamPlayers(teamId: number): Promise<any> {\r\n        return await this.makeRequest(`/team/${teamId}/players`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene los √∫ltimos partidos de un equipo\r\n     */\r\n    async getTeamLastResults(teamId: number, sport: string = 'football'): Promise<any[]> {\r\n        const data = await this.makeRequest(`/team/${teamId}/events/last/0`);\r\n        return data?.events || [];\r\n    }\r\n\r\n    /**\r\n     * Obtiene el historial de enfrentamientos directos (H2H)\r\n     */\r\n    async getMatchH2H(eventId: number): Promise<any> {\r\n        return await this.makeRequest(`/event/${eventId}/h2h`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene estad√≠sticas detalladas de un jugador en un partido espec√≠fico\r\n     */\r\n    async getPlayerEventStatistics(playerId: number, eventId: number): Promise<any> {\r\n        return await this.makeRequest(`/event/${eventId}/player/${playerId}/statistics`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene los √∫ltimos eventos de un jugador\r\n     */\r\n    async getPlayerLastEvents(playerId: number): Promise<any> {\r\n        return await this.makeRequest(`/player/${playerId}/events/last/0`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene estad√≠sticas de un jugador para una temporada\r\n     */\r\n    async getPlayerSeasonStats(playerId: number, tournamentId: number, seasonId: number): Promise<any> {\r\n        try {\r\n            // Priority 1: Regular Season (Most common for NBA/leagues)\r\n            const regularRes = await this.makeRequest(`/player/${playerId}/unique-tournament/${tournamentId}/season/${seasonId}/statistics/regularSeason`);\r\n            if (regularRes && regularRes.statistics) return regularRes;\r\n        } catch (e) {\r\n            // Ignore 404s on regularSeason\r\n        }\r\n\r\n        try {\r\n            // Priority 2: Overall (Fallback)\r\n            const overallRes = await this.makeRequest(`/player/${playerId}/unique-tournament/${tournamentId}/season/${seasonId}/statistics/overall`);\r\n            if (overallRes && overallRes.statistics) return overallRes;\r\n        } catch (e) {\r\n            console.warn(`[SportsData] No season stats found for player ${playerId}`);\r\n        }\r\n\r\n        return { statistics: {} };\r\n    }\r\n\r\n    /**\r\n     * Obtiene eventos para un deporte espec√≠fico (en vivo + programados)\r\n     * FILTERS OUT finished matches older than 2 hours\r\n     * FILTERS OUT upcoming matches starting more than 12 hours from now\r\n     */\r\n    async getEventsBySport(sport: string, date?: string): Promise<SportsDataEvent[]> {\r\n        const today = date || new Date().toISOString().split('T')[0];\r\n        const tomorrow = new Date(new Date(today).getTime() + 86400000).toISOString().split('T')[0];\r\n\r\n        // 1. Obtener datos REAL-TIME directamente de Sofascore (v√≠a Bridge)\r\n        const [liveFromBridge, scheduledToday, scheduledTomorrow] = await Promise.all([\r\n            this.makeRequest<SportsDataResponse>(`/sport/${sport}/events/live`).catch(() => null),\r\n            this.getScheduledEventsBySport(sport, today),\r\n            this.getScheduledEventsBySport(sport, tomorrow)\r\n        ]);\r\n\r\n        const liveEvents = liveFromBridge?.events || [];\r\n        const liveIds = new Set(liveEvents.map((e: any) => e.id));\r\n\r\n        // Filter out matches that are already LIVE from the scheduled lists\r\n        const cleanToday = (Array.isArray(scheduledToday) ? scheduledToday : [])\r\n            .filter(e => !liveIds.has(e.id));\r\n\r\n        const cleanTomorrow = (Array.isArray(scheduledTomorrow) ? scheduledTomorrow : [])\r\n            .filter(e => !liveIds.has(e.id));\r\n\r\n        const allEvents = [\r\n            ...liveEvents,\r\n            ...cleanToday,\r\n            ...cleanTomorrow\r\n        ];\r\n\r\n        // Final deduplication (just in case there's overlap between today and tomorrow or live)\r\n        const uniqueEvents = allEvents.filter((event, index, self) =>\r\n            index === self.findIndex(e => e.id === event.id)\r\n        );\r\n\r\n        // Filter out old finished matches (older than 12 hours) AND future matches (more than 24 hours away)\r\n        const now = Date.now() / 1000;\r\n        const twelveHoursAgo = now - (12 * 60 * 60);\r\n        const twentyFourHoursFromNow = now + (24 * 60 * 60);\r\n\r\n        const recentEvents = uniqueEvents.filter((event) => {\r\n            if (event.status?.type === 'finished') {\r\n                return event.startTimestamp > twelveHoursAgo;\r\n            }\r\n\r\n            if (event.status?.type === 'notstarted' || event.status?.type === 'scheduled') {\r\n                return event.startTimestamp <= twentyFourHoursFromNow;\r\n            }\r\n\r\n            return true;\r\n        });\r\n\r\n        console.log(`üìä [${sport.toUpperCase()}] Filtered ${uniqueEvents.length} events ‚Üí ${recentEvents.length} (deduplicated and windowed)`);\r\n\r\n        return recentEvents;\r\n    }\r\n}\r\n\r\nexport const sportsDataService = new SportsDataService();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 505, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/adminService.ts"],"sourcesContent":["// Quitamos importaciones est√°ticas que rompen el navegador\r\n// import { getFirestore } from './firebaseAdmin';\r\n// import { fetchAPI } from './api';\r\n// import * as admin from 'firebase-admin';\r\n\r\n/**\r\n * Log an API call for monitoring\r\n */\r\nexport async function logApiCall(service: string, endpoint: string, status: number = 200) {\r\n    if (typeof window !== 'undefined') return; // Do not run on client\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const admin = await import('firebase-admin');\r\n        const db = getFirestore();\r\n        await db.collection('admin_api_logs').add({\r\n            service, // 'Groq', 'Gemini', 'Sofascore'\r\n            endpoint,\r\n            status,\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp()\r\n        });\r\n    } catch (error) {\r\n        console.error('Error logging API call:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Log when a user hits their limit\r\n */\r\nexport async function logLimitAlert(uid: string, email: string) {\r\n    if (typeof window !== 'undefined') return; // Do not run on client\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const admin = await import('firebase-admin');\r\n        const db = getFirestore();\r\n        await db.collection('admin_alerts').add({\r\n            type: 'LIMIT_EXCEEDED',\r\n            uid,\r\n            email,\r\n            message: `Usuario ${email} ha superado su l√≠mite diario de predicciones.`,\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n            read: false\r\n        });\r\n    } catch (error) {\r\n        console.error('Error logging limit alert:', error);\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch traffic stats for the last 24 hours (Admin SDK version)\r\n */\r\nexport async function getTrafficStats() {\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const admin = await import('firebase-admin');\r\n        const db = getFirestore();\r\n        const last24h = new Date(Date.now() - 24 * 60 * 60 * 1000);\r\n\r\n        const snap = await db.collection('admin_api_logs')\r\n            .where('timestamp', '>=', admin.firestore.Timestamp.fromDate(last24h))\r\n            .orderBy('timestamp', 'asc')\r\n            .limit(500)\r\n            .get();\r\n\r\n        return snap.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data(),\r\n            date: (doc.data() as any).timestamp?.toDate() || new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching traffic stats:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch latest global activity (Admin SDK version)\r\n */\r\nexport async function getGlobalActivity(limitCount: number = 20) {\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const db = getFirestore();\r\n        const snap = await db.collection('stats_predictions')\r\n            .orderBy('timestamp', 'desc')\r\n            .limit(limitCount)\r\n            .get();\r\n\r\n        return snap.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data(),\r\n            date: (doc.data() as any).timestamp?.toDate() || new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching global activity:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Fetch latest admin alerts (Admin SDK version)\r\n */\r\nexport async function getAdminAlerts(limitCount: number = 10) {\r\n    try {\r\n        const { getFirestore } = await import('./firebaseAdmin');\r\n        const db = getFirestore();\r\n        const snap = await db.collection('admin_alerts')\r\n            .orderBy('timestamp', 'desc')\r\n            .limit(limitCount)\r\n            .get();\r\n\r\n        return snap.docs.map(doc => ({\r\n            id: doc.id,\r\n            ...doc.data(),\r\n            date: (doc.data() as any).timestamp?.toDate() || new Date()\r\n        }));\r\n    } catch (error) {\r\n        console.error('Error fetching admin alerts:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n/**\r\n * Trigger a full recalculation\r\n */\r\nexport async function recalculateScores() {\r\n    try {\r\n        const { fetchAPI } = await import('./api');\r\n        return await fetchAPI('/api/admin/actions', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'RECALCULATE' })\r\n        });\r\n    } catch (error) {\r\n        throw new Error('Error al recalcular puntuaciones');\r\n    }\r\n}\r\n\r\n/**\r\n * Reset global system cache\r\n */\r\nexport async function resetCache() {\r\n    try {\r\n        const { fetchAPI } = await import('./api');\r\n        return await fetchAPI('/api/admin/actions', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'CLEAR_CACHE' })\r\n        });\r\n    } catch (error) {\r\n        throw new Error('Error al reiniciar cache');\r\n    }\r\n}\r\n\r\n/**\r\n * Broadcast a notification\r\n */\r\nexport async function broadcastNotification(message: string) {\r\n    try {\r\n        const { fetchAPI } = await import('./api');\r\n        return await fetchAPI('/api/admin/actions', {\r\n            method: 'POST',\r\n            body: JSON.stringify({ action: 'NOTIFY_ALL', payload: { message } })\r\n        });\r\n    } catch (error) {\r\n        throw new Error('Error al enviar notificaci√≥n masiva');\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 660, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/groqAPIRotator.ts"],"sourcesContent":["/**\r\n * Sistema inteligente de rotaci√≥n de API keys para Groq\r\n * Con balanceo de carga, tracking de rate limit y retry autom√°tico\r\n */\r\n\r\ninterface GroqKeyStats {\r\n    key: string;\r\n    index: number;\r\n    failures: number;\r\n    successes: number;\r\n    totalRequests: number;\r\n    lastUsed: number | null;\r\n    isBlocked: boolean;\r\n    blockUntil: number | null;\r\n    rateLimitReset: number | null;\r\n    remainingRequests: number | null;\r\n}\r\n\r\ninterface GroqRequestResult<T = any> {\r\n    success: boolean;\r\n    data?: T;\r\n    content?: string;\r\n    error?: string;\r\n    keyUsed?: number;\r\n    attempts: number;\r\n    usage?: any;\r\n}\r\n\r\ninterface GroqMessage {\r\n    role: 'system' | 'user' | 'assistant';\r\n    content: string;\r\n}\r\n\r\ninterface GroqCompletionOptions {\r\n    model?: string;\r\n    temperature?: number;\r\n    max_tokens?: number;\r\n    response_format?: { type: 'json_object' | 'text' };\r\n    [key: string]: any;\r\n}\r\n\r\nexport class GroqAPIRotator {\r\n    private apiKeys: GroqKeyStats[];\r\n    private maxRetries: number;\r\n    private maxFailuresBeforeBlock: number;\r\n    private blockDuration: number;\r\n    private rateLimitBlockDuration: number;\r\n\r\n    constructor(apiKeys: string[]) {\r\n        this.apiKeys = apiKeys.map((key, index) => ({\r\n            key,\r\n            index,\r\n            failures: 0,\r\n            successes: 0,\r\n            totalRequests: 0,\r\n            lastUsed: null,\r\n            isBlocked: false,\r\n            blockUntil: null,\r\n            rateLimitReset: null,\r\n            remainingRequests: null\r\n        }));\r\n\r\n        this.maxRetries = 10; // M√°s intentos dado que ahora tenemos 30 keys\r\n        this.maxFailuresBeforeBlock = 2; // M√°s estricto para rotar r√°pido si hay fallos\r\n        this.blockDuration = 1 * 60 * 1000; // Bloqueo m√°s corto (1 min) para reintentar r√°pido\r\n        this.rateLimitBlockDuration = 5 * 60 * 1000; // 5 minutos para rate limit (Groq suele resetear r√°pido)\r\n\r\n        console.log(`[GroqAPIRotator] Initialized with ${apiKeys.length} API key(s)`);\r\n    }\r\n\r\n    /**\r\n     * Obtiene la siguiente key disponible (prioriza las menos usadas)\r\n     */\r\n    private getNextKey(): GroqKeyStats {\r\n        const now = Date.now();\r\n\r\n        // Desbloquear keys si ya pas√≥ el tiempo\r\n        this.apiKeys.forEach(keyObj => {\r\n            if (keyObj.isBlocked && keyObj.blockUntil && now > keyObj.blockUntil) {\r\n                keyObj.isBlocked = false;\r\n                keyObj.failures = 0;\r\n                console.log(`[OK] Groq Key #${keyObj.index + 1} desbloqueada`);\r\n            }\r\n        });\r\n\r\n        // Filtrar keys disponibles\r\n        const availableKeys = this.apiKeys.filter(k => !k.isBlocked);\r\n\r\n        if (availableKeys.length === 0) {\r\n            const nextUnblock = Math.min(...this.apiKeys.map(k => k.blockUntil || Infinity));\r\n            const waitTime = Math.ceil((nextUnblock - now) / 1000);\r\n            throw new Error(`[Error] Todas las Groq API keys est√°n bloqueadas. Pr√≥xima disponible en ${waitTime}s`);\r\n        }\r\n\r\n        // Ordenar por menor uso (balanceo de carga)\r\n        availableKeys.sort((a, b) => a.totalRequests - b.totalRequests);\r\n\r\n        // Seleccionar la menos usada\r\n        const selectedKey = availableKeys[0];\r\n        selectedKey.lastUsed = now;\r\n        selectedKey.totalRequests++;\r\n\r\n        return selectedKey;\r\n    }\r\n\r\n    /**\r\n     * Marca key como exitosa\r\n     */\r\n    private markSuccess(keyObj: GroqKeyStats, responseHeaders: Record<string, string> = {}): void {\r\n        keyObj.successes++;\r\n        keyObj.failures = 0;\r\n\r\n        // Extraer informaci√≥n de rate limit de los headers\r\n        if (responseHeaders['x-ratelimit-remaining']) {\r\n            keyObj.remainingRequests = parseInt(responseHeaders['x-ratelimit-remaining']);\r\n        }\r\n        if (responseHeaders['x-ratelimit-reset']) {\r\n            keyObj.rateLimitReset = parseInt(responseHeaders['x-ratelimit-reset']) * 1000;\r\n        }\r\n\r\n        console.log(`[OK] Groq Key #${keyObj.index + 1} - √âxito | Total: ${keyObj.successes} | Remaining: ${keyObj.remainingRequests || '?'}`);\r\n    }\r\n\r\n    /**\r\n     * Marca key como fallida\r\n     */\r\n    private markFailure(keyObj: GroqKeyStats, error: Error, statusCode: number | null = null): void {\r\n        keyObj.failures++;\r\n\r\n        // Rate limit (429)\r\n        if (statusCode === 429) {\r\n            keyObj.isBlocked = true;\r\n            keyObj.blockUntil = Date.now() + this.rateLimitBlockDuration;\r\n            console.log(`[Blocked] Groq Key #${keyObj.index + 1} - RATE LIMIT - Bloqueada por ${this.rateLimitBlockDuration / 60000} min`);\r\n            return;\r\n        }\r\n\r\n        console.log(`[Warning] Groq Key #${keyObj.index + 1} - Fallo ${keyObj.failures}/${this.maxFailuresBeforeBlock}`);\r\n        console.log(`   Error: ${error.message || error}`);\r\n\r\n        // Bloquear si supera el l√≠mite\r\n        if (keyObj.failures >= this.maxFailuresBeforeBlock) {\r\n            keyObj.isBlocked = true;\r\n            keyObj.blockUntil = Date.now() + this.blockDuration;\r\n            console.log(`[Blocked] Groq Key #${keyObj.index + 1} bloqueada por ${this.blockDuration / 60000} min`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Hace un chat completion con retry inteligente\r\n     */\r\n    async chatCompletion(\r\n        messages: GroqMessage[],\r\n        options: GroqCompletionOptions = {}\r\n    ): Promise<GroqRequestResult> {\r\n        const {\r\n            model = \"llama-3.3-70b-versatile\",\r\n            temperature = 0.7,\r\n            max_tokens = 1024,\r\n            ...otherOptions\r\n        } = options;\r\n\r\n        let lastError: Error | null = null;\r\n        let attempts = 0;\r\n\r\n        while (attempts < this.maxRetries) {\r\n            attempts++;\r\n            let keyObj: GroqKeyStats | null = null;\r\n\r\n            try {\r\n                keyObj = this.getNextKey();\r\n                console.log(`\\n[Retry] Intento ${attempts}/${this.maxRetries} - Usando Groq Key #${keyObj.index + 1}`);\r\n\r\n                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Authorization': `Bearer ${keyObj.key}`,\r\n                        'Content-Type': 'application/json'\r\n                    },\r\n                    body: JSON.stringify({\r\n                        model,\r\n                        messages,\r\n                        temperature,\r\n                        max_tokens,\r\n                        ...otherOptions\r\n                    })\r\n                });\r\n\r\n                // Guardar headers para rate limit info\r\n                const headers: Record<string, string> = {};\r\n                response.headers.forEach((value, key) => {\r\n                    headers[key.toLowerCase()] = value;\r\n                });\r\n\r\n                // Manejar errores HTTP\r\n                if (!response.ok) {\r\n                    const errorData = await response.json().catch(() => ({}));\r\n\r\n                    if (response.status === 429) {\r\n                        this.markFailure(keyObj, new Error('Rate limit exceeded'), 429);\r\n\r\n                        // Si quedan keys, continuar; si no, esperar\r\n                        const availableKeys = this.apiKeys.filter(k => !k.isBlocked).length;\r\n                        if (availableKeys === 0) {\r\n                            throw new Error('Todas las keys en rate limit');\r\n                        }\r\n                        continue;\r\n                    }\r\n\r\n                    throw new Error(`HTTP ${response.status}: ${errorData.error?.message || response.statusText}`);\r\n                }\r\n\r\n                const data = await response.json();\r\n\r\n                // Verificar que la respuesta sea v√°lida\r\n                if (!data.choices || !data.choices[0] || !data.choices[0].message) {\r\n                    throw new Error('Respuesta inv√°lida de Groq API');\r\n                }\r\n\r\n                // Success\r\n                this.markSuccess(keyObj, headers);\r\n                return {\r\n                    success: true,\r\n                    data,\r\n                    content: data.choices[0].message.content,\r\n                    keyUsed: keyObj.index + 1,\r\n                    attempts,\r\n                    usage: data.usage\r\n                };\r\n\r\n            } catch (error) {\r\n                lastError = error as Error;\r\n\r\n                // Marcar fallo solo si tenemos referencia a la key\r\n                if (keyObj) {\r\n                    this.markFailure(keyObj, lastError);\r\n                }\r\n\r\n                // Si no quedan m√°s intentos, terminar\r\n                if (attempts >= this.maxRetries) {\r\n                    console.log(`\\n[Error] Todos los intentos fallaron`);\r\n                    break;\r\n                }\r\n\r\n                // Esperar antes de reintentar (backoff exponencial)\r\n                const waitTime = Math.min(500 * Math.pow(2, attempts - 1), 3000);\r\n                console.log(`[Wait] Esperando ${waitTime}ms antes de reintentar...`);\r\n                await this.sleep(waitTime);\r\n            }\r\n        }\r\n\r\n        // Todos los intentos fallaron\r\n        return {\r\n            success: false,\r\n            error: lastError?.message || 'Error desconocido',\r\n            attempts\r\n        };\r\n    }\r\n\r\n    /**\r\n     * M√©todo conveniente para prompts simples\r\n     */\r\n    async complete(prompt: string, options: GroqCompletionOptions = {}): Promise<GroqRequestResult> {\r\n        return this.chatCompletion([\r\n            { role: \"user\", content: prompt }\r\n        ], options);\r\n    }\r\n\r\n    /**\r\n     * Utilidad para esperar\r\n     */\r\n    private sleep(ms: number): Promise<void> {\r\n        return new Promise(resolve => setTimeout(resolve, ms));\r\n    }\r\n\r\n    /**\r\n     * Obtiene estad√≠sticas detalladas por key\r\n     */\r\n    getStats() {\r\n        return this.apiKeys.map(k => ({\r\n            key: `Key #${k.index + 1}`,\r\n            successes: k.successes,\r\n            failures: k.failures,\r\n            totalRequests: k.totalRequests,\r\n            remaining: k.remainingRequests || '?',\r\n            status: k.isBlocked ? '[Blocked] Bloqueada' : '[Active] Activa'\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Obtiene resumen general\r\n     */\r\n    getSummary() {\r\n        const active = this.apiKeys.filter(k => !k.isBlocked).length;\r\n        const blocked = this.apiKeys.length - active;\r\n        const totalRequests = this.apiKeys.reduce((sum, k) => sum + k.totalRequests, 0);\r\n        const totalSuccesses = this.apiKeys.reduce((sum, k) => sum + k.successes, 0);\r\n        const totalFailures = this.apiKeys.reduce((sum, k) => sum + k.failures, 0);\r\n\r\n        return {\r\n            totalKeys: this.apiKeys.length,\r\n            activeKeys: active,\r\n            blockedKeys: blocked,\r\n            totalRequests,\r\n            totalSuccesses,\r\n            totalFailures,\r\n            successRate: totalRequests > 0 ? `${((totalSuccesses / totalRequests) * 100).toFixed(1)}%` : '0%'\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Resetea estad√≠sticas\r\n     */\r\n    reset(): void {\r\n        this.apiKeys.forEach(k => {\r\n            k.failures = 0;\r\n            k.successes = 0;\r\n            k.totalRequests = 0;\r\n            k.isBlocked = false;\r\n            k.blockUntil = null;\r\n            k.rateLimitReset = null;\r\n            k.remainingRequests = null;\r\n        });\r\n        console.log('[Reset] Groq: Estad√≠sticas reseteadas');\r\n    }\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;AAsCM,MAAM;IACD,QAAwB;IACxB,WAAmB;IACnB,uBAA+B;IAC/B,cAAsB;IACtB,uBAA+B;IAEvC,YAAY,OAAiB,CAAE;QAC3B,IAAI,CAAC,OAAO,GAAG,QAAQ,GAAG,CAAC,CAAC,KAAK,QAAU,CAAC;gBACxC;gBACA;gBACA,UAAU;gBACV,WAAW;gBACX,eAAe;gBACf,UAAU;gBACV,WAAW;gBACX,YAAY;gBACZ,gBAAgB;gBAChB,mBAAmB;YACvB,CAAC;QAED,IAAI,CAAC,UAAU,GAAG,IAAI,8CAA8C;QACpE,IAAI,CAAC,sBAAsB,GAAG,GAAG,+CAA+C;QAChF,IAAI,CAAC,aAAa,GAAG,IAAI,KAAK,MAAM,mDAAmD;QACvF,IAAI,CAAC,sBAAsB,GAAG,IAAI,KAAK,MAAM,yDAAyD;QAEtG,QAAQ,GAAG,CAAC,CAAC,kCAAkC,EAAE,QAAQ,MAAM,CAAC,WAAW,CAAC;IAChF;IAEA;;KAEC,GACD,AAAQ,aAA2B;QAC/B,MAAM,MAAM,KAAK,GAAG;QAEpB,wCAAwC;QACxC,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;YACjB,IAAI,OAAO,SAAS,IAAI,OAAO,UAAU,IAAI,MAAM,OAAO,UAAU,EAAE;gBAClE,OAAO,SAAS,GAAG;gBACnB,OAAO,QAAQ,GAAG;gBAClB,QAAQ,GAAG,CAAC,CAAC,eAAe,EAAE,OAAO,KAAK,GAAG,EAAE,aAAa,CAAC;YACjE;QACJ;QAEA,2BAA2B;QAC3B,MAAM,gBAAgB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,SAAS;QAE3D,IAAI,cAAc,MAAM,KAAK,GAAG;YAC5B,MAAM,cAAc,KAAK,GAAG,IAAI,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA,IAAK,EAAE,UAAU,IAAI;YACtE,MAAM,WAAW,KAAK,IAAI,CAAC,CAAC,cAAc,GAAG,IAAI;YACjD,MAAM,IAAI,MAAM,CAAC,wEAAwE,EAAE,SAAS,CAAC,CAAC;QAC1G;QAEA,4CAA4C;QAC5C,cAAc,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,aAAa,GAAG,EAAE,aAAa;QAE9D,6BAA6B;QAC7B,MAAM,cAAc,aAAa,CAAC,EAAE;QACpC,YAAY,QAAQ,GAAG;QACvB,YAAY,aAAa;QAEzB,OAAO;IACX;IAEA;;KAEC,GACD,AAAQ,YAAY,MAAoB,EAAE,kBAA0C,CAAC,CAAC,EAAQ;QAC1F,OAAO,SAAS;QAChB,OAAO,QAAQ,GAAG;QAElB,mDAAmD;QACnD,IAAI,eAAe,CAAC,wBAAwB,EAAE;YAC1C,OAAO,iBAAiB,GAAG,SAAS,eAAe,CAAC,wBAAwB;QAChF;QACA,IAAI,eAAe,CAAC,oBAAoB,EAAE;YACtC,OAAO,cAAc,GAAG,SAAS,eAAe,CAAC,oBAAoB,IAAI;QAC7E;QAEA,QAAQ,GAAG,CAAC,CAAC,eAAe,EAAE,OAAO,KAAK,GAAG,EAAE,kBAAkB,EAAE,OAAO,SAAS,CAAC,cAAc,EAAE,OAAO,iBAAiB,IAAI,KAAK;IACzI;IAEA;;KAEC,GACD,AAAQ,YAAY,MAAoB,EAAE,KAAY,EAAE,aAA4B,IAAI,EAAQ;QAC5F,OAAO,QAAQ;QAEf,mBAAmB;QACnB,IAAI,eAAe,KAAK;YACpB,OAAO,SAAS,GAAG;YACnB,OAAO,UAAU,GAAG,KAAK,GAAG,KAAK,IAAI,CAAC,sBAAsB;YAC5D,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,OAAO,KAAK,GAAG,EAAE,8BAA8B,EAAE,IAAI,CAAC,sBAAsB,GAAG,MAAM,IAAI,CAAC;YAC7H;QACJ;QAEA,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,OAAO,KAAK,GAAG,EAAE,SAAS,EAAE,OAAO,QAAQ,CAAC,CAAC,EAAE,IAAI,CAAC,sBAAsB,EAAE;QAC/G,QAAQ,GAAG,CAAC,CAAC,UAAU,EAAE,MAAM,OAAO,IAAI,OAAO;QAEjD,+BAA+B;QAC/B,IAAI,OAAO,QAAQ,IAAI,IAAI,CAAC,sBAAsB,EAAE;YAChD,OAAO,SAAS,GAAG;YACnB,OAAO,UAAU,GAAG,KAAK,GAAG,KAAK,IAAI,CAAC,aAAa;YACnD,QAAQ,GAAG,CAAC,CAAC,oBAAoB,EAAE,OAAO,KAAK,GAAG,EAAE,eAAe,EAAE,IAAI,CAAC,aAAa,GAAG,MAAM,IAAI,CAAC;QACzG;IACJ;IAEA;;KAEC,GACD,MAAM,eACF,QAAuB,EACvB,UAAiC,CAAC,CAAC,EACT;QAC1B,MAAM,EACF,QAAQ,yBAAyB,EACjC,cAAc,GAAG,EACjB,aAAa,IAAI,EACjB,GAAG,cACN,GAAG;QAEJ,IAAI,YAA0B;QAC9B,IAAI,WAAW;QAEf,MAAO,WAAW,IAAI,CAAC,UAAU,CAAE;YAC/B;YACA,IAAI,SAA8B;YAElC,IAAI;gBACA,SAAS,IAAI,CAAC,UAAU;gBACxB,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAE,SAAS,CAAC,EAAE,IAAI,CAAC,UAAU,CAAC,oBAAoB,EAAE,OAAO,KAAK,GAAG,GAAG;gBAErG,MAAM,WAAW,MAAM,MAAM,mDAAmD;oBAC5E,QAAQ;oBACR,SAAS;wBACL,iBAAiB,CAAC,OAAO,EAAE,OAAO,GAAG,EAAE;wBACvC,gBAAgB;oBACpB;oBACA,MAAM,KAAK,SAAS,CAAC;wBACjB;wBACA;wBACA;wBACA;wBACA,GAAG,YAAY;oBACnB;gBACJ;gBAEA,uCAAuC;gBACvC,MAAM,UAAkC,CAAC;gBACzC,SAAS,OAAO,CAAC,OAAO,CAAC,CAAC,OAAO;oBAC7B,OAAO,CAAC,IAAI,WAAW,GAAG,GAAG;gBACjC;gBAEA,uBAAuB;gBACvB,IAAI,CAAC,SAAS,EAAE,EAAE;oBACd,MAAM,YAAY,MAAM,SAAS,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;oBAEvD,IAAI,SAAS,MAAM,KAAK,KAAK;wBACzB,IAAI,CAAC,WAAW,CAAC,QAAQ,IAAI,MAAM,wBAAwB;wBAE3D,4CAA4C;wBAC5C,MAAM,gBAAgB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,SAAS,EAAE,MAAM;wBACnE,IAAI,kBAAkB,GAAG;4BACrB,MAAM,IAAI,MAAM;wBACpB;wBACA;oBACJ;oBAEA,MAAM,IAAI,MAAM,CAAC,KAAK,EAAE,SAAS,MAAM,CAAC,EAAE,EAAE,UAAU,KAAK,EAAE,WAAW,SAAS,UAAU,EAAE;gBACjG;gBAEA,MAAM,OAAO,MAAM,SAAS,IAAI;gBAEhC,wCAAwC;gBACxC,IAAI,CAAC,KAAK,OAAO,IAAI,CAAC,KAAK,OAAO,CAAC,EAAE,IAAI,CAAC,KAAK,OAAO,CAAC,EAAE,CAAC,OAAO,EAAE;oBAC/D,MAAM,IAAI,MAAM;gBACpB;gBAEA,UAAU;gBACV,IAAI,CAAC,WAAW,CAAC,QAAQ;gBACzB,OAAO;oBACH,SAAS;oBACT;oBACA,SAAS,KAAK,OAAO,CAAC,EAAE,CAAC,OAAO,CAAC,OAAO;oBACxC,SAAS,OAAO,KAAK,GAAG;oBACxB;oBACA,OAAO,KAAK,KAAK;gBACrB;YAEJ,EAAE,OAAO,OAAO;gBACZ,YAAY;gBAEZ,mDAAmD;gBACnD,IAAI,QAAQ;oBACR,IAAI,CAAC,WAAW,CAAC,QAAQ;gBAC7B;gBAEA,sCAAsC;gBACtC,IAAI,YAAY,IAAI,CAAC,UAAU,EAAE;oBAC7B,QAAQ,GAAG,CAAC,CAAC,qCAAqC,CAAC;oBACnD;gBACJ;gBAEA,oDAAoD;gBACpD,MAAM,WAAW,KAAK,GAAG,CAAC,MAAM,KAAK,GAAG,CAAC,GAAG,WAAW,IAAI;gBAC3D,QAAQ,GAAG,CAAC,CAAC,iBAAiB,EAAE,SAAS,yBAAyB,CAAC;gBACnE,MAAM,IAAI,CAAC,KAAK,CAAC;YACrB;QACJ;QAEA,8BAA8B;QAC9B,OAAO;YACH,SAAS;YACT,OAAO,WAAW,WAAW;YAC7B;QACJ;IACJ;IAEA;;KAEC,GACD,MAAM,SAAS,MAAc,EAAE,UAAiC,CAAC,CAAC,EAA8B;QAC5F,OAAO,IAAI,CAAC,cAAc,CAAC;YACvB;gBAAE,MAAM;gBAAQ,SAAS;YAAO;SACnC,EAAE;IACP;IAEA;;KAEC,GACD,AAAQ,MAAM,EAAU,EAAiB;QACrC,OAAO,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;IACtD;IAEA;;KAEC,GACD,WAAW;QACP,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,CAAA,IAAK,CAAC;gBAC1B,KAAK,CAAC,KAAK,EAAE,EAAE,KAAK,GAAG,GAAG;gBAC1B,WAAW,EAAE,SAAS;gBACtB,UAAU,EAAE,QAAQ;gBACpB,eAAe,EAAE,aAAa;gBAC9B,WAAW,EAAE,iBAAiB,IAAI;gBAClC,QAAQ,EAAE,SAAS,GAAG,wBAAwB;YAClD,CAAC;IACL;IAEA;;KAEC,GACD,aAAa;QACT,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAA,IAAK,CAAC,EAAE,SAAS,EAAE,MAAM;QAC5D,MAAM,UAAU,IAAI,CAAC,OAAO,CAAC,MAAM,GAAG;QACtC,MAAM,gBAAgB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,aAAa,EAAE;QAC7E,MAAM,iBAAiB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,SAAS,EAAE;QAC1E,MAAM,gBAAgB,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,QAAQ,EAAE;QAExE,OAAO;YACH,WAAW,IAAI,CAAC,OAAO,CAAC,MAAM;YAC9B,YAAY;YACZ,aAAa;YACb;YACA;YACA;YACA,aAAa,gBAAgB,IAAI,GAAG,CAAC,AAAC,iBAAiB,gBAAiB,GAAG,EAAE,OAAO,CAAC,GAAG,CAAC,CAAC,GAAG;QACjG;IACJ;IAEA;;KAEC,GACD,QAAc;QACV,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,CAAA;YACjB,EAAE,QAAQ,GAAG;YACb,EAAE,SAAS,GAAG;YACd,EAAE,aAAa,GAAG;YAClB,EAAE,SAAS,GAAG;YACd,EAAE,UAAU,GAAG;YACf,EAAE,cAAc,GAAG;YACnB,EAAE,iBAAiB,GAAG;QAC1B;QACA,QAAQ,GAAG,CAAC;IAChB;AACJ"}},
    {"offset": {"line": 907, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/utils/api-manager.ts"],"sourcesContent":["/**\r\n * API Management Kit\r\n * Sistema hol√≠stico para control, optimizaci√≥n, seguridad y observabilidad de APIs.\r\n */\r\n\r\n// ==========================================\r\n// 1. CONFIGURACI√ìN Y CONSTANTES\r\n// ==========================================\r\n\r\nexport const CACHE_STRATEGIES = {\r\n    // Datos de producto/jugador (cambian muy poco)\r\n    STATIC_DATA: { ttl: 24 * 3600000 }, // 24 horas\r\n\r\n    // An√°lisis de IA (costoso, reutilizable)\r\n    AI_ANALYSIS: { ttl: 12 * 3600000 }, // 12 horas\r\n\r\n    // Datos de Partidos (Sofascore)\r\n    MATCH_DATA: { ttl: 30 * 60000 }, // 30 minutos\r\n\r\n    // Live Score / Trending (muy din√°mico)\r\n    LIVE_DATA: { ttl: 1 * 60000 }, // 1 minuto\r\n\r\n    // Predeterminado\r\n    DEFAULT: { ttl: 60 * 60000 } // 1 hora\r\n};\r\n\r\nexport const API_COSTS = {\r\n    GROQ_REQUEST: 0.0005, // Estimado por request/tokens\r\n    SCRAPER_REQUEST: 0.001 // Costo promedio por llamada exitosa\r\n};\r\n\r\n// ==========================================\r\n// 2. OBSERVABILIDAD & ANALITICA\r\n// ==========================================\r\n\r\nexport interface MetricEntry {\r\n    service: string;\r\n    endpoint?: string;\r\n    success: boolean;\r\n    latency: number;\r\n    timestamp: Date;\r\n    metadata?: any;\r\n}\r\n\r\nexport class Analytics {\r\n    private metrics: MetricEntry[] = [];\r\n\r\n    track(entry: Omit<MetricEntry, 'timestamp'>) {\r\n        this.metrics.push({\r\n            ...entry,\r\n            timestamp: new Date()\r\n        });\r\n\r\n        // Mantener tama√±o manejable en memoria\r\n        if (this.metrics.length > 5000) this.metrics.shift();\r\n    }\r\n\r\n    getDashboard() {\r\n        const total = this.metrics.length;\r\n        const errors = this.metrics.filter(m => !m.success).length;\r\n        const latencies = this.metrics.map(m => m.latency);\r\n        const avgLatency = latencies.length ? latencies.reduce((a, b) => a + b, 0) / latencies.length : 0;\r\n\r\n        return {\r\n            totalRequests: total,\r\n            errorRate: total ? ((errors / total) * 100).toFixed(2) + '%' : '0%',\r\n            avgLatency: Math.round(avgLatency) + 'ms',\r\n            lastUpdate: new Date().toISOString()\r\n        };\r\n    }\r\n}\r\n\r\nexport const globalAnalytics = new Analytics();\r\n\r\n// ==========================================\r\n// 3. CONTROL DE NEGOCIO (PRESUPUESTO)\r\n// ==========================================\r\n\r\nexport class BudgetMonitor {\r\n    private budget: number;\r\n    private spent: number;\r\n\r\n    constructor(monthlyBudget: number = 50.0) { // $50 USD por defecto\r\n        this.budget = monthlyBudget;\r\n        this.spent = 0; // En un sistema real, esto se cargar√≠a de DB/Persistencia\r\n    }\r\n\r\n    trackCost(cost: number) {\r\n        this.spent += cost;\r\n        this.checkThresholds();\r\n    }\r\n\r\n    private checkThresholds() {\r\n        const percentage = (this.spent / this.budget) * 100;\r\n\r\n        if (percentage >= 100) {\r\n            console.error(`üí∞ [CRITICAL] Presupuesto excedido: $${this.spent.toFixed(2)} / $${this.budget}`);\r\n        } else if (percentage > 80) {\r\n            console.warn(`‚ö†Ô∏è [WARNING] 80% del presupuesto consumido: $${this.spent.toFixed(2)}`);\r\n        }\r\n    }\r\n\r\n    getReport() {\r\n        return {\r\n            budget: this.budget,\r\n            spent: this.spent.toFixed(4),\r\n            remaining: (this.budget - this.spent).toFixed(4),\r\n            percentage: ((this.spent / this.budget) * 100).toFixed(1) + '%'\r\n        };\r\n    }\r\n}\r\n\r\nexport const globalBudget = new BudgetMonitor(50); // Presupuesto global\r\n\r\n// ==========================================\r\n// 4. SEGURIDAD (USER RATE LIMITER)\r\n// ==========================================\r\n\r\nexport interface RateLimitResult {\r\n    allowed: boolean;\r\n    remaining?: number;\r\n    resetIn?: number; // Segundos\r\n}\r\n\r\nexport class UserRateLimiter {\r\n    private users: Map<string, number[]> = new Map();\r\n\r\n    canMakeRequest(userId: string, limit: number = 100, windowMs: number = 3600000): RateLimitResult {\r\n        const now = Date.now();\r\n        const userRequests = this.users.get(userId) || [];\r\n\r\n        // Limpiar requests antiguos fuera de ventana\r\n        const recentRequests = userRequests.filter(time => now - time < windowMs);\r\n\r\n        if (recentRequests.length >= limit) {\r\n            const oldestRequest = recentRequests[0] || now;\r\n            const resetIn = Math.ceil((oldestRequest + windowMs - now) / 1000);\r\n\r\n            return {\r\n                allowed: false,\r\n                resetIn\r\n            };\r\n        }\r\n\r\n        recentRequests.push(now);\r\n        this.users.set(userId, recentRequests);\r\n\r\n        return {\r\n            allowed: true,\r\n            remaining: limit - recentRequests.length\r\n        };\r\n    }\r\n}\r\n\r\nexport const globalRateLimiter = new UserRateLimiter();\r\n\r\n// ==========================================\r\n// 5. OPTIMIZACI√ìN (CACHE & QUEUE)\r\n// ==========================================\r\n\r\nimport { Redis } from '@upstash/redis';\r\n\r\nexport class CacheManager {\r\n    private memoryCache: Map<string, { value: any; expiry: number }> = new Map();\r\n    private redis: Redis | null = null;\r\n    private useRedis: boolean = false;\r\n\r\n    constructor() {\r\n        // Intentar inicializar Redis si existen las variables\r\n        if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {\r\n            try {\r\n                this.redis = new Redis({\r\n                    url: process.env.UPSTASH_REDIS_REST_URL,\r\n                    token: process.env.UPSTASH_REDIS_REST_TOKEN,\r\n                });\r\n                this.useRedis = true;\r\n                console.log('üì¶ [CacheManager] Redis enabled via Upstash');\r\n            } catch (error) {\r\n                console.warn('‚ö†Ô∏è [CacheManager] Failed to initialize Redis, falling back to memory');\r\n            }\r\n        } else {\r\n            console.log('‚ÑπÔ∏è [CacheManager] Running in Memory mode (No Redis credentials)');\r\n        }\r\n    }\r\n\r\n    async set(key: string, value: any, ttl: number = CACHE_STRATEGIES.DEFAULT.ttl): Promise<void> {\r\n        if (this.useRedis && this.redis) {\r\n            // Redis TTL es en segundos\r\n            const seconds = Math.ceil(ttl / 1000);\r\n            try {\r\n                await this.redis.set(key, value, { ex: seconds });\r\n                return;\r\n            } catch (err) {\r\n                console.error('‚ùå [CacheManager] Redis set error:', err);\r\n            }\r\n        }\r\n\r\n        // Fallback o modo memoria\r\n        this.memoryCache.set(key, {\r\n            value,\r\n            expiry: Date.now() + ttl\r\n        });\r\n    }\r\n\r\n    async get<T>(key: string): Promise<T | null> {\r\n        if (this.useRedis && this.redis) {\r\n            try {\r\n                const data = await this.redis.get<T>(key);\r\n                if (data) return data;\r\n            } catch (err) {\r\n                console.error('‚ùå [CacheManager] Redis get error:', err);\r\n            }\r\n        }\r\n\r\n        // Fallback o modo memoria\r\n        const item = this.memoryCache.get(key);\r\n        if (!item) return null;\r\n\r\n        if (Date.now() > item.expiry) {\r\n            this.memoryCache.delete(key);\r\n            return null;\r\n        }\r\n\r\n        return item.value as T;\r\n    }\r\n\r\n    /**\r\n     * Obtiene del cach√© o ejecuta la funci√≥n de fetch y guarda el resultado\r\n     */\r\n    async getOrFetch<T>(key: string, fetchFn: () => Promise<T>, ttl?: number): Promise<T> {\r\n        const cached = await this.get<T>(key);\r\n        if (cached) {\r\n            return cached;\r\n        }\r\n\r\n        const data = await fetchFn();\r\n\r\n        // Guardar en fondo para no bloquear respuesta principal\r\n        this.set(key, data, ttl).catch(err => console.error('Cache set background error:', err));\r\n\r\n        return data;\r\n    }\r\n}\r\n\r\nexport class RequestQueue {\r\n    private queue: Array<{ fn: () => Promise<any>; resolve: (v: any) => void; reject: (e: any) => void }> = [];\r\n    private running: number = 0;\r\n    private concurrency: number;\r\n\r\n    constructor(concurrency: number = 3) {\r\n        this.concurrency = concurrency;\r\n    }\r\n\r\n    async add<T>(fn: () => Promise<T>): Promise<T> {\r\n        return new Promise((resolve, reject) => {\r\n            this.queue.push({ fn, resolve, reject });\r\n            this.process();\r\n        });\r\n    }\r\n\r\n    private async process(): Promise<void> {\r\n        if (this.running >= this.concurrency || this.queue.length === 0) return;\r\n\r\n        this.running++;\r\n        const job = this.queue.shift();\r\n        if (!job) { this.running--; return; }\r\n\r\n        const { fn, resolve, reject } = job;\r\n        try {\r\n            const result = await fn();\r\n            resolve(result);\r\n        } catch (error) {\r\n            reject(error);\r\n        } finally {\r\n            this.running--;\r\n            this.process();\r\n        }\r\n    }\r\n}\r\n\r\nexport const globalCache = new CacheManager();\r\n\r\n// ==========================================\r\n// 6. RESILIENCIA (CIRCUIT BREAKER)\r\n// ==========================================\r\n\r\nexport type CircuitState = 'CLOSED' | 'OPEN' | 'HALF_OPEN';\r\n\r\nexport class CircuitBreaker {\r\n    private state: CircuitState = 'CLOSED';\r\n    private failures: number = 0;\r\n    private nextAttempt: number = 0;\r\n\r\n    constructor(\r\n        private threshold: number = 5,\r\n        private timeout: number = 60000\r\n    ) { }\r\n\r\n    async execute<T>(fn: () => Promise<T>): Promise<T> {\r\n        if (this.state === 'OPEN') {\r\n            if (Date.now() < this.nextAttempt) {\r\n                throw new Error('Circuit Breaker OPEN');\r\n            }\r\n            this.state = 'HALF_OPEN';\r\n        }\r\n\r\n        try {\r\n            const result = await fn();\r\n            this.onSuccess();\r\n            return result;\r\n        } catch (error) {\r\n            this.onFailure();\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    private onSuccess() {\r\n        this.failures = 0;\r\n        this.state = 'CLOSED';\r\n    }\r\n\r\n    private onFailure() {\r\n        this.failures++;\r\n        if (this.failures >= this.threshold) {\r\n            this.state = 'OPEN';\r\n            this.nextAttempt = Date.now() + this.timeout;\r\n        }\r\n    }\r\n\r\n    reset() {\r\n        this.failures = 0;\r\n        this.state = 'CLOSED';\r\n        this.nextAttempt = 0;\r\n    }\r\n\r\n    getState() { return this.state; }\r\n}\r\n\r\n// ==========================================\r\n// 7. LOGGER UNIFICADO\r\n// ==========================================\r\n\r\nexport class Logger {\r\n    info(msg: string, data?: any) { console.log(`‚ÑπÔ∏è [INFO] ${msg}`, data || ''); }\r\n    error(msg: string, data?: any) { console.error(`‚ùå [ERROR] ${msg}`, data || ''); }\r\n    warn(msg: string, data?: any) { console.warn(`‚ö†Ô∏è [WARN] ${msg}`, data || ''); }\r\n}\r\n\r\nexport const globalLogger = new Logger();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1225, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/schemas/prediction-schemas.ts"],"sourcesContent":["import { z } from 'zod';\r\n\r\n// ==========================================\r\n// COMPONENTES REUTILIZABLES\r\n// ==========================================\r\n\r\nconst PercentageSchema = z.number().min(0).max(100);\r\nconst ScoreSchema = z.string().regex(/^\\d+-\\d+$/, \"Score format must be 'Home-Away' (e.g. 2-1)\");\r\n\r\n// ==========================================\r\n// ESQUEMAS DE DEPORTES\r\n// ==========================================\r\n\r\n// Baloncesto\r\nconst BasketballPredictionsSchema = z.object({\r\n    finalScore: z.string().optional(),\r\n    totalPoints: z.string().or(z.number()).optional(),\r\n    spread: z.object({\r\n        favorite: z.string(),\r\n        line: z.number(),\r\n        recommendation: z.string()\r\n    }).optional(),\r\n    overUnder: z.object({\r\n        line: z.number(),\r\n        pick: z.enum(['M√°s de', 'Menos de', 'Over', 'Under']),\r\n        confidence: z.string().optional()\r\n    }).optional(),\r\n    topPlayers: z.object({\r\n        homeTopScorer: z.object({\r\n            name: z.string(),\r\n            predictedPoints: z.number(),\r\n            predictedRebounds: z.number().optional(),\r\n            predictedAssists: z.number().optional()\r\n        }).optional(),\r\n        awayTopScorer: z.object({\r\n            name: z.string(),\r\n            predictedPoints: z.number(),\r\n            predictedRebounds: z.number().optional(),\r\n            predictedAssists: z.number().optional()\r\n        }).optional()\r\n    }).optional()\r\n});\r\n\r\n// F√∫tbol\r\nconst FootballPredictionsSchema = z.object({\r\n    finalScore: z.string().optional(),\r\n    totalGoals: z.string().or(z.number()).optional(),\r\n    corners: z.object({\r\n        home: z.number(),\r\n        away: z.number(),\r\n        total: z.number()\r\n    }).optional(),\r\n    shots: z.object({\r\n        home: z.number(),\r\n        away: z.number(),\r\n        onTarget: z.string().or(z.number()).optional()\r\n    }).optional(),\r\n    cards: z.object({\r\n        yellowCards: z.number(),\r\n        redCards: z.number(),\r\n        details: z.string().optional()\r\n    }).optional(),\r\n    offsides: z.object({\r\n        total: z.number(),\r\n        details: z.string().optional()\r\n    }).optional()\r\n});\r\n\r\n// ==========================================\r\n// ESQUEMA PRINCIPAL DE RESPUESTA\r\n// ==========================================\r\n\r\nexport const PredictionResponseSchema = z.object({\r\n    winner: z.string(),\r\n    confidence: PercentageSchema,\r\n    reasoning: z.string(),\r\n    bettingTip: z.string(),\r\n    keyFactors: z.array(z.string()),\r\n\r\n    // Objeto de predicciones detalladas (puede ser de basket o f√∫tbol)\r\n    // Usamos .passthrough() para permitir campos extra sin fallar,\r\n    // pero validamos los conocidos.\r\n    predictions: z.union([\r\n        BasketballPredictionsSchema,\r\n        FootballPredictionsSchema\r\n    ]).optional()\r\n});\r\n\r\nexport const NewsAnalysisSchema = z.object({\r\n    bettingSignal: z.string(),\r\n    sentiment: z.enum(['positive', 'negative', 'neutral']),\r\n    impactScore: z.number().min(0).max(100),\r\n    brutalTitle: z.string().optional()\r\n});\r\n\r\nexport const ParleyResponseSchema = z.object({\r\n    title: z.string(),\r\n    confidence: z.number().min(0).max(100),\r\n    totalOdds: z.number().or(z.string()).transform(v => typeof v === 'string' ? parseFloat(v) : v),\r\n    isValueParley: z.boolean().optional(),\r\n    valueAnalysis: z.string().optional(),\r\n    legs: z.array(z.object({\r\n        matchName: z.string(),\r\n        pick: z.string(),\r\n        odds: z.string().or(z.number()).optional(),\r\n        confidence: z.number().min(0).max(100),\r\n        startTime: z.string().optional(),\r\n        reasoning: z.string().optional()\r\n    })),\r\n    analysis: z.string(),\r\n    riskLevel: z.string()\r\n});\r\n\r\nexport type PredictionResponse = z.infer<typeof PredictionResponseSchema>;\r\nexport type NewsAnalysisResponse = z.infer<typeof NewsAnalysisSchema>;\r\nexport type ParleyResponse = z.infer<typeof ParleyResponseSchema>;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1346, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/groqService.ts"],"sourcesContent":["import Groq from \"groq-sdk\";\r\nimport { logApiCall } from '@/lib/adminService';\r\nimport { GroqAPIRotator } from './groqAPIRotator';\r\nimport {\r\n    CacheManager,\r\n    CircuitBreaker,\r\n    Logger,\r\n    BudgetMonitor,\r\n    Analytics,\r\n    globalCache,\r\n    globalLogger,\r\n    globalBudget,\r\n    globalAnalytics,\r\n    CACHE_STRATEGIES,\r\n    API_COSTS\r\n} from '../utils/api-manager';\r\nimport { PredictionResponseSchema } from '../schemas/prediction-schemas';\r\n\r\n/**\r\n * Servicio robusto para Groq API\r\n * Integrado con GroqAPIRotator y API Management Kit para control de costos y resiliencia\r\n */\r\n\r\nclass GroqService {\r\n    private rotator: GroqAPIRotator;\r\n    private keys: string[];\r\n\r\n    // Componentes de gesti√≥n\r\n    private cache: CacheManager;\r\n    private breaker: CircuitBreaker;\r\n    private logger: Logger;\r\n    private budget: BudgetMonitor;\r\n    private analytics: Analytics;\r\n\r\n    constructor() {\r\n        this.keys = this.loadApiKeys();\r\n        this.rotator = new GroqAPIRotator(this.keys);\r\n\r\n        // Inyectar dependencias globales\r\n        this.cache = globalCache;\r\n        this.logger = globalLogger;\r\n        this.budget = globalBudget;\r\n        this.analytics = globalAnalytics;\r\n\r\n        // Circuit Breaker espec√≠fico para IA (m√°s tolerante)\r\n        this.breaker = new CircuitBreaker(5, 30000); // 5 fallos, 30s de descanso\r\n\r\n        this.logger.info(`\\u{1F9D9} [GeniusEngine] Ready with ${this.keys.length} spells`);\r\n    }\r\n\r\n    private loadApiKeys(): string[] {\r\n        const keys: string[] = [];\r\n        if (process.env.GROQ_API_KEYS) {\r\n            keys.push(...process.env.GROQ_API_KEYS.split(',').map(k => k.trim()).filter(k => k));\r\n        }\r\n        if (process.env.GROQ_API_KEY && !keys.includes(process.env.GROQ_API_KEY)) {\r\n            keys.push(process.env.GROQ_API_KEY);\r\n        }\r\n        if (keys.length === 0) {\r\n            console.warn('‚ö†Ô∏è No Groq API keys configured. Service will not work at runtime.');\r\n            return ['dummy-key-for-build'];\r\n        }\r\n        return keys;\r\n    }\r\n\r\n    /**\r\n     * Crea una predicci√≥n gestionada con cach√© y control de costos\r\n     */\r\n    async createPrediction(params: {\r\n        messages: Array<{ role: string; content: string }>;\r\n        model?: string;\r\n        temperature?: number;\r\n        max_tokens?: number;\r\n        response_format?: { type: 'json_object' | 'text' };\r\n        useCache?: boolean; // Opci√≥n para bypass cach√©\r\n        schema?: any; // Zod Schema opcional\r\n    }): Promise<any> {\r\n        const { useCache = true, schema = PredictionResponseSchema, ...aiParams } = params;\r\n\r\n        // Clave de cach√© basada en el contenido de los mensajes (para no repetir an√°lisis id√©nticos)\r\n        const cacheKey = `groq: prediction:${JSON.stringify(aiParams.messages)} `;\r\n        const start = Date.now();\r\n\r\n        const fetchFn = async () => {\r\n            return this.breaker.execute(async () => {\r\n                try {\r\n                    const result = await this.rotator.chatCompletion(\r\n                        aiParams.messages as any,\r\n                        {\r\n                            model: aiParams.model || 'llama-3.1-8b-instant',\r\n                            temperature: aiParams.temperature ?? 0.6,\r\n                            max_tokens: aiParams.max_tokens || 800,\r\n                            response_format: aiParams.response_format || { type: 'json_object' as const }\r\n                        }\r\n                    );\r\n\r\n                    if (result.success && result.content) {\r\n                        try {\r\n                            const rawJson = JSON.parse(result.content);\r\n\r\n                            // VALIDACI√ìN ZOD (Nivel Profesional)\r\n                            // Si los datos no cumplen la estructura, lanzar√° error detallado\r\n                            const validatedData = schema.parse(rawJson);\r\n\r\n                            // Log exitoso y m√©tricas solo si es v√°lido\r\n                            this.budget.trackCost(API_COSTS.GROQ_REQUEST);\r\n                            this.analytics.track({\r\n                                service: 'GroqAPI',\r\n                                endpoint: 'chat/completions',\r\n                                success: true,\r\n                                latency: Date.now() - start,\r\n                                metadata: { model: aiParams.model, tokens: result.usage?.total_tokens }\r\n                            });\r\n\r\n                            return validatedData;\r\n\r\n                        } catch (e: any) {\r\n                            console.error('[GeniusEngine] Insight/Parse Error:', e.errors || e.message);\r\n                            throw new Error('AI response validation failed: ' + (e.message || 'Invalid format'));\r\n                        }\r\n                    } else {\r\n                        throw new Error(result.error || 'All Groq API keys failed');\r\n                    }\r\n                } catch (err: any) {\r\n                    this.analytics.track({\r\n                        service: 'GroqAPI',\r\n                        endpoint: 'chat/completions',\r\n                        success: false,\r\n                        latency: Date.now() - start,\r\n                        metadata: { error: err.message }\r\n                    });\r\n                    throw err;\r\n                }\r\n            });\r\n        };\r\n\r\n        try {\r\n            if (useCache) {\r\n                // Cachear an√°lisis por 12 horas por defecto (Estrategia AI_ANALYSIS)\r\n                return await this.cache.getOrFetch(cacheKey, fetchFn, CACHE_STRATEGIES.AI_ANALYSIS.ttl);\r\n            } else {\r\n                return await fetchFn();\r\n            }\r\n        } catch (error: any) {\r\n            this.logger.error(`[GeniusEngine] Prediction failed`, { error: error.message });\r\n            console.error(\"[GeniusEngine] Error:\", error.message);\r\n            logApiCall('Groq', '/chat/completions', 500).catch(() => { });\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Crea un prompt simple gestionado\r\n     */\r\n    async complete(prompt: string, options: {\r\n        model?: string;\r\n        temperature?: number;\r\n        max_tokens?: number;\r\n        useCache?: boolean;\r\n    } = {}): Promise<string> {\r\n        const { useCache = true, ...aiOptions } = options;\r\n        const cacheKey = `groq: complete:${prompt} `;\r\n\r\n        const fetchFn = async () => {\r\n            const result = await this.rotator.complete(prompt, aiOptions);\r\n            if (result.success && result.content) {\r\n                this.budget.trackCost(API_COSTS.GROQ_REQUEST);\r\n                logApiCall('Groq', '/chat/completions', 200).catch(() => { });\r\n                return result.content;\r\n            }\r\n            throw new Error(result.error || 'Groq completion failed');\r\n        };\r\n\r\n        try {\r\n            if (useCache) {\r\n                return await this.cache.getOrFetch(cacheKey, fetchFn, CACHE_STRATEGIES.AI_ANALYSIS.ttl);\r\n            }\r\n            return await fetchFn();\r\n        } catch (error: any) {\r\n            this.logger.error(`[GeniusEngine] Completion failed`, { error: error.message });\r\n            throw error;\r\n        }\r\n    }\r\n\r\n    getStats() {\r\n        return {\r\n            rotator: this.rotator.getSummary(),\r\n            keys: this.rotator.getStats(),\r\n            budget: this.budget.getReport(),\r\n            circuit: this.breaker.getState()\r\n        };\r\n    }\r\n\r\n    reset(): void {\r\n        this.rotator.reset();\r\n        this.breaker.reset();\r\n    }\r\n}\r\n\r\nexport const groqService = new GroqService();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1606, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/firebase.ts"],"sourcesContent":["import { initializeApp, getApps, FirebaseApp } from 'firebase/app';\r\nimport { getAuth, Auth, GoogleAuthProvider } from 'firebase/auth';\r\nimport { getFirestore, Firestore } from 'firebase/firestore';\r\nimport { getMessaging, Messaging } from 'firebase/messaging';\r\n\r\nconst firebaseConfig = {\r\n    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY?.trim(),\r\n    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN?.trim(),\r\n    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID?.trim(),\r\n    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET?.trim(),\r\n    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID?.trim(),\r\n    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID?.trim()\r\n};\r\n\r\n// Check if we have the minimum required config\r\nconst hasValidConfig = !!(firebaseConfig.apiKey && firebaseConfig.projectId);\r\n\r\n// Initialize Firebase only if we have valid config and it hasn't been initialized\r\nlet app: FirebaseApp | null = null;\r\nlet auth: Auth | null = null;\r\nlet db: Firestore | null = null;\r\nlet messaging: Messaging | null = null;\r\nconst googleProvider = new GoogleAuthProvider();\r\n\r\nif (hasValidConfig) {\r\n    app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApps()[0];\r\n    auth = getAuth(app);\r\n    db = getFirestore(app);\r\n\r\n    // Initialize Messaging only on client-side\r\n    if (typeof window !== 'undefined') {\r\n        try {\r\n            messaging = getMessaging(app);\r\n            console.log('[Firebase] Messaging initialized');\r\n        } catch (msgErr) {\r\n            console.warn('[Firebase] Messaging failed to initialize (likely due to Service Worker issues or incompatible browser):', msgErr);\r\n        }\r\n    }\r\n\r\n    console.log('[Firebase] Initialized successfully');\r\n} else {\r\n    console.warn('[Firebase] Not initialized - missing config');\r\n}\r\n\r\n// Debug logging AFTER initialization\r\nconst missingVars = Object.entries(firebaseConfig)\r\n    .filter(([_, value]) => !value)\r\n    .map(([key]) => key);\r\n\r\nconsole.log('[Firebase Diagnostic]', {\r\n    hasApp: !!app,\r\n    hasMessaging: !!messaging,\r\n    env: process.env.NODE_ENV,\r\n    config: {\r\n        apiKey: firebaseConfig.apiKey ? `${firebaseConfig.apiKey.substring(0, 5)}...${firebaseConfig.apiKey.substring(firebaseConfig.apiKey.length - 5)}` : 'MISSING',\r\n        projectId: firebaseConfig.projectId || 'MISSING',\r\n        authDomain: firebaseConfig.authDomain || 'MISSING'\r\n    },\r\n    missing: missingVars.length > 0 ? missingVars : 'NONE'\r\n});\r\n\r\nif (missingVars.length > 0) {\r\n    console.error('‚ùå CONFIGURACI√ìN DE FIREBASE INCOMPLETA. Revisa .env.local');\r\n}\r\n\r\nexport { auth, db, app, googleProvider, messaging };\r\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;AAAA;AACA;AAAA;AACA;AAAA;AACA;;;;;AAEA,MAAM,iBAAiB;IACnB,qFAAkD;IAClD,4EAA0D;IAC1D,2DAAwD;IACxD,mFAAgE;IAChE,qEAAyE;IACzE,sFAAgD;AACpD;AAEA,+CAA+C;AAC/C,MAAM,iBAAiB,CAAC,CAAC,CAAC,eAAe,MAAM,IAAI,eAAe,SAAS;AAE3E,kFAAkF;AAClF,IAAI,MAA0B;AAC9B,IAAI,OAAoB;AACxB,IAAI,KAAuB;AAC3B,IAAI,YAA8B;AAClC,MAAM,iBAAiB,IAAI,iMAAkB;AAE7C,IAAI,gBAAgB;IAChB,MAAM,IAAA,oLAAO,IAAG,MAAM,KAAK,IAAI,IAAA,0LAAa,EAAC,kBAAkB,IAAA,oLAAO,GAAE,CAAC,EAAE;IAC3E,OAAO,IAAA,sLAAO,EAAC;IACf,KAAK,IAAA,0LAAY,EAAC;IAElB,2CAA2C;IAC3C;;IASA,QAAQ,GAAG,CAAC;AAChB,OAAO;IACH,QAAQ,IAAI,CAAC;AACjB;AAEA,qCAAqC;AACrC,MAAM,cAAc,OAAO,OAAO,CAAC,gBAC9B,MAAM,CAAC,CAAC,CAAC,GAAG,MAAM,GAAK,CAAC,OACxB,GAAG,CAAC,CAAC,CAAC,IAAI,GAAK;AAEpB,QAAQ,GAAG,CAAC,yBAAyB;IACjC,QAAQ,CAAC,CAAC;IACV,cAAc,CAAC,CAAC;IAChB,GAAG;IACH,QAAQ;QACJ,QAAQ,eAAe,MAAM,GAAG,GAAG,eAAe,MAAM,CAAC,SAAS,CAAC,GAAG,GAAG,GAAG,EAAE,eAAe,MAAM,CAAC,SAAS,CAAC,eAAe,MAAM,CAAC,MAAM,GAAG,IAAI,GAAG;QACpJ,WAAW,eAAe,SAAS,IAAI;QACvC,YAAY,eAAe,UAAU,IAAI;IAC7C;IACA,SAAS,YAAY,MAAM,GAAG,IAAI,cAAc;AACpD;AAEA,IAAI,YAAY,MAAM,GAAG,GAAG;IACxB,QAAQ,KAAK,CAAC;AAClB"}},
    {"offset": {"line": 1677, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/userService.ts"],"sourcesContent":["import { db } from './firebase';\r\nimport {\r\n    doc,\r\n    getDoc,\r\n    setDoc,\r\n    updateDoc,\r\n    arrayUnion,\r\n    arrayRemove,\r\n    serverTimestamp,\r\n    increment\r\n} from 'firebase/firestore';\r\n// Eliminamos la importaci√≥n del adminService para evitar crasheos en el navegador\r\n// import { logLimitAlert } from './adminService';\r\n\r\nconst ADMIN_EMAILS = [\r\n    'pickgenius@gmail.com',\r\n    'ingluisvasquez1311@gmail.com', // Explicit owner email\r\n    'luisvasquez1311@gmail.com'    // Admin whitelist\r\n];\r\n\r\nexport interface FavoritePlayer {\r\n    id: number | string;\r\n    name: string;\r\n    sport: 'basketball' | 'baseball' | 'nhl' | 'tennis' | 'football' | 'american-football' | string;\r\n    team?: string;\r\n}\r\n\r\nexport interface UserProfile {\r\n    uid: string;\r\n    email: string;\r\n    displayName?: string;\r\n    photoURL?: string;\r\n    isPremium: boolean;\r\n    subscriptionType?: 'trial' | 'paid' | 'admin';\r\n    subscriptionEnd?: Date;\r\n    lastActive?: Date;\r\n    predictionsUsed: number;\r\n    predictionsLimit: number;\r\n    totalPredictions: number;\r\n    favoriteTeams: string[];\r\n    favoritePlayers: FavoritePlayer[];\r\n    createdAt: Date;\r\n    lastLogin: Date;\r\n    role: 'admin' | 'user';\r\n    bio?: string;\r\n    phoneNumber?: string;\r\n    preferences?: {\r\n        notifications: boolean;\r\n        theme: 'dark' | 'light';\r\n        language: 'es' | 'en';\r\n        pushAlerts?: {\r\n            hotPicks: boolean;\r\n            matchResults: boolean;\r\n            valueHunter: boolean;\r\n            bankrollAlerts: boolean;\r\n            discord: boolean;\r\n            telegram: boolean;\r\n        };\r\n        discordId?: string;\r\n        telegramId?: string;\r\n    };\r\n    stats?: {\r\n        horarios: number;\r\n        resultados: number;\r\n        anotadores: number;\r\n        asistentes: number;\r\n        rank: number;\r\n        reputation: number;\r\n        streak: string;\r\n        longestStreak: string;\r\n        winRate: number;\r\n        vroi: number;\r\n    };\r\n}\r\n\r\nexport interface PredictionRecord {\r\n    id?: string;\r\n    uid: string;\r\n    // For Player Props\r\n    playerName?: string;\r\n    propType?: string;\r\n    line?: number;\r\n    prediction?: string;\r\n    probability?: number;\r\n\r\n    // For Match Predictions (AI Oracle)\r\n    gameId?: string;\r\n    sport: string;\r\n    homeTeam?: string;\r\n    awayTeam?: string;\r\n    winner?: string;\r\n    bettingTip?: string;\r\n    confidence: string | number;\r\n    reasoning: string;\r\n    predictions?: any; // Detailed stats (goals, corners, offsides)\r\n    keyFactors?: string[];\r\n\r\n    // Outcome tracking\r\n    status?: 'pending' | 'won' | 'lost' | 'void';\r\n    actualResult?: any;\r\n\r\n    timestamp: any;\r\n}\r\n\r\n/**\r\n * Create a new user profile in Firestore\r\n */\r\nexport async function createUserProfile(uid: string, email: string): Promise<UserProfile> {\r\n    if (!db) {\r\n        throw new Error('Firestore not initialized');\r\n    }\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n\r\n    const newProfile: Omit<UserProfile, 'createdAt' | 'lastLogin'> & {\r\n        createdAt: any;\r\n        lastLogin: any;\r\n    } = {\r\n        uid,\r\n        email,\r\n        predictionsUsed: 0,\r\n        predictionsLimit: 3, // Reverts to 3 after trial expires\r\n        totalPredictions: 0,\r\n        favoriteTeams: [],\r\n        favoritePlayers: [],\r\n        createdAt: serverTimestamp(),\r\n        lastLogin: serverTimestamp(),\r\n        role: ADMIN_EMAILS.includes(email.toLowerCase()) ? 'admin' : 'user',\r\n        stats: {\r\n            horarios: 0,\r\n            resultados: 0,\r\n            anotadores: 0,\r\n            asistentes: 0,\r\n            rank: 0,\r\n            reputation: 0,\r\n            streak: '0w',\r\n            longestStreak: '0w',\r\n            winRate: 0,\r\n            vroi: 0\r\n        },\r\n        // GROWTH: 15-Day Free Trial for new users\r\n        subscriptionEnd: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000),\r\n        isPremium: true, // Initially true for the trial\r\n        subscriptionType: 'trial'\r\n    };\r\n\r\n    await setDoc(userRef, newProfile);\r\n\r\n    return {\r\n        ...newProfile,\r\n        createdAt: new Date(),\r\n        lastLogin: new Date()\r\n    };\r\n}\r\n\r\n/**\r\n * Get user profile from Firestore\r\n */\r\nexport async function getUserProfile(uid: string): Promise<UserProfile | null> {\r\n    if (!db) return null;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    const userSnap = await getDoc(userRef);\r\n\r\n    if (!userSnap.exists()) {\r\n        return null;\r\n    }\r\n\r\n    const data = userSnap.data();\r\n    let role = data.role || 'user';\r\n\r\n    // Update lastActive timestamp (non-blocking)\r\n    updateDoc(userRef, { lastActive: serverTimestamp() }).catch(() => null);\r\n\r\n    // Auto-promote if in whitelist but has user role\r\n    if (role !== 'admin' && ADMIN_EMAILS.includes(data.email?.toLowerCase())) {\r\n        role = 'admin';\r\n        // Force admin users to have premium access\r\n        updateDoc(userRef, {\r\n            role: 'admin',\r\n            isPremium: true,\r\n            subscriptionType: 'admin',\r\n            predictionsLimit: -1 // Unlimited\r\n        }).catch(console.error);\r\n    }\r\n\r\n    // Force premium status for all admins\r\n    const isAdmin = role === 'admin';\r\n\r\n    return {\r\n        uid: data.uid,\r\n        email: data.email,\r\n        // Admins are ALWAYS premium, no exceptions\r\n        isPremium: isAdmin || data.isPremium || (data.subscriptionEnd && data.subscriptionEnd.toDate() > new Date()),\r\n        subscriptionType: isAdmin ? 'admin' : (data.subscriptionType || (data.isPremium ? 'paid' : 'trial')),\r\n        subscriptionEnd: data.subscriptionEnd?.toDate(),\r\n        lastActive: data.lastActive?.toDate(),\r\n        predictionsUsed: data.predictionsUsed || 0,\r\n        predictionsLimit: isAdmin ? -1 : (data.predictionsLimit || 3), // Admins have unlimited\r\n        totalPredictions: data.totalPredictions || 0,\r\n        favoriteTeams: data.favoriteTeams || [],\r\n        favoritePlayers: data.favoritePlayers || [],\r\n        createdAt: data.createdAt?.toDate() || new Date(),\r\n        lastLogin: data.lastLogin?.toDate() || new Date(),\r\n        role: role,\r\n        stats: data.stats || {\r\n            horarios: 0,\r\n            resultados: 0,\r\n            anotadores: 0,\r\n            asistentes: 0,\r\n            rank: 0,\r\n            reputation: 0,\r\n            streak: '0w',\r\n            longestStreak: '0w',\r\n            winRate: 0,\r\n            vroi: 0\r\n        }\r\n    };\r\n}\r\n\r\n/**\r\n * Update user's last login timestamp\r\n */\r\nexport async function updateLastLogin(uid: string): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        lastLogin: serverTimestamp()\r\n    });\r\n}\r\n\r\n/**\r\n * Add a team to user's favorites\r\n */\r\nexport async function addFavoriteTeam(uid: string, teamName: string): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        favoriteTeams: arrayUnion(teamName)\r\n    });\r\n}\r\n\r\n/**\r\n * Remove a team from user's favorites\r\n */\r\nexport async function removeFavoriteTeam(uid: string, teamName: string): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        favoriteTeams: arrayRemove(teamName)\r\n    });\r\n}\r\n\r\n/**\r\n * Add a player to user's favorites\r\n */\r\nexport async function addFavoritePlayer(uid: string, player: FavoritePlayer): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        favoritePlayers: arrayUnion(player)\r\n    });\r\n}\r\n\r\n/**\r\n * Remove a player from user's favorites\r\n */\r\nexport async function removeFavoritePlayer(uid: string, player: FavoritePlayer): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        favoritePlayers: arrayRemove(player)\r\n    });\r\n}\r\n\r\n/**\r\n * Increment predictions used counter\r\n */\r\nexport async function incrementPredictionsUsed(uid: string): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    const userSnap = await getDoc(userRef);\r\n\r\n    if (userSnap.exists()) {\r\n        await updateDoc(userRef, {\r\n            predictionsUsed: increment(1),\r\n            totalPredictions: increment(1)\r\n        });\r\n    }\r\n}\r\n\r\n/**\r\n * Reset daily predictions counter (should be called by a scheduled function)\r\n */\r\nexport async function resetDailyPredictions(uid: string): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        predictionsUsed: 0\r\n    });\r\n}\r\n\r\n/**\r\n * Upgrade user to premium\r\n */\r\nexport async function upgradeToPremium(uid: string, subscriptionEndDate: Date): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, {\r\n        isPremium: true,\r\n        subscriptionEnd: subscriptionEndDate,\r\n        subscriptionType: 'paid',\r\n        predictionsLimit: -1 // -1 means unlimited\r\n    });\r\n}\r\n\r\n/**\r\n * Check if user can make a prediction\r\n */\r\nexport async function canMakePrediction(uid: string): Promise<{ canPredict: boolean; remaining: number }> {\r\n    const profile = await getUserProfile(uid);\r\n\r\n    if (!profile) {\r\n        return { canPredict: false, remaining: 0 };\r\n    }\r\n\r\n    // Premium users (including Trial) and Admins have unlimited predictions\r\n    // We double check the date here just in case\r\n    const isSubscriptionActive = profile.subscriptionEnd && profile.subscriptionEnd > new Date();\r\n\r\n    if (profile.isPremium || profile.role === 'admin' || isSubscriptionActive) {\r\n        return { canPredict: true, remaining: -1 };\r\n    }\r\n\r\n    // Free users have daily limit (Fix applied)\r\n    const remaining = profile.predictionsLimit - profile.predictionsUsed;\r\n\r\n    if (remaining <= 0) {\r\n        // Log removed to prevent client-side 'net' module errors\r\n        console.warn(`[Limit] Predictions limit reached for ${uid}`);\r\n        // logLimitAlert(uid, profile.email).catch(() => { });\r\n    }\r\n\r\n    return {\r\n        canPredict: remaining > 0,\r\n        remaining: Math.max(0, remaining)\r\n    };\r\n}\r\n\r\n/**\r\n * Get all users (Admin only)\r\n */\r\nimport { collection, getDocs, query, orderBy, limit } from 'firebase/firestore';\r\n\r\nexport async function getAllUsers(): Promise<UserProfile[]> {\r\n    if (!db) return [];\r\n\r\n    const usersRef = collection(db, 'users');\r\n    const q = query(usersRef, orderBy('createdAt', 'desc'), limit(50)); // Limit to last 50 for performance\r\n    const querySnapshot = await getDocs(q);\r\n\r\n    return querySnapshot.docs.map(doc => {\r\n        const data = doc.data();\r\n        const role = data.role || 'user';\r\n        return {\r\n            uid: data.uid,\r\n            email: data.email,\r\n            isPremium: data.isPremium || false,\r\n            subscriptionType: data.subscriptionType || (role === 'admin' ? 'admin' : (data.isPremium ? 'paid' : 'trial')),\r\n            subscriptionEnd: data.subscriptionEnd?.toDate(),\r\n            lastActive: data.lastActive?.toDate(),\r\n            predictionsUsed: data.predictionsUsed || 0,\r\n            predictionsLimit: data.predictionsLimit || 3,\r\n            totalPredictions: data.totalPredictions || 0,\r\n            favoriteTeams: data.favoriteTeams || [],\r\n            favoritePlayers: data.favoritePlayers || [],\r\n            createdAt: data.createdAt?.toDate() || new Date(),\r\n            lastLogin: data.lastLogin?.toDate() || new Date(),\r\n            role: data.role || 'user'\r\n        };\r\n    });\r\n}\r\n\r\n/**\r\n * Update user profile details\r\n */\r\nexport async function updateUserProfile(uid: string, updates: Partial<UserProfile>): Promise<void> {\r\n    if (!db) return;\r\n    const userRef = doc(db, 'users', uid);\r\n\r\n    // Convert Dates to Firestore timestamps if necessary\r\n    const cleanedUpdates: any = { ...updates };\r\n    if (updates.subscriptionEnd) cleanedUpdates.subscriptionEnd = updates.subscriptionEnd;\r\n\r\n    await updateDoc(userRef, cleanedUpdates);\r\n}\r\n\r\n/**\r\n * Set user role (Admin only)\r\n */\r\nexport async function setUserRole(uid: string, role: 'admin' | 'user'): Promise<void> {\r\n    if (!db) return;\r\n    const userRef = doc(db, 'users', uid);\r\n    await updateDoc(userRef, { role });\r\n}\r\n\r\n/**\r\n * Save an AI prediction to history\r\n */\r\nimport { addDoc } from 'firebase/firestore';\r\n\r\nexport async function savePrediction(uid: string, prediction: Omit<PredictionRecord, 'uid' | 'timestamp'>): Promise<void> {\r\n    if (!db) return;\r\n\r\n    const isGuest = !uid || uid === 'guest';\r\n    const finalUid = isGuest ? 'guest' : uid;\r\n\r\n    const predictionData = {\r\n        ...prediction,\r\n        uid: finalUid,\r\n        isGuest,\r\n        timestamp: serverTimestamp()\r\n    };\r\n\r\n    // 1. Save to main predictions collection (Structure compatible with rules: predictions/{uid}/history)\r\n    const predictionsRef = collection(db, 'predictions', finalUid, 'history');\r\n    await addDoc(predictionsRef, predictionData);\r\n\r\n    // 2. Save to global stats for Admin Live Feed\r\n    const statsRef = collection(db, 'stats_predictions');\r\n    await addDoc(statsRef, {\r\n        gameId: prediction.gameId || 'N/A',\r\n        pick: prediction.bettingTip || prediction.prediction || 'Consulta IA',\r\n        confidence: prediction.confidence || 0,\r\n        sport: prediction.sport || 'football',\r\n        isGuest,\r\n        userEmail: isGuest ? 'Invitado' : 'Usuario Registrado',\r\n        timestamp: serverTimestamp()\r\n    });\r\n\r\n    // 3. Update user stats ONLY if not a guest\r\n    if (!isGuest) {\r\n        const userRef = doc(db, 'users', uid);\r\n\r\n        // Determine target stat based on prediction type\r\n        let statToIncrement = 'stats.resultados'; // Default\r\n\r\n        if (prediction.playerName) {\r\n            // It's a player prop\r\n            if (prediction.propType?.toLowerCase().includes('assist') || prediction.prediction?.toLowerCase().includes('asist')) {\r\n                statToIncrement = 'stats.asistentes';\r\n            } else {\r\n                statToIncrement = 'stats.anotadores';\r\n            }\r\n        }\r\n\r\n        try {\r\n            await updateDoc(userRef, {\r\n                predictionsUsed: increment(1),\r\n                totalPredictions: increment(1),\r\n                [statToIncrement]: increment(1),\r\n                'stats.reputation': increment(15)\r\n            });\r\n        } catch (err) {\r\n            console.error('Error updating user stats (might be non-existent doc):', err);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * Get user's prediction history\r\n */\r\nimport { where } from 'firebase/firestore';\r\n\r\nexport async function getUserPredictions(uid: string, limitCount: number = 20): Promise<PredictionRecord[]> {\r\n    if (!db) return [];\r\n\r\n    const predictionsRef = collection(db, 'predictions', uid, 'history');\r\n    const q = query(\r\n        predictionsRef,\r\n        orderBy('timestamp', 'desc'),\r\n        limit(limitCount)\r\n    );\r\n\r\n    const querySnapshot = await getDocs(q);\r\n    return querySnapshot.docs.map(doc => ({\r\n        id: doc.id,\r\n        ...doc.data() as PredictionRecord,\r\n        timestamp: (doc.data() as any).timestamp?.toDate() || new Date()\r\n    }));\r\n}\r\n\r\n/**\r\n * Saves a generated parley prediction to user's history\r\n */\r\nexport async function saveParleyPrediction(uid: string, parleyData: any) {\r\n    if (!db) return;\r\n    const historyRef = collection(db, 'users', uid, 'parleyHistory');\r\n    return await addDoc(historyRef, {\r\n        ...parleyData,\r\n        createdAt: serverTimestamp()\r\n    });\r\n}\r\n/**\r\n * Recalcula estad√≠sticas reales del usuario basadas en su historial de predicciones\r\n */\r\nexport async function calculateUserStats(uid: string): Promise<UserProfile['stats'] | null> {\r\n    if (!db || !uid || uid === 'guest') return null;\r\n\r\n    try {\r\n        const predictionsRef = collection(db, 'predictions');\r\n        const q = query(predictionsRef, where('uid', '==', uid));\r\n        const querySnapshot = await getDocs(q);\r\n\r\n        let wins = 0;\r\n        let losses = 0;\r\n        let pushes = 0;\r\n        let totalValuable = 0;\r\n        let streak = 0;\r\n        let currentStreakType: 'w' | 'l' | null = null;\r\n        let bestStreak = 0;\r\n\r\n        // Sort by timestamp for streak calculation\r\n        const sortedDocs = querySnapshot.docs\r\n            .map(d => ({ ...d.data(), id: d.id }))\r\n            .sort((a: any, b: any) => (a.timestamp?.toMillis?.() || 0) - (b.timestamp?.toMillis?.() || 0));\r\n\r\n        for (const pred of sortedDocs as any[]) {\r\n            if (pred.status === 'won') {\r\n                wins++;\r\n                totalValuable++;\r\n                if (currentStreakType === 'w') {\r\n                    streak++;\r\n                } else {\r\n                    currentStreakType = 'w';\r\n                    streak = 1;\r\n                }\r\n                if (streak > bestStreak) bestStreak = streak;\r\n            } else if (pred.status === 'lost') {\r\n                losses++;\r\n                totalValuable++;\r\n                if (currentStreakType === 'l') {\r\n                    streak++;\r\n                } else {\r\n                    currentStreakType = 'l';\r\n                    streak = 1;\r\n                }\r\n                streak = 0; // Current win streak reset to 0 in display terms if we only track win streaks\r\n                currentStreakType = 'l';\r\n            } else if (pred.status === 'push') {\r\n                pushes++;\r\n            }\r\n        }\r\n\r\n        const winRate = totalValuable > 0 ? (wins / totalValuable) * 100 : 0;\r\n        const vroi = totalValuable > 0 ? ((wins * 0.9) - losses) / totalValuable * 10 : 14.2; // Mock ROI formula or real one if stakes known\r\n\r\n        const newStats = {\r\n            horarios: sortedDocs.length,\r\n            resultados: wins + losses,\r\n            anotadores: wins,\r\n            asistentes: pushes,\r\n            rank: 24, // Placeholder for now\r\n            reputation: totalValuable * 15,\r\n            streak: `${streak}${currentStreakType || 'w'}`,\r\n            longestStreak: `${bestStreak}w`,\r\n            winRate: Number(winRate.toFixed(1)),\r\n            vroi: Number(vroi.toFixed(1))\r\n        };\r\n\r\n        // Update user profile with real stats\r\n        const userRef = doc(db, 'users', uid);\r\n        await updateDoc(userRef, { stats: newStats });\r\n\r\n        return newStats;\r\n    } catch (error) {\r\n        console.error('Error recalculating user stats:', error);\r\n        return null;\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2102, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/firebaseAdmin.ts"],"sourcesContent":["import * as admin from 'firebase-admin';\r\nimport { readFileSync, existsSync } from 'fs';\r\nimport { join } from 'path';\r\n\r\n// Singleton para evitar m√∫ltiples inicializaciones\r\nlet firebaseApp: admin.app.App | null = null;\r\n\r\nexport function initializeFirebaseAdmin(): admin.app.App {\r\n    // Si ya hay apps inicializadas, intentar recuperar la [DEFAULT]\r\n    if (admin.apps.length > 0) {\r\n        console.log('‚úÖ Re-usando instancia de Firebase Admin existente');\r\n        firebaseApp = admin.apps[0]!;\r\n        return firebaseApp;\r\n    }\r\n\r\n    try {\r\n        console.log('üîß Intentando inicializar Firebase Admin...');\r\n\r\n        // M√âTODO 1: Intentar cargar desde archivo JSON (M√ÅS CONFIABLE)\r\n        const possiblePaths = [\r\n            // When started from PickGenius root\r\n            join(process.cwd(), 'firebase-service-account.json'),\r\n            join(process.cwd(), 'firebase-seervice-account.json'), // Soporte para el typo detectado\r\n            join(process.cwd(), 'firebase-credentials.json'),\r\n            // When started from web directory\r\n            join(process.cwd(), '..', 'firebase-service-account.json'),\r\n            join(process.cwd(), '..', 'firebase-seervice-account.json'),\r\n            join(process.cwd(), '..', 'firebase-credentials.json'),\r\n            // Absolute Windows paths\r\n            'C:\\\\Users\\\\Daniel\\\\PickGenius\\\\firebase-service-account.json',\r\n            'C:\\\\Users\\\\Daniel\\\\PickGenius\\\\firebase-seervice-account.json'\r\n        ];\r\n\r\n        for (const serviceAccountPath of possiblePaths) {\r\n            if (existsSync(serviceAccountPath)) {\r\n                try {\r\n                    const serviceAccount = JSON.parse(readFileSync(serviceAccountPath, 'utf8'));\r\n\r\n                    firebaseApp = admin.initializeApp({\r\n                        credential: admin.credential.cert(serviceAccount),\r\n                        projectId: serviceAccount.project_id,\r\n                        databaseURL: process.env.FIREBASE_DATABASE_URL || `https://${serviceAccount.project_id}.firebaseio.com`\r\n                    });\r\n\r\n                    console.log(`‚úÖ Firebase Admin inicializado desde archivo: ${serviceAccountPath}`);\r\n                    console.log('  Project ID:', firebaseApp.options.projectId);\r\n                    return firebaseApp;\r\n                } catch (e: any) {\r\n                    console.warn(`‚ö†Ô∏è Error leyendo ${serviceAccountPath}:`, e.message);\r\n                }\r\n            }\r\n        }\r\n\r\n        // M√âTODO 2: Usar FIREBASE_SERVICE_ACCOUNT (JSON completo en variable)\r\n        if (process.env.FIREBASE_SERVICE_ACCOUNT) {\r\n            try {\r\n                const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);\r\n\r\n                firebaseApp = admin.initializeApp({\r\n                    credential: admin.credential.cert(serviceAccount),\r\n                    projectId: serviceAccount.project_id,\r\n                    databaseURL: process.env.FIREBASE_DATABASE_URL || `https://${serviceAccount.project_id}.firebaseio.com`\r\n                });\r\n\r\n                console.log('‚úÖ Firebase Admin inicializado desde FIREBASE_SERVICE_ACCOUNT');\r\n                console.log('  Project ID:', firebaseApp.options.projectId);\r\n                return firebaseApp;\r\n            } catch (jsonError) {\r\n                console.warn('‚ö†Ô∏è Error parseando FIREBASE_SERVICE_ACCOUNT');\r\n            }\r\n        }\r\n\r\n        // M√âTODO 3: Usar variables individuales (√öLTIMO RECURSO)\r\n        const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || process.env.FIREBASE_PROJECT_ID;\r\n        const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\r\n        const privateKeyBase64 = process.env.FIREBASE_SERVICE_ACCOUNT_BASE64;\r\n\r\n        if (!projectId || !clientEmail) {\r\n            throw new Error('Faltan credenciales de Firebase (projectId o clientEmail)');\r\n        }\r\n\r\n        // Intentar con Base64\r\n        if (privateKeyBase64) {\r\n            try {\r\n                const privateKey = Buffer.from(privateKeyBase64, 'base64').toString('utf8');\r\n\r\n                firebaseApp = admin.initializeApp({\r\n                    credential: admin.credential.cert({\r\n                        projectId: projectId,\r\n                        clientEmail: clientEmail,\r\n                        privateKey: privateKey\r\n                    }),\r\n                    projectId: projectId,\r\n                    databaseURL: process.env.FIREBASE_DATABASE_URL || `https://${projectId}.firebaseio.com`\r\n                });\r\n\r\n                console.log('‚úÖ Firebase Admin inicializado desde Base64');\r\n                console.log('  Project ID:', firebaseApp.options.projectId);\r\n                return firebaseApp;\r\n            } catch (base64Error) {\r\n                console.warn('‚ö†Ô∏è Error usando Base64');\r\n            }\r\n        }\r\n\r\n        throw new Error('No se pudo inicializar Firebase con ning√∫n m√©todo disponible');\r\n\r\n    } catch (error: any) {\r\n        console.error('‚ùå Error cr√≠tico al inicializar Firebase Admin:');\r\n        console.error('Error Details:', error);\r\n\r\n        // No throw here, return null to let the system handle \"No connection\" gracefully if possible\r\n        // but since many services depend on it, we might still want to throw if it's a CRON task.\r\n        const errorMsg = error instanceof Error ? error.message : String(error);\r\n        throw new Error(`Failed to initialize Firebase Admin: ${errorMsg}`);\r\n    }\r\n}\r\n\r\nlet firestoreDb: admin.firestore.Firestore | null = null;\r\n\r\n// Obtener instancia de Firestore\r\nexport function getFirestore(): admin.firestore.Firestore {\r\n    if (firestoreDb) return firestoreDb;\r\n\r\n    const app = initializeFirebaseAdmin();\r\n    firestoreDb = app.firestore();\r\n\r\n    // Enforce ignoring undefined properties globally (ONLY ONCE)\r\n    try {\r\n        firestoreDb.settings({ ignoreUndefinedProperties: true });\r\n    } catch (e) {\r\n        console.warn('‚ö†Ô∏è Firestore settings already applied or could not be set');\r\n    }\r\n\r\n    return firestoreDb;\r\n}\r\n\r\n// Verificar conexi√≥n a Firebase\r\nexport async function verifyFirebaseConnection(): Promise<boolean> {\r\n    try {\r\n        const db = getFirestore();\r\n\r\n        await db.collection('_health_check').doc('test').set({\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n            status: 'ok'\r\n        });\r\n\r\n        console.log('‚úÖ Conexi√≥n a Firebase Firestore verificada correctamente');\r\n        return true;\r\n    } catch (error) {\r\n        console.error('‚ùå Error verificando conexi√≥n a Firebase:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n// Health check\r\nexport async function getFirebaseHealth(): Promise<{\r\n    connected: boolean;\r\n    projectId: string | null;\r\n    error?: string;\r\n}> {\r\n    try {\r\n        if (!firebaseApp) {\r\n            firebaseApp = initializeFirebaseAdmin();\r\n        }\r\n\r\n        const db = getFirestore();\r\n\r\n        await db.collection('_health_check').doc('status').set({\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n            status: 'healthy'\r\n        });\r\n\r\n        return {\r\n            connected: true,\r\n            projectId: firebaseApp.options.projectId || null\r\n        };\r\n    } catch (error) {\r\n        return {\r\n            connected: false,\r\n            projectId: process.env.FIREBASE_PROJECT_ID || process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || null,\r\n            error: error instanceof Error ? error.message : 'Unknown error'\r\n        };\r\n    }\r\n}\r\n\r\nexport default {\r\n    initializeFirebaseAdmin,\r\n    getFirestore,\r\n    verifyFirebaseConnection,\r\n    getFirebaseHealth\r\n};\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2278, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/FirebaseReadService.ts"],"sourcesContent":["import { getFirestore } from './firebaseAdmin';\r\nimport { Timestamp } from 'firebase-admin/firestore';\r\n\r\nexport interface Game {\r\n    id: string;\r\n    sport: string;\r\n    status: string; // 'Scheduled', 'Live', 'Finished', etc.\r\n    homeTeam: string;\r\n    awayTeam: string;\r\n    startTime: Date;\r\n    // ... otros campos\r\n    [key: string]: any;\r\n}\r\n\r\nclass FirebaseReadService {\r\n    private db;\r\n\r\n    constructor() {\r\n        this.db = getFirestore();\r\n    }\r\n\r\n    /**\r\n     * Verifica si hay datos recientes para un deporte y estado espec√≠fico.\r\n     * √ötil para decidir si disparar una sincronizaci√≥n de fondo.\r\n     */\r\n    async hasRecentData(sport: string, statusCategory: 'live' | 'scheduled' | 'finished'): Promise<boolean> {\r\n        try {\r\n            const eventsRef = this.db.collection('events');\r\n            let query = eventsRef.where('sport', '==', sport);\r\n\r\n            if (statusCategory === 'live') {\r\n                query = query.where('status', '==', 'inprogress');\r\n            } else if (statusCategory === 'scheduled') {\r\n                query = query.where('status', 'in', ['notstarted', 'scheduled']);\r\n            } else if (statusCategory === 'finished') {\r\n                query = query.where('status', '==', 'finished');\r\n            }\r\n\r\n            const snapshot = await query.limit(1).get();\r\n            return !snapshot.empty;\r\n        } catch (error) {\r\n            console.error(`[FirebaseRead] Error checking recent data for ${sport}:`, error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene juegos en vivo desde la colecci√≥n 'events'\r\n     */\r\n    async getLiveGames(sport: string): Promise<any[]> {\r\n        try {\r\n            const snapshot = await this.db.collection('events')\r\n                .where('sport', '==', sport)\r\n                .where('status', '==', 'inprogress')\r\n                .get();\r\n\r\n            return this.mapSnapshotToEvents(snapshot);\r\n        } catch (error) {\r\n            console.error(`[FirebaseRead] Error fetching live ${sport}:`, error);\r\n            return [];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene juegos programados desde la colecci√≥n 'events'\r\n     */\r\n    async getScheduledGames(sport: string): Promise<any[]> {\r\n        try {\r\n            const now = new Date();\r\n            const snapshot = await this.db.collection('events')\r\n                .where('sport', '==', sport)\r\n                .where('status', 'in', ['notstarted', 'scheduled'])\r\n                .where('startTime', '>=', now)\r\n                .orderBy('startTime', 'asc')\r\n                .limit(50)\r\n                .get();\r\n\r\n            return this.mapSnapshotToEvents(snapshot);\r\n        } catch (error) {\r\n            console.error(`[FirebaseRead] Error fetching scheduled ${sport}:`, error);\r\n            return [];\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene un evento espec√≠fico por ID desde la colecci√≥n 'events'\r\n     */\r\n    async getEventById(eventId: string | number): Promise<any | null> {\r\n        try {\r\n            // Buscamos por el ID del documento (que es el externalId de Sofascore)\r\n            const doc = await this.db.collection('events').doc(eventId.toString()).get();\r\n            if (!doc.exists) return null;\r\n\r\n            const data = doc.data();\r\n            // Mapeamos a la estructura de LiveEvent para consistencia\r\n            const events = this.mapSnapshotToEvents({ docs: [doc] } as any);\r\n            return events[0] || null;\r\n        } catch (error) {\r\n            console.error(`[FirebaseRead] Error fetching event ${eventId} from Firebase:`, error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    async getMatchStats(gameId: string | number): Promise<any | null> {\r\n        try {\r\n            // Intentar buscar en matchStats (estructura antigua) o eventos enriquecidos\r\n            const doc = await this.db.collection('matchStats').doc(gameId.toString()).get();\r\n            return doc.exists ? doc.data() : null;\r\n        } catch (error) {\r\n            console.error(`[FirebaseRead] Error fetching match stats for ${gameId}:`, error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    async getMarketLine(gameId: string | number, sport: string): Promise<any | null> {\r\n        try {\r\n            // Ahora leemos de la colecci√≥n 'odds' creada por el Robot 2\r\n            const doc = await this.db.collection('odds').doc(`${sport}_${gameId}`).get();\r\n            return doc.exists ? doc.data() : null;\r\n        } catch (error) {\r\n            console.error(`[FirebaseRead] Error fetching market line for ${gameId}:`, error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    private mapSnapshotToEvents(snapshot: FirebaseFirestore.QuerySnapshot): any[] {\r\n        return snapshot.docs.map(doc => {\r\n            const data = doc.data();\r\n\r\n            // Mapeo de compatibilidad con LiveEvent interface del frontend\r\n            return {\r\n                ...data,\r\n                id: data.externalId || doc.id,\r\n                status: {\r\n                    type: data.status, // 'inprogress', 'notstarted', 'finished'\r\n                    description: data.statusDescription || (data.status === 'inprogress' ? 'En Vivo' : data.status === 'finished' ? 'Finalizado' : 'Programado')\r\n                },\r\n                homeScore: {\r\n                    current: data.homeTeam?.score || 0,\r\n                    period1: data.homeTeam?.halfScore || 0\r\n                },\r\n                awayScore: {\r\n                    current: data.awayTeam?.score || 0,\r\n                    period1: data.awayTeam?.halfScore || 0\r\n                },\r\n                // Asegurar que Teams tengan el formato { id, name, logo }\r\n                homeTeam: {\r\n                    id: data.homeTeam?.id,\r\n                    name: data.homeTeam?.name,\r\n                    logo: data.homeTeam?.logo\r\n                },\r\n                awayTeam: {\r\n                    id: data.awayTeam?.id,\r\n                    name: data.awayTeam?.name,\r\n                    logo: data.awayTeam?.logo\r\n                },\r\n                startTime: data.startTime instanceof Timestamp ? data.startTime.toDate() : (data.startTime ? new Date(data.startTime) : new Date()),\r\n                syncedAt: data.syncedAt instanceof Timestamp ? data.syncedAt.toDate() : (data.syncedAt ? new Date(data.syncedAt) : new Date()),\r\n                startTimestamp: data.startTime instanceof Timestamp ? Math.floor(data.startTime.toDate().getTime() / 1000) : (data.startTime ? Math.floor(new Date(data.startTime).getTime() / 1000) : 0)\r\n            };\r\n        });\r\n    }\r\n}\r\n\r\nexport const firebaseReadService = new FirebaseReadService();\r\nexport default firebaseReadService;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2431, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/oddsSyncService.ts"],"sourcesContent":["import { getFirestore } from '@/lib/firebaseAdmin';\r\n\r\nimport { sportsDataService } from './sportsDataService';\r\nimport { fetchAPI } from '../api';\r\n\r\nexport interface MarketLine {\r\n    gameId: string;\r\n    sport: string;\r\n    marketName: string;\r\n    line: number;\r\n    odds: {\r\n        over?: number;\r\n        under?: number;\r\n        home?: number;\r\n        away?: number;\r\n        homeSpread?: number;\r\n        awaySpread?: number;\r\n    };\r\n    // New Props Field for Rich Data\r\n    props?: {\r\n        corners?: { line: number; over: number; under: number };\r\n        cards?: { line: number; over: number; under: number };\r\n        btts?: { yes: number; no: number };\r\n        playerProps?: Array<{ name: string; market: string; line: number; over: number; under: number }>; // e.g., LeBron Points O/U 25.5\r\n        teamTotals?: { home: number; away: number }; // O/U lines for each team\r\n    };\r\n    provider: string;\r\n    isVerified: boolean;\r\n    updatedAt: Date;\r\n    marketSource: string;\r\n    handicap?: string;\r\n}\r\n\r\nclass OddsSyncService {\r\n    /**\r\n     * Sincroniza las cuotas de un evento espec√≠fico con Firestore prioritizando Betplay\r\n     */\r\n    async syncEventOdds(gameId: number | string, sport: string): Promise<MarketLine | null> {\r\n        try {\r\n            // 1. Intentar obtener datos directamente de Betplay (Kambi)\r\n            const betplayData = await this.fetchBetplayOdds(gameId, sport);\r\n\r\n            if (betplayData) {\r\n                await this.saveMarketLine(betplayData);\r\n                return betplayData;\r\n            }\r\n\r\n            // 2. Fallback a Sofascore si Betplay falla (pero marc√°ndolo como Betplay aproximado)\r\n            // console.log(`‚ö†Ô∏è [OddsSync] No se encontr√≥ l√≠nea directa en Betplay, usando Sofascore para ${gameId}`);\r\n\r\n            const [winnerOdds, totalOdds, spreadOdds] = await Promise.all([\r\n                sportsDataService.getMatchOdds(Number(gameId), 1).catch(() => null),\r\n                sportsDataService.getMatchOdds(Number(gameId), 12).catch(() => null),\r\n                sportsDataService.getMatchOdds(Number(gameId), 2).catch(() => null)\r\n            ]);\r\n\r\n            const allMarkets = [\r\n                ...(winnerOdds?.markets || []),\r\n                ...(totalOdds?.markets || []),\r\n                ...(spreadOdds?.markets || [])\r\n            ];\r\n\r\n            if (allMarkets.length === 0) return null;\r\n\r\n            // Encontrar el mercado m√°s relevante\r\n            const totalMarket = allMarkets.find((m: any) =>\r\n                m.marketName.toLowerCase().includes('total') || m.marketName.toLowerCase().includes('over/under')\r\n            );\r\n\r\n            const handicapMarket = allMarkets.find((m: any) =>\r\n                m.marketName.toLowerCase().includes('spread') || m.marketName.toLowerCase().includes('handicap')\r\n            );\r\n\r\n            let line = 0;\r\n            if (totalMarket?.choices?.[0]) {\r\n                const lineMatch = totalMarket.choices[0].name.match(/(\\d+\\.?\\d*)/);\r\n                line = lineMatch ? parseFloat(lineMatch[1]) : 0;\r\n            }\r\n\r\n            const marketLine: MarketLine = {\r\n                gameId: gameId.toString(),\r\n                sport,\r\n                line,\r\n                marketName: totalMarket?.marketName || 'Total de puntos',\r\n                handicap: handicapMarket?.choices?.[0]?.name || null,\r\n                odds: {\r\n                    over: totalMarket?.choices?.find((c: any) => c.name.toLowerCase().includes('over'))?.fraction,\r\n                    under: totalMarket?.choices?.find((c: any) => c.name.toLowerCase().includes('under'))?.fraction,\r\n                    homeSpread: handicapMarket?.choices?.[0]?.fraction,\r\n                    awaySpread: handicapMarket?.choices?.[1]?.fraction,\r\n                },\r\n                provider: 'Betplay', // Marcamos como Betplay para consistencia, aunque venga via Sofascore\r\n                isVerified: false, // Pero no verificado direct Kambi\r\n                updatedAt: new Date(),\r\n                marketSource: `Sofascore Fallback (Probable identico a Betplay)`\r\n            };\r\n\r\n            await this.saveMarketLine(marketLine);\r\n            return marketLine;\r\n\r\n        } catch (error) {\r\n            console.error(`‚ùå [OddsSync] Error sincronizando cuotas para ${gameId}:`, error);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Fetch directo desde la API de Kambi (Betplay) usando el bridge si est√° disponible\r\n     */\r\n    private async fetchBetplayOdds(gameId: number | string, sport: string): Promise<MarketLine | null> {\r\n        try {\r\n            const kambiEventId = await this.getKambiIdBySofascoreId(gameId, sport);\r\n            if (!kambiEventId) return null;\r\n\r\n            const bridgeUrl = process.env.NEXT_PUBLIC_API_URL;\r\n            const baseUrl = bridgeUrl ? `${bridgeUrl}/api/proxy/kambi` : 'https://tienda.betplay.com.co/offering/v21/betp';\r\n            const url = `${baseUrl}/event/${kambiEventId}.json?lang=es_CO&market=CO`;\r\n\r\n            const responseData = await fetchAPI(url, {\r\n                headers: {\r\n                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36',\r\n                    'Accept': 'application/json, text/plain, */*',\r\n                    'Accept-Language': 'es-ES,es;q=0.9,en;q=0.8',\r\n                    'Referer': 'https://tienda.betplay.com.co/',\r\n                    'Origin': 'https://tienda.betplay.com.co',\r\n                    'Sec-Ch-Ua': '\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"121\", \"Google Chrome\";v=\"121\"',\r\n                    'Sec-Ch-Ua-Mobile': '?0',\r\n                    'Sec-Ch-Ua-Platform': '\"Windows\"',\r\n                    'Sec-Fetch-Dest': 'empty',\r\n                    'Sec-Fetch-Mode': 'cors',\r\n                    'Sec-Fetch-Site': 'same-site',\r\n                    'ngrok-skip-browser-warning': 'true'\r\n                }\r\n            });\r\n\r\n            if (!responseData) return null;\r\n            const data = responseData;\r\n\r\n            // 1. EXTRACT MAIN LINES (Totals/Spread)\r\n            const mainBetOffer = data.betOffers?.find((bo: any) =>\r\n                (bo.betOfferType?.name?.toLowerCase().includes('total') || bo.criterion?.label?.toLowerCase().includes('total')) &&\r\n                bo.main\r\n            );\r\n\r\n            // Fallback: If no \"main\" total, look for any generic \"Total Points/Goals\"\r\n            const fallbackTotal = data.betOffers?.find((bo: any) =>\r\n                bo.criterion?.label === 'Total de goles' || bo.criterion?.label === 'Total de puntos'\r\n            );\r\n\r\n            const targetOffer = mainBetOffer || fallbackTotal;\r\n            if (!targetOffer) return null;\r\n\r\n            const overOutcome = targetOffer.outcomes?.find((o: any) => o.label?.toLowerCase().includes('m√°s'));\r\n            const underOutcome = targetOffer.outcomes?.find((o: any) => o.label?.toLowerCase().includes('menos'));\r\n\r\n            // 2. EXTRACT PROPS (Corners, Cards, Player Props)\r\n            const props: MarketLine['props'] = { playerProps: [] };\r\n\r\n            // Corners\r\n            const cornersOffer = data.betOffers?.find((bo: any) => bo.criterion?.label?.toLowerCase().includes('esquinas') || bo.criterion?.label?.toLowerCase().includes('corners'));\r\n            if (cornersOffer) {\r\n                const o = cornersOffer.outcomes?.find((o: any) => o.label?.includes('M√°s'));\r\n                const u = cornersOffer.outcomes?.find((o: any) => o.label?.includes('Menos'));\r\n                if (o && u) {\r\n                    props.corners = { line: o.line / 1000, over: o.odds / 1000, under: u.odds / 1000 };\r\n                }\r\n            }\r\n\r\n            // Cards\r\n            const cardsOffer = data.betOffers?.find((bo: any) => bo.criterion?.label?.toLowerCase().includes('tarjetas'));\r\n            if (cardsOffer) {\r\n                const o = cardsOffer.outcomes?.find((o: any) => o.label?.includes('M√°s'));\r\n                const u = cardsOffer.outcomes?.find((o: any) => o.label?.includes('Menos'));\r\n                if (o && u) {\r\n                    props.cards = { line: o.line / 1000, over: o.odds / 1000, under: u.odds / 1000 };\r\n                }\r\n            }\r\n\r\n            // BTTS (Ambos marcan)\r\n            const bttsOffer = data.betOffers?.find((bo: any) => bo.criterion?.label?.toLowerCase().includes('ambos equipos marcan'));\r\n            if (bttsOffer) {\r\n                const yes = bttsOffer.outcomes?.find((o: any) => o.label?.toLowerCase().includes('s√≠'));\r\n                const no = bttsOffer.outcomes?.find((o: any) => o.label?.toLowerCase().includes('no'));\r\n                if (yes && no) props.btts = { yes: yes.odds / 1000, no: no.odds / 1000 };\r\n            }\r\n\r\n            // Player Props & Other Popular Markets\r\n            // Expanded to cover Basketball (Rebounds, Assists), Baseball (Innings), Tennis (Sets)\r\n            const playerOffers = data.betOffers?.filter((bo: any) => {\r\n                const label = bo.criterion?.label?.toLowerCase() || '';\r\n                return label.includes('puntos') ||\r\n                    label.includes('goleador') ||\r\n                    label.includes('yardas') || // NFL\r\n                    label.includes('rebotes') || // Basketball\r\n                    label.includes('asistencias') || // Basketball/Football\r\n                    label.includes('triples') || // Basketball\r\n                    label.includes('entradas') || // Baseball (Innings)\r\n                    label.includes('strike') || // Baseball\r\n                    label.includes('set') // Tennis\r\n            }).slice(0, 8); // Increased limit to capture more variety\r\n\r\n            playerOffers?.forEach((po: any) => {\r\n                const playerName = po.outcomes?.[0]?.participant || 'Mercado';\r\n                const marketName = po.criterion?.label;\r\n                const oLine = po.outcomes?.find((o: any) => o.label?.includes('M√°s'));\r\n                const uLine = po.outcomes?.find((o: any) => o.label?.includes('Menos'));\r\n\r\n                if (oLine && uLine) {\r\n                    props.playerProps?.push({\r\n                        name: playerName,\r\n                        market: marketName,\r\n                        line: oLine.line / 1000,\r\n                        over: oLine.odds / 1000,\r\n                        under: uLine.odds / 1000\r\n                    });\r\n                }\r\n            });\r\n\r\n            return {\r\n                gameId: gameId.toString(),\r\n                sport,\r\n                line: overOutcome?.line / 1000 || 0,\r\n                marketName: targetOffer.criterion?.label || 'Total',\r\n                odds: {\r\n                    over: overOutcome?.odds ? overOutcome.odds / 1000 : undefined,\r\n                    under: underOutcome?.odds ? underOutcome.odds / 1000 : undefined,\r\n                },\r\n                props: props, // NEW: Attach extracted props\r\n                provider: 'Betplay',\r\n                isVerified: true,\r\n                updatedAt: new Date(),\r\n                marketSource: 'Direct Kambi Feed (Betplay Colombia)'\r\n            };\r\n        } catch (e) {\r\n            console.error(\"‚ùå [OddsSync] Error en fetchBetplayOdds:\", e);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Mapea un ID de Sofascore a un ID de Kambi/Betplay mediante b√∫squeda inteligente\r\n     */\r\n    private async getKambiIdBySofascoreId(gameId: number | string, sport: string): Promise<number | null> {\r\n        try {\r\n            // 0. Manual Overrides (si existen)\r\n            if (gameId.toString() === '12702781') return 1021435081;\r\n\r\n            // 1. Obtener detalles del evento de Sofascore para tener los nombres\r\n            const sofascoreEvent = await sportsDataService.getEventById(Number(gameId)).catch(() => null);\r\n            if (!sofascoreEvent) return null;\r\n\r\n            const normalize = (name: string) => name ? name.toLowerCase().normalize(\"NFD\").replace(/[\\u0300-\\u036f]/g, \"\").replace(/ fc| cf| club| united| city| real| atletico/g, \"\").trim() : '';\r\n            const homeName = normalize(sofascoreEvent.homeTeam?.name);\r\n            const awayName = normalize(sofascoreEvent.awayTeam?.name);\r\n\r\n            if (!homeName || !awayName) return null;\r\n\r\n            // 2. Definir Grupos de Kambi para buscar (Base de Datos Mundial)\r\n            // Estos IDs suelen corresponder a deportes/ligas en Kambi.\r\n            const SPORT_GROUP_IDS: Record<string, number[]> = {\r\n                'basketball': [1000093204, 1000093652, 1000093654, 2000093204], // NBA, Euroleague, International\r\n                'football': [1000093190, 1000094985, 1000093258, 2000093190], // Premier, LaLiga, Serie A, World\r\n                'tennis': [1000093228, 1000093240, 2000093228], // ATP, WTA\r\n                'baseball': [1000093203, 2000093203], // MLB, International\r\n                'american-football': [1000093193, 2000093193], // NFL\r\n                'ice-hockey': [1000093205, 2000093205] // NHL\r\n            };\r\n\r\n            // Mapeo simple de sport string a key\r\n            let sportKey = sport.toLowerCase();\r\n            if (sportKey.includes('nfl')) sportKey = 'american-football';\r\n            if (sportKey.includes('hockey')) sportKey = 'ice-hockey';\r\n            if (sportKey.includes('soccer')) sportKey = 'football';\r\n\r\n            const groupIds = SPORT_GROUP_IDS[sportKey] || [];\r\n            if (groupIds.length === 0) {\r\n                // Fallback gen√©rico si no hay IDs espec√≠ficos\r\n                return null;\r\n            }\r\n\r\n            const bridgeUrl = process.env.NEXT_PUBLIC_API_URL;\r\n\r\n            // 3. Buscar en los grupos definidos\r\n            for (const groupId of groupIds) {\r\n                const searchUrl = bridgeUrl\r\n                    ? `${bridgeUrl}/api/proxy/kambi/event/group/${groupId}.json?lang=es_CO&market=CO`\r\n                    : `https://tienda.betplay.com.co/offering/v21/betp/event/group/${groupId}.json?lang=es_CO&market=CO`;\r\n\r\n                const groupData = await fetchAPI(searchUrl, {\r\n                    headers: { 'ngrok-skip-browser-warning': 'true' },\r\n                });\r\n\r\n                if (!groupData) continue;\r\n\r\n                // 4. Comparaci√≥n Difusa (Fuzzy Match)\r\n                const kambiEvent = groupData.events?.find((e: any) => {\r\n                    const kName = normalize(e.event?.name);\r\n                    const homeMatch = kName.includes(homeName);\r\n                    const awayMatch = kName.includes(awayName);\r\n\r\n                    // Si encuentra AMBOS nombres, es match seguro (100% confidence)\r\n                    if (homeMatch && awayMatch) return true;\r\n\r\n                    // Si encuentra UNO y el deporte es individual (Tenis), a veces basta, pero preferimos seguridad.\r\n                    // Para evitar falsos positivos en \"City\" vs \"United\", requerimos al menos una coincidencia fuerte.\r\n                    if ((homeMatch || awayMatch) && kName.length > 5) return true;\r\n\r\n                    return false;\r\n                });\r\n\r\n                if (kambiEvent?.event?.id) {\r\n                    console.log(`‚úÖ [OddsSync] Match Encontrado: ${sofascoreEvent.homeTeam.name} vs ${sofascoreEvent.awayTeam.name} -> Betplay ID ${kambiEvent.event.id}`);\r\n                    return kambiEvent.event.id;\r\n                }\r\n            }\r\n            return null;\r\n        } catch (e) {\r\n            console.error(\"‚ùå [OddsSync] Error mapeando IDs:\", e);\r\n            return null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Persiste la l√≠nea de mercado en Firebase filtrando solo lo interesante\r\n     */\r\n    private async saveMarketLine(marketLine: MarketLine) {\r\n        const db = getFirestore();\r\n        if (!db) return;\r\n\r\n        const docRef = db.collection('marketLines').doc(`${marketLine.sport}_${marketLine.gameId}`);\r\n\r\n        // Funci√≥n de limpieza para evitar errores de Firestore con 'undefined'\r\n        const removeUndefined = (obj: any) => JSON.parse(JSON.stringify(obj));\r\n\r\n        // Solo guardamos la informaci√≥n de valor, descartando ruido\r\n        const rawData = {\r\n            gameId: marketLine.gameId,\r\n            sport: marketLine.sport,\r\n            line: marketLine.line,\r\n            marketName: marketLine.marketName,\r\n            handicap: marketLine.handicap,\r\n            odds: marketLine.odds,\r\n            props: marketLine.props,\r\n            provider: marketLine.provider,\r\n            isVerified: marketLine.isVerified,\r\n            marketSource: marketLine.marketSource,\r\n            updatedAt: marketLine.updatedAt?.toISOString() || new Date().toISOString()\r\n        };\r\n\r\n        const cleanData = removeUndefined(rawData);\r\n\r\n        try {\r\n            await docRef.set(cleanData);\r\n            console.log(`‚úÖ [OddsSync] Betplay Data Saved: ${marketLine.gameId} (O/U ${marketLine.line})`);\r\n        } catch (error) {\r\n            console.error(`‚ùå [OddsSync] Error saving to Firebase:`, error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Obtiene la l√≠nea de mercado guardada desde Firestore\r\n     */\r\n    async getStoredMarketLine(gameId: string | number, sport: string): Promise<MarketLine | null> {\r\n        try {\r\n            const db = getFirestore();\r\n            if (!db) return null;\r\n\r\n            const docRef = db.collection('marketLines').doc(`${sport}_${gameId}`);\r\n            const docSnap = await docRef.get();\r\n\r\n            if (docSnap.exists) {\r\n                const data = docSnap.data();\r\n                return {\r\n                    ...data,\r\n                    // Convert Firestore Timestamp to Date if needed\r\n                    updatedAt: data?.updatedAt?.toDate ? data.updatedAt.toDate() : new Date(data?.updatedAt)\r\n                } as MarketLine;\r\n            }\r\n            return null;\r\n        } catch (error) {\r\n            console.error(`‚ùå [OddsSync] Error obteniendo l√≠nea de Firebase:`, error);\r\n            return null;\r\n        }\r\n    }\r\n}\r\n\r\nexport const oddsSyncService = new OddsSyncService();\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2767, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/services/predictionArchiveService.ts"],"sourcesContent":["import { getFirestore } from '@/lib/firebaseAdmin';\r\nimport admin from 'firebase-admin';\r\n\r\nexport interface PredictionRecord {\r\n    id?: string;\r\n    uid: string;\r\n    gameId?: string;\r\n    sport: string;\r\n    winner?: string;\r\n    bettingTip?: string;\r\n    confidence: string | number;\r\n    reasoning: string;\r\n    timestamp?: any;\r\n}\r\n\r\n/**\r\n * Servicio para archivar predicciones y actualizar estad√≠sticas desde el servidor\r\n * Utiliza Admin SDK para saltar reglas de seguridad\r\n */\r\nexport async function archivePredictionOnServer(uid: string, prediction: Omit<PredictionRecord, 'uid' | 'timestamp'>) {\r\n    try {\r\n        const db = getFirestore();\r\n        const isGuest = !uid || uid === 'guest';\r\n        const finalUid = isGuest ? 'guest' : uid;\r\n\r\n        // 1. Guardar en historial del usuario (Estructura compatible con firestore.rules)\r\n        if (!isGuest) {\r\n            const userHistoryRef = db.collection('predictions').doc(finalUid).collection('history');\r\n            await userHistoryRef.add({\r\n                ...prediction,\r\n                uid: finalUid,\r\n                timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n                createdAt: new Date().toISOString()\r\n            });\r\n        }\r\n\r\n        // 2. Guardar en estad√≠sticas globales (Live Feed)\r\n        const globalRef = db.collection('stats_predictions');\r\n        await globalRef.add({\r\n            gameId: prediction.gameId || 'N/A',\r\n            pick: prediction.bettingTip || prediction.winner || 'Consult IA',\r\n            confidence: prediction.confidence || 0,\r\n            sport: prediction.sport || 'football',\r\n            isGuest,\r\n            userEmail: isGuest ? 'Invitado' : 'Usuario Registrado',\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp()\r\n        });\r\n\r\n        // 3. Actualizar contadores del usuario\r\n        if (!isGuest) {\r\n            const userRef = db.collection('users').doc(finalUid);\r\n\r\n            // Determinar qu√© estad√≠stica incrementar\r\n            let statToIncrement = 'stats.resultados';\r\n            if (prediction.sport === 'basketball') statToIncrement = 'stats.anotadores';\r\n\r\n            await userRef.update({\r\n                predictionsUsed: admin.firestore.FieldValue.increment(1),\r\n                totalPredictions: admin.firestore.FieldValue.increment(1),\r\n                [statToIncrement]: admin.firestore.FieldValue.increment(1),\r\n                'stats.reputation': admin.firestore.FieldValue.increment(15)\r\n            }).catch(() => null); // Silenciar si el documento no existe (raro)\r\n        }\r\n\r\n        console.log(`‚úÖ [ArchiveService] Prediction archived for ${finalUid}`);\r\n        return { success: true };\r\n    } catch (error) {\r\n        console.error('‚ùå [ArchiveService] Error archiving prediction:', error);\r\n        return { success: false, error };\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAkBO,eAAe,0BAA0B,GAAW,EAAE,UAAuD;IAChH,IAAI;QACA,MAAM,KAAK,IAAA,6IAAY;QACvB,MAAM,UAAU,CAAC,OAAO,QAAQ;QAChC,MAAM,WAAW,UAAU,UAAU;QAErC,kFAAkF;QAClF,IAAI,CAAC,SAAS;YACV,MAAM,iBAAiB,GAAG,UAAU,CAAC,eAAe,GAAG,CAAC,UAAU,UAAU,CAAC;YAC7E,MAAM,eAAe,GAAG,CAAC;gBACrB,GAAG,UAAU;gBACb,KAAK;gBACL,WAAW,qMAAK,CAAC,SAAS,CAAC,UAAU,CAAC,eAAe;gBACrD,WAAW,IAAI,OAAO,WAAW;YACrC;QACJ;QAEA,kDAAkD;QAClD,MAAM,YAAY,GAAG,UAAU,CAAC;QAChC,MAAM,UAAU,GAAG,CAAC;YAChB,QAAQ,WAAW,MAAM,IAAI;YAC7B,MAAM,WAAW,UAAU,IAAI,WAAW,MAAM,IAAI;YACpD,YAAY,WAAW,UAAU,IAAI;YACrC,OAAO,WAAW,KAAK,IAAI;YAC3B;YACA,WAAW,UAAU,aAAa;YAClC,WAAW,qMAAK,CAAC,SAAS,CAAC,UAAU,CAAC,eAAe;QACzD;QAEA,uCAAuC;QACvC,IAAI,CAAC,SAAS;YACV,MAAM,UAAU,GAAG,UAAU,CAAC,SAAS,GAAG,CAAC;YAE3C,yCAAyC;YACzC,IAAI,kBAAkB;YACtB,IAAI,WAAW,KAAK,KAAK,cAAc,kBAAkB;YAEzD,MAAM,QAAQ,MAAM,CAAC;gBACjB,iBAAiB,qMAAK,CAAC,SAAS,CAAC,UAAU,CAAC,SAAS,CAAC;gBACtD,kBAAkB,qMAAK,CAAC,SAAS,CAAC,UAAU,CAAC,SAAS,CAAC;gBACvD,CAAC,gBAAgB,EAAE,qMAAK,CAAC,SAAS,CAAC,UAAU,CAAC,SAAS,CAAC;gBACxD,oBAAoB,qMAAK,CAAC,SAAS,CAAC,UAAU,CAAC,SAAS,CAAC;YAC7D,GAAG,KAAK,CAAC,IAAM,OAAO,6CAA6C;QACvE;QAEA,QAAQ,GAAG,CAAC,CAAC,2CAA2C,EAAE,UAAU;QACpE,OAAO;YAAE,SAAS;QAAK;IAC3B,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,kDAAkD;QAChE,OAAO;YAAE,SAAS;YAAO;QAAM;IACnC;AACJ"}},
    {"offset": {"line": 2832, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/app/api/predictions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { sportsDataService } from '@/lib/services/sportsDataService';\r\nimport { groqService } from '@/lib/services/groqService';\r\nimport { globalCache } from '@/lib/utils/api-manager';\r\nimport { getUserProfile } from '@/lib/userService';\r\nimport { firebaseReadService } from '@/lib/FirebaseReadService';\r\nimport { oddsSyncService } from '@/lib/services/oddsSyncService';\r\nimport { archivePredictionOnServer } from '@/lib/services/predictionArchiveService';\r\n\r\nexport async function GET() {\r\n    return NextResponse.json({\r\n        status: 'online',\r\n        service: 'PickGenius Oracle AI',\r\n        version: '3.0.0 (Dual Robot Bridge)',\r\n        managed_by: 'Antigravity'\r\n    });\r\n}\r\n\r\nexport const maxDuration = 60;\r\n\r\nexport async function POST(request: NextRequest) {\r\n    let fallbackHomeName = 'Equipo Local';\r\n    let fallbackAwayName = 'Equipo Visitante';\r\n    let sport = 'football';\r\n    let gameId = '';\r\n\r\n    try {\r\n        const body = await request.json().catch(() => ({}));\r\n        if (body.homeTeam || body.homeTeamName) fallbackHomeName = body.homeTeam || body.homeTeamName;\r\n        if (body.awayTeam || body.awayTeamName) fallbackAwayName = body.awayTeam || body.awayTeamName;\r\n        if (body.sport) sport = body.sport;\r\n        if (body.gameId) gameId = String(body.gameId);\r\n        const uid = body.uid;\r\n\r\n        if (!gameId || !sport) {\r\n            return NextResponse.json({ success: false, error: 'Missing gameId or sport' }, { status: 400 });\r\n        }\r\n\r\n        let isPremiumUser = false;\r\n        if (uid) {\r\n            const profile = await getUserProfile(uid);\r\n            const isOwner = profile?.email && (\r\n                profile.email.toLowerCase() === 'pickgenius@gmail.com' ||\r\n                profile.email.toLowerCase() === 'ingluisvasquez1311@gmail.com' ||\r\n                profile.email.toLowerCase() === 'luisvasquez1311@gmail.com'\r\n            );\r\n            isPremiumUser = profile?.isPremium || profile?.role === 'admin' || isOwner || false;\r\n        }\r\n\r\n        const cacheKey = `prediction:${sport}:${gameId}`;\r\n        const cachedPrediction = await globalCache.get(cacheKey);\r\n\r\n        if (cachedPrediction) {\r\n            const cacheAge = Date.now() - new Date((cachedPrediction as any).generatedAt || 0).getTime();\r\n            if (cacheAge < 5 * 60 * 1000) {\r\n                return NextResponse.json(cachedPrediction);\r\n            }\r\n        }\r\n\r\n        const [firebaseEvent, firebaseMarketLine] = await Promise.all([\r\n            firebaseReadService.getEventById(gameId).catch(() => null),\r\n            oddsSyncService.getStoredMarketLine(gameId, sport).catch(() => null)\r\n        ]);\r\n\r\n        const [statsRes, oddsRes, h2hRes] = await Promise.all([\r\n            sportsDataService.makeRequest(`/event/${gameId}/statistics`).catch(() => null),\r\n            firebaseMarketLine ? Promise.resolve(null) : sportsDataService.getMatchOdds(Number(gameId)).catch(() => null),\r\n            sportsDataService.getMatchH2H(Number(gameId)).catch(() => null)\r\n        ]);\r\n\r\n        let event = firebaseEvent;\r\n        if (!event) {\r\n            const gameRes = await sportsDataService.makeRequest(`/event/${gameId}`).catch(() => null);\r\n            event = gameRes?.event || gameRes;\r\n        }\r\n\r\n        if (!event) throw new Error(\"Evento no encontrado\");\r\n\r\n        const homeScore = event.homeScore?.current || 0;\r\n        const awayScore = event.awayScore?.current || 0;\r\n\r\n        const matchContext = {\r\n            sport: sport.toUpperCase(),\r\n            home: event.homeTeam?.name || fallbackHomeName,\r\n            away: event.awayTeam?.name || fallbackAwayName,\r\n            score: `${homeScore} - ${awayScore}`,\r\n            status: event.status?.description || 'Scheduled',\r\n            tournament: event.tournament?.name,\r\n            timeElapsed: event.time?.played,\r\n            h2hHistory: h2hRes?.events?.slice(0, 5).map((e: any) => ({\r\n                score: `${e.homeScore?.current}-${e.awayScore?.current}`,\r\n                winner: e.winnerCode === 1 ? 'Home' : (e.winnerCode === 2 ? 'Away' : 'Draw'),\r\n                date: new Date(e.startTimestamp * 1000).toLocaleDateString()\r\n            })),\r\n            statistics: statsRes || {},\r\n            marketOdds: oddsRes?.markets?.slice(0, 5).map((m: any) => ({\r\n                marketName: m.marketName,\r\n                choices: m.choices?.map((c: any) => ({ name: c.name, fraction: c.fraction }))\r\n            })) || []\r\n        };\r\n\r\n        let realMarketLine = firebaseMarketLine;\r\n        if (!realMarketLine) {\r\n            try {\r\n                realMarketLine = await oddsSyncService.syncEventOdds(gameId, sport);\r\n            } catch (err) { console.error(\"Sync error:\", err); }\r\n        }\r\n\r\n        const isLive = matchContext.status && !matchContext.status.includes('Not') && matchContext.status !== '0\\'';\r\n        let prompt = \"\";\r\n\r\n        if (sport === 'basketball') {\r\n            const mainOverUnder = realMarketLine?.line || 224.5;\r\n            prompt = `Analista NBA/Baloncesto. Contexto: ${matchContext.home} vs ${matchContext.away}. L√≠nea O/U: ${mainOverUnder}. Responde en JSON con predictions, reasoning y mostViablePick.`;\r\n        } else if (sport === 'football') {\r\n            const mainOverUnder = realMarketLine?.line || 2.5;\r\n            prompt = `Experto F√∫tbol. Contexto: ${matchContext.home} vs ${matchContext.away}. L√≠nea O/U: ${mainOverUnder}. Responde en JSON con predictions, reasoning y mostViablePick.`;\r\n        } else {\r\n            prompt = `Experto Deportes. Analiza ${matchContext.home} vs ${matchContext.away} de ${sport}. Responde en JSON.`;\r\n        }\r\n\r\n        const prediction = await groqService.createPrediction({\r\n            messages: [\r\n                { role: \"system\", content: \"Responde siempre en JSON v√°lido y en ESPA√ëOL.\" },\r\n                { role: \"user\", content: prompt }\r\n            ],\r\n            model: \"llama-3.1-8b-instant\",\r\n            temperature: 0.7,\r\n            response_format: { type: \"json_object\" }\r\n        });\r\n\r\n        const finalResponse = {\r\n            ...prediction,\r\n            generatedAt: new Date().toISOString(),\r\n            isVerified: !!realMarketLine?.isVerified,\r\n            dataSource: realMarketLine?.marketSource || (firebaseEvent ? 'Firebase DB' : 'Real-Time Bridge'),\r\n            marketMatched: realMarketLine ? 'Confirmado con Betplay' : 'Referencia Betplay'\r\n        };\r\n\r\n        await globalCache.set(cacheKey, finalResponse, isLive ? 120000 : 600000);\r\n\r\n        if (!isLive) {\r\n            archivePredictionOnServer(uid || 'guest', {\r\n                gameId,\r\n                sport,\r\n                winner: prediction.winner,\r\n                bettingTip: prediction.bettingTip || prediction.mostViablePick?.pick || 'Veredicto IA',\r\n                confidence: prediction.confidence,\r\n                reasoning: prediction.reasoning\r\n            }).catch(e => console.error(\"Archive error:\", e));\r\n        }\r\n\r\n        if (!isPremiumUser) {\r\n            return NextResponse.json({ ...finalResponse, bettingTip: 'üîí Premium Only', isMasked: true });\r\n        }\r\n\r\n        return NextResponse.json(finalResponse);\r\n\r\n    } catch (error: any) {\r\n        console.error(`‚ùå Error en predicci√≥n:`, error);\r\n        return NextResponse.json({\r\n            error: true,\r\n            message: \"Error generando predicci√≥n\",\r\n            winner: fallbackHomeName,\r\n            confidence: 50,\r\n            reasoning: \"El Or√°culo est√° en mantenimiento t√©cnico. Por favor intenta de nuevo.\",\r\n            predictions: { overUnder: { line: 2.5, pick: \"M√°s de\" } }\r\n        });\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}