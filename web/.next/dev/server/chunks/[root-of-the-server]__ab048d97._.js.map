{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Daniel/PickGenius/web/lib/firebaseAdmin.ts"],"sourcesContent":["import * as admin from 'firebase-admin';\r\nimport { readFileSync, existsSync } from 'fs';\r\nimport { join } from 'path';\r\n\r\n// Singleton para evitar m√∫ltiples inicializaciones\r\nlet firebaseApp: admin.app.App | null = null;\r\n\r\nexport function initializeFirebaseAdmin(): admin.app.App {\r\n    // Si ya hay apps inicializadas, intentar recuperar la [DEFAULT]\r\n    if (admin.apps.length > 0) {\r\n        console.log('‚úÖ Re-usando instancia de Firebase Admin existente');\r\n        firebaseApp = admin.apps[0]!;\r\n        return firebaseApp;\r\n    }\r\n\r\n    try {\r\n        console.log('üîß Intentando inicializar Firebase Admin...');\r\n\r\n        // M√âTODO 1: Intentar cargar desde archivo JSON (M√ÅS CONFIABLE)\r\n        const possiblePaths = [\r\n            // When started from PickGenius root\r\n            join(process.cwd(), 'firebase-service-account.json'),\r\n            join(process.cwd(), 'firebase-seervice-account.json'), // Soporte para el typo detectado\r\n            join(process.cwd(), 'firebase-credentials.json'),\r\n            // When started from web directory\r\n            join(process.cwd(), '..', 'firebase-service-account.json'),\r\n            join(process.cwd(), '..', 'firebase-seervice-account.json'),\r\n            join(process.cwd(), '..', 'firebase-credentials.json'),\r\n            // Absolute Windows paths\r\n            'C:\\\\Users\\\\Daniel\\\\PickGenius\\\\firebase-service-account.json',\r\n            'C:\\\\Users\\\\Daniel\\\\PickGenius\\\\firebase-seervice-account.json'\r\n        ];\r\n\r\n        for (const serviceAccountPath of possiblePaths) {\r\n            if (existsSync(serviceAccountPath)) {\r\n                try {\r\n                    const serviceAccount = JSON.parse(readFileSync(serviceAccountPath, 'utf8'));\r\n\r\n                    firebaseApp = admin.initializeApp({\r\n                        credential: admin.credential.cert(serviceAccount),\r\n                        projectId: serviceAccount.project_id,\r\n                        databaseURL: process.env.FIREBASE_DATABASE_URL || `https://${serviceAccount.project_id}.firebaseio.com`\r\n                    });\r\n\r\n                    console.log(`‚úÖ Firebase Admin inicializado desde archivo: ${serviceAccountPath}`);\r\n                    console.log('  Project ID:', firebaseApp.options.projectId);\r\n                    return firebaseApp;\r\n                } catch (e: any) {\r\n                    console.warn(`‚ö†Ô∏è Error leyendo ${serviceAccountPath}:`, e.message);\r\n                }\r\n            }\r\n        }\r\n\r\n        // M√âTODO 2: Usar FIREBASE_SERVICE_ACCOUNT (JSON completo en variable)\r\n        if (process.env.FIREBASE_SERVICE_ACCOUNT) {\r\n            try {\r\n                const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);\r\n\r\n                firebaseApp = admin.initializeApp({\r\n                    credential: admin.credential.cert(serviceAccount),\r\n                    projectId: serviceAccount.project_id,\r\n                    databaseURL: process.env.FIREBASE_DATABASE_URL || `https://${serviceAccount.project_id}.firebaseio.com`\r\n                });\r\n\r\n                console.log('‚úÖ Firebase Admin inicializado desde FIREBASE_SERVICE_ACCOUNT');\r\n                console.log('  Project ID:', firebaseApp.options.projectId);\r\n                return firebaseApp;\r\n            } catch (jsonError) {\r\n                console.warn('‚ö†Ô∏è Error parseando FIREBASE_SERVICE_ACCOUNT');\r\n            }\r\n        }\r\n\r\n        // M√âTODO 3: Usar variables individuales (√öLTIMO RECURSO)\r\n        const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || process.env.FIREBASE_PROJECT_ID;\r\n        const clientEmail = process.env.FIREBASE_CLIENT_EMAIL;\r\n        const privateKeyBase64 = process.env.FIREBASE_SERVICE_ACCOUNT_BASE64;\r\n\r\n        if (!projectId || !clientEmail) {\r\n            throw new Error('Faltan credenciales de Firebase (projectId o clientEmail)');\r\n        }\r\n\r\n        // Intentar con Base64\r\n        if (privateKeyBase64) {\r\n            try {\r\n                const privateKey = Buffer.from(privateKeyBase64, 'base64').toString('utf8');\r\n\r\n                firebaseApp = admin.initializeApp({\r\n                    credential: admin.credential.cert({\r\n                        projectId: projectId,\r\n                        clientEmail: clientEmail,\r\n                        privateKey: privateKey\r\n                    }),\r\n                    projectId: projectId,\r\n                    databaseURL: process.env.FIREBASE_DATABASE_URL || `https://${projectId}.firebaseio.com`\r\n                });\r\n\r\n                console.log('‚úÖ Firebase Admin inicializado desde Base64');\r\n                console.log('  Project ID:', firebaseApp.options.projectId);\r\n                return firebaseApp;\r\n            } catch (base64Error) {\r\n                console.warn('‚ö†Ô∏è Error usando Base64');\r\n            }\r\n        }\r\n\r\n        throw new Error('No se pudo inicializar Firebase con ning√∫n m√©todo disponible');\r\n\r\n    } catch (error: any) {\r\n        console.error('‚ùå Error cr√≠tico al inicializar Firebase Admin:');\r\n        console.error('Error Details:', error);\r\n\r\n        // No throw here, return null to let the system handle \"No connection\" gracefully if possible\r\n        // but since many services depend on it, we might still want to throw if it's a CRON task.\r\n        const errorMsg = error instanceof Error ? error.message : String(error);\r\n        throw new Error(`Failed to initialize Firebase Admin: ${errorMsg}`);\r\n    }\r\n}\r\n\r\nlet firestoreDb: admin.firestore.Firestore | null = null;\r\n\r\n// Obtener instancia de Firestore\r\nexport function getFirestore(): admin.firestore.Firestore {\r\n    if (firestoreDb) return firestoreDb;\r\n\r\n    const app = initializeFirebaseAdmin();\r\n    firestoreDb = app.firestore();\r\n\r\n    // Enforce ignoring undefined properties globally (ONLY ONCE)\r\n    try {\r\n        firestoreDb.settings({ ignoreUndefinedProperties: true });\r\n    } catch (e) {\r\n        console.warn('‚ö†Ô∏è Firestore settings already applied or could not be set');\r\n    }\r\n\r\n    return firestoreDb;\r\n}\r\n\r\n// Verificar conexi√≥n a Firebase\r\nexport async function verifyFirebaseConnection(): Promise<boolean> {\r\n    try {\r\n        const db = getFirestore();\r\n\r\n        await db.collection('_health_check').doc('test').set({\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n            status: 'ok'\r\n        });\r\n\r\n        console.log('‚úÖ Conexi√≥n a Firebase Firestore verificada correctamente');\r\n        return true;\r\n    } catch (error) {\r\n        console.error('‚ùå Error verificando conexi√≥n a Firebase:', error);\r\n        return false;\r\n    }\r\n}\r\n\r\n// Health check\r\nexport async function getFirebaseHealth(): Promise<{\r\n    connected: boolean;\r\n    projectId: string | null;\r\n    error?: string;\r\n}> {\r\n    try {\r\n        if (!firebaseApp) {\r\n            firebaseApp = initializeFirebaseAdmin();\r\n        }\r\n\r\n        const db = getFirestore();\r\n\r\n        await db.collection('_health_check').doc('status').set({\r\n            timestamp: admin.firestore.FieldValue.serverTimestamp(),\r\n            status: 'healthy'\r\n        });\r\n\r\n        return {\r\n            connected: true,\r\n            projectId: firebaseApp.options.projectId || null\r\n        };\r\n    } catch (error) {\r\n        return {\r\n            connected: false,\r\n            projectId: process.env.FIREBASE_PROJECT_ID || process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID || null,\r\n            error: error instanceof Error ? error.message : 'Unknown error'\r\n        };\r\n    }\r\n}\r\n\r\nexport default {\r\n    initializeFirebaseAdmin,\r\n    getFirestore,\r\n    verifyFirebaseConnection,\r\n    getFirebaseHealth\r\n};\r\n"],"names":[],"mappings":"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"}}]
}